# Docker Compose configuration for development/CI testing
# Provides Anvil (EVM), rippled (XRP), and TigerBeetle services
#
# Usage:
#   Start: docker compose -f docker-compose-dev.yml up -d
#   Stop:  docker compose -f docker-compose-dev.yml down -v
#
# Used by: .github/workflows/integration-tests.yml

version: '3.8'

services:
  # Anvil - Local Ethereum development node (Foundry)
  # Provides a fast EVM environment for testing smart contracts
  anvil:
    image: ghcr.io/foundry-rs/foundry:latest
    container_name: anvil
    entrypoint: ["anvil"]
    command:
      - --host=0.0.0.0
      - --port=8545
      - --chain-id=31337
      - --accounts=10
      - --balance=10000
      - --block-time=1
    ports:
      - "8545:8545"
    networks:
      - dev-network
    healthcheck:
      test: ["CMD-SHELL", "cast block-number --rpc-url http://localhost:8545 || exit 1"]
      interval: 5s
      timeout: 5s
      retries: 30
      start_period: 5s

  # rippled - XRP Ledger standalone mode
  # Runs in standalone mode for local testing without network connectivity
  rippled:
    image: rippleci/rippled:develop
    container_name: rippled
    command: ["-a", "--start", "--conf", "/etc/opt/ripple/rippled.cfg"]
    volumes:
      - ./config/rippled-standalone.cfg:/etc/opt/ripple/rippled.cfg:ro
    ports:
      - "5005:5005"   # JSON-RPC HTTP
      - "6006:6006"   # WebSocket
      - "51235:51235" # Peer protocol
    networks:
      - dev-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf -X POST http://localhost:5005 -H 'Content-Type: application/json' -d '{\"method\":\"server_info\",\"params\":[]}' || exit 1"]
      interval: 10s
      timeout: 10s
      retries: 30
      start_period: 30s

  # TigerBeetle - High-performance accounting database
  # Used for tracking settlement balances between ILP connector peers
  tigerbeetle:
    image: ghcr.io/tigerbeetle/tigerbeetle:0.16.68
    container_name: tigerbeetle
    security_opt:
      - seccomp=unconfined
    cap_add:
      - IPC_LOCK
    ulimits:
      memlock:
        soft: -1
        hard: -1
    volumes:
      - tigerbeetle-dev-data:/data
      - ./scripts/init-tigerbeetle.sh:/init-tigerbeetle.sh:ro
    networks:
      - dev-network
    entrypoint: ["/init-tigerbeetle.sh"]
    environment:
      TIGERBEETLE_CLUSTER_ID: "0"
      TIGERBEETLE_REPLICA_COUNT: "1"
      TIGERBEETLE_DATA_DIR: /data
    mem_limit: 4g
    cpus: '1.0'
    # TigerBeetle has no HTTP endpoint, healthcheck disabled
    # The init script handles initialization and startup

networks:
  dev-network:
    driver: bridge

volumes:
  tigerbeetle-dev-data:
    driver: local
