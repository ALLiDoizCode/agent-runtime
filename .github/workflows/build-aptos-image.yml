# Build and publish multi-architecture Aptos Docker image
#
# Required secrets:
#   DOCKERHUB_USERNAME - Docker Hub username (for pushing to Docker Hub)
#   DOCKERHUB_TOKEN    - Docker Hub access token with write access
#
# Alternative: Use GHCR (GitHub Container Registry) which uses GITHUB_TOKEN
#
# This workflow builds Aptos from source for both ARM64 and AMD64 architectures,
# enabling native execution on Apple Silicon Macs without slow QEMU emulation.

name: Build Aptos Multi-Arch Docker Image

on:
  workflow_dispatch:
    inputs:
      aptos_version:
        description: 'Aptos version tag (e.g., aptos-node-v1.40.1)'
        required: false
        default: 'aptos-node-v1.40.1'
  schedule:
    # Weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  push:
    branches:
      - main
    paths:
      - 'docker/aptos/**'
      - '.github/workflows/build-aptos-image.yml'

permissions:
  contents: read
  packages: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-and-push:
    name: Build and Push Multi-Arch Image
    runs-on: ubuntu-latest
    timeout-minutes: 120  # ARM64 build via QEMU can take 60+ minutes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            m2mproject/aptos-tools
            ghcr.io/${{ github.repository_owner }}/aptos-tools
          tags: |
            type=raw,value=latest
            type=raw,value=${{ github.event.inputs.aptos_version || 'aptos-node-v1.40.1' }}
            type=sha,prefix=

      - name: Build and push multi-arch image
        uses: docker/build-push-action@v5
        with:
          context: docker/aptos
          file: docker/aptos/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            APTOS_VERSION=${{ github.event.inputs.aptos_version || 'aptos-node-v1.40.1' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Verify multi-arch manifest
        run: |
          echo "Inspecting manifest for m2mproject/aptos-tools:latest..."
          docker manifest inspect m2mproject/aptos-tools:latest

          # Verify both architectures are present
          PLATFORMS=$(docker manifest inspect m2mproject/aptos-tools:latest | jq -r '.manifests[].platform | "\(.os)/\(.architecture)"' | sort)
          echo "Platforms found: $PLATFORMS"

          if echo "$PLATFORMS" | grep -q "linux/amd64" && echo "$PLATFORMS" | grep -q "linux/arm64"; then
            echo "✓ Multi-arch manifest verified: amd64 and arm64 present"
          else
            echo "✗ Missing architectures in manifest"
            exit 1
          fi

      - name: Verify AMD64 image
        run: |
          echo "Testing AMD64 image..."
          docker pull --platform linux/amd64 m2mproject/aptos-tools:latest

          # Check image size
          SIZE=$(docker image inspect m2mproject/aptos-tools:latest --format='{{.Size}}')
          SIZE_MB=$((SIZE / 1024 / 1024))
          echo "Image size: ${SIZE_MB}MB"
          if [ "$SIZE_MB" -gt 500 ]; then
            echo "⚠️ Warning: Image size exceeds 500MB target"
          else
            echo "✓ Image size within target"
          fi

          # Verify aptos CLI
          docker run --rm --platform linux/amd64 m2mproject/aptos-tools:latest --version
          echo "✓ AMD64 aptos CLI verified"

      - name: Smoke test local testnet (AMD64)
        timeout-minutes: 5
        run: |
          echo "Starting local testnet smoke test..."

          # Start testnet in background
          docker run -d --name aptos-testnet \
            --platform linux/amd64 \
            -p 8080:8080 \
            -p 8081:8081 \
            m2mproject/aptos-tools:latest \
            node run-local-testnet --force-restart --assume-yes

          # Wait for node to be ready (check REST API)
          echo "Waiting for testnet to start..."
          for i in {1..30}; do
            if curl -sf http://localhost:8080/v1 > /dev/null 2>&1; then
              echo "✓ Testnet REST API responding"
              break
            fi
            echo "Waiting... ($i/30)"
            sleep 2
          done

          # Verify REST API
          curl -sf http://localhost:8080/v1 | jq .

          # Cleanup
          docker stop aptos-testnet
          docker rm aptos-testnet

          echo "✓ Local testnet smoke test passed"

      - name: Summary
        run: |
          echo "=========================================="
          echo "Build Summary"
          echo "=========================================="
          echo ""
          echo "Image: m2mproject/aptos-tools"
          echo "Tags: ${{ steps.meta.outputs.tags }}"
          echo "Platforms: linux/amd64, linux/arm64"
          echo "Aptos Version: ${{ github.event.inputs.aptos_version || 'aptos-node-v1.40.1' }}"
          echo ""
          echo "Pull command:"
          echo "  docker pull m2mproject/aptos-tools:latest"
          echo ""
          echo "Run local testnet:"
          echo "  docker run --rm -it -p 8080:8080 m2mproject/aptos-tools:latest node run-local-testnet --force-restart --assume-yes"
