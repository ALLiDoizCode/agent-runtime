# Docker Compose configuration for Agent Society Integration Test
#
# This test connects to public testnets:
#   - Aptos Testnet (https://fullnode.testnet.aptoslabs.com)
#   - XRP Testnet (wss://s.altnet.rippletest.net)
#   - Base Sepolia (https://sepolia.base.org) - optional
#
# Usage:
#   ./scripts/run-docker-agent-test.sh
#
#   # View logs
#   docker compose -f docker-compose-agent-test.yml logs -f
#
#   # Stop and cleanup
#   docker compose -f docker-compose-agent-test.yml down -v
#
# Explorer UI Ports:
#   agent-0: http://localhost:9100
#   agent-1: http://localhost:9101
#   agent-2: http://localhost:9102
#   agent-3: http://localhost:9103
#   agent-4: http://localhost:9104

services:
  # Agent 0 (Hub) - Central node in hub-and-spoke topology
  agent-0:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.agent
    container_name: agent_peer_0
    environment:
      AGENT_ID: peer-0
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: testnet
      # EVM configuration (Base Sepolia)
      EVM_ENABLED: ${EVM_ENABLED:-false}
      ANVIL_RPC_URL: ${ANVIL_RPC_URL:-https://sepolia.base.org}
      BASE_REGISTRY_ADDRESS: ${BASE_REGISTRY_ADDRESS:-}
      BASE_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-}
      BASE_TOKEN_NETWORK_ADDRESS: ${BASE_TOKEN_NETWORK_ADDRESS:-}
      # XRP configuration (XRP Testnet)
      XRP_ENABLED: ${XRP_ENABLED:-true}
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRPL_RPC_URL: ${XRPL_RPC_URL:-https://s.altnet.rippletest.net:51234}
      XRPL_NETWORK: testnet
      # Aptos configuration (Aptos Testnet)
      APTOS_ENABLED: ${APTOS_ENABLED:-true}
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_FAUCET_URL: ${APTOS_FAUCET_URL:-https://faucet.testnet.aptoslabs.com}
    ports:
      - "8100:8080"  # HTTP API
      - "3100:3000"  # BTP WebSocket
      - "9100:9000"  # Explorer UI
    networks:
      - agent_test_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Agent 1
  agent-1:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.agent
    container_name: agent_peer_1
    environment:
      AGENT_ID: peer-1
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: testnet
      # EVM configuration (Base Sepolia)
      EVM_ENABLED: ${EVM_ENABLED:-false}
      ANVIL_RPC_URL: ${ANVIL_RPC_URL:-https://sepolia.base.org}
      BASE_REGISTRY_ADDRESS: ${BASE_REGISTRY_ADDRESS:-}
      BASE_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-}
      BASE_TOKEN_NETWORK_ADDRESS: ${BASE_TOKEN_NETWORK_ADDRESS:-}
      # XRP configuration (XRP Testnet)
      XRP_ENABLED: ${XRP_ENABLED:-true}
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRPL_RPC_URL: ${XRPL_RPC_URL:-https://s.altnet.rippletest.net:51234}
      XRPL_NETWORK: testnet
      # Aptos configuration (Aptos Testnet)
      APTOS_ENABLED: ${APTOS_ENABLED:-true}
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_FAUCET_URL: ${APTOS_FAUCET_URL:-https://faucet.testnet.aptoslabs.com}
    ports:
      - "8101:8080"
      - "3101:3000"
      - "9101:9000"
    networks:
      - agent_test_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Agent 2
  agent-2:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.agent
    container_name: agent_peer_2
    environment:
      AGENT_ID: peer-2
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: testnet
      # EVM configuration (Base Sepolia)
      EVM_ENABLED: ${EVM_ENABLED:-false}
      ANVIL_RPC_URL: ${ANVIL_RPC_URL:-https://sepolia.base.org}
      BASE_REGISTRY_ADDRESS: ${BASE_REGISTRY_ADDRESS:-}
      BASE_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-}
      BASE_TOKEN_NETWORK_ADDRESS: ${BASE_TOKEN_NETWORK_ADDRESS:-}
      # XRP configuration (XRP Testnet)
      XRP_ENABLED: ${XRP_ENABLED:-true}
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRPL_RPC_URL: ${XRPL_RPC_URL:-https://s.altnet.rippletest.net:51234}
      XRPL_NETWORK: testnet
      # Aptos configuration (Aptos Testnet)
      APTOS_ENABLED: ${APTOS_ENABLED:-true}
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_FAUCET_URL: ${APTOS_FAUCET_URL:-https://faucet.testnet.aptoslabs.com}
    ports:
      - "8102:8080"
      - "3102:3000"
      - "9102:9000"
    networks:
      - agent_test_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Agent 3
  agent-3:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.agent
    container_name: agent_peer_3
    environment:
      AGENT_ID: peer-3
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: testnet
      # EVM configuration (Base Sepolia)
      EVM_ENABLED: ${EVM_ENABLED:-false}
      ANVIL_RPC_URL: ${ANVIL_RPC_URL:-https://sepolia.base.org}
      BASE_REGISTRY_ADDRESS: ${BASE_REGISTRY_ADDRESS:-}
      BASE_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-}
      BASE_TOKEN_NETWORK_ADDRESS: ${BASE_TOKEN_NETWORK_ADDRESS:-}
      # XRP configuration (XRP Testnet)
      XRP_ENABLED: ${XRP_ENABLED:-true}
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRPL_RPC_URL: ${XRPL_RPC_URL:-https://s.altnet.rippletest.net:51234}
      XRPL_NETWORK: testnet
      # Aptos configuration (Aptos Testnet)
      APTOS_ENABLED: ${APTOS_ENABLED:-true}
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_FAUCET_URL: ${APTOS_FAUCET_URL:-https://faucet.testnet.aptoslabs.com}
    ports:
      - "8103:8080"
      - "3103:3000"
      - "9103:9000"
    networks:
      - agent_test_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

  # Agent 4
  agent-4:
    build:
      context: .
      dockerfile: packages/connector/Dockerfile.agent
    container_name: agent_peer_4
    environment:
      AGENT_ID: peer-4
      AGENT_HTTP_PORT: 8080
      AGENT_BTP_PORT: 3000
      AGENT_EXPLORER_PORT: 9000
      AGENT_DATABASE_PATH: ":memory:"
      AGENT_EXPLORER_DB_PATH: ":memory:"
      LOG_LEVEL: ${LOG_LEVEL:-info}
      NETWORK_MODE: testnet
      # EVM configuration (Base Sepolia)
      EVM_ENABLED: ${EVM_ENABLED:-false}
      ANVIL_RPC_URL: ${ANVIL_RPC_URL:-https://sepolia.base.org}
      BASE_REGISTRY_ADDRESS: ${BASE_REGISTRY_ADDRESS:-}
      BASE_TOKEN_ADDRESS: ${BASE_TOKEN_ADDRESS:-}
      BASE_TOKEN_NETWORK_ADDRESS: ${BASE_TOKEN_NETWORK_ADDRESS:-}
      # XRP configuration (XRP Testnet)
      XRP_ENABLED: ${XRP_ENABLED:-true}
      XRPL_WSS_URL: ${XRPL_WSS_URL:-wss://s.altnet.rippletest.net:51233}
      XRPL_RPC_URL: ${XRPL_RPC_URL:-https://s.altnet.rippletest.net:51234}
      XRPL_NETWORK: testnet
      # Aptos configuration (Aptos Testnet)
      APTOS_ENABLED: ${APTOS_ENABLED:-true}
      APTOS_NODE_URL: ${APTOS_NODE_URL:-https://fullnode.testnet.aptoslabs.com/v1}
      APTOS_FAUCET_URL: ${APTOS_FAUCET_URL:-https://faucet.testnet.aptoslabs.com}
    ports:
      - "8104:8080"
      - "3104:3000"
      - "9104:9000"
    networks:
      - agent_test_network
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 15s
    restart: unless-stopped

networks:
  agent_test_network:
    driver: bridge
