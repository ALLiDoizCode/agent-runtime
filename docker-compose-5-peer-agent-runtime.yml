# Docker Compose configuration for Agent Runtime with 5-peer network
# Extends the 5-peer multi-hop network with Agent Runtime support
#
# This adds:
# - Agent Runtime: SPSP/STREAM protocol handler
# - Business Logic: Custom payment decision handler
# - Configures peer5 to forward local delivery to agent runtime

version: '3.8'

services:
  # Agent Runtime - Handles SPSP/STREAM protocols for g.peer5.agent.* addresses
  agent-runtime:
    image: agent-runtime
    container_name: agent-runtime
    environment:
      PORT: "3100"
      # ILP address prefix - packets to g.peer5.agent.* are handled here
      BASE_ADDRESS: g.peer5.agent
      # Business logic container URL
      BUSINESS_LOGIC_URL: http://business-logic:8080
      BUSINESS_LOGIC_TIMEOUT: "5000"
      # Enable SPSP endpoint for payment setup
      SPSP_ENABLED: "true"
      # Session TTL (1 hour)
      SESSION_TTL_MS: "3600000"
      LOG_LEVEL: info
      NODE_ID: agent-runtime
    ports:
      - "3100:3100"   # Agent runtime HTTP port (SPSP + packet handling)
    networks:
      - agent-network
    depends_on:
      business-logic:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Business Logic - User's custom payment handler
  business-logic:
    image: node:22-alpine
    container_name: business-logic
    working_dir: /app
    environment:
      PORT: "8080"
    volumes:
      - /Users/jonathangreen/Documents/m2m/examples/business-logic-example:/app:ro
    command: ["node", "server.js"]
    ports:
      - "8081:8080"   # Business logic HTTP port
    networks:
      - agent-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s

networks:
  agent-network:
    external: true
    name: m2m_agent-network
