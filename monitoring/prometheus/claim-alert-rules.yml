# Prometheus Alert Rules for Claim Exchange Monitoring (Story 17.6)
#
# These rules monitor the health of the BTP claim exchange protocol
# and alert on high failure rates or stalled redemptions.
#
# Usage: Load these rules into Prometheus via prometheus.yml configuration:
#   rule_files:
#     - "claim-alert-rules.yml"

groups:
  - name: claim_exchange_alerts
    interval: 30s
    rules:
      # Alert when >10% of claim sends are failing over 5 minutes
      - alert: HighClaimSendFailureRate
        expr: |
          rate(claims_sent_total{success="false"}[5m])
          / rate(claims_sent_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: claim-exchange
          layer: btp
        annotations:
          summary: 'High claim send failure rate ({{ $value | humanizePercentage }})'
          description: >
            More than 10% of claim sends are failing for peer {{ $labels.peer_id }}
            on {{ $labels.blockchain }} blockchain for 5 minutes.
            This may indicate BTP connection issues or peer configuration problems.
          runbook_url: 'https://docs.example.com/runbooks/claim-send-failures'

      # Alert when >5% of received claims are failing verification over 5 minutes
      - alert: HighClaimVerificationFailureRate
        expr: |
          rate(claim_verification_failures_total[5m])
          / rate(claims_received_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: claim-exchange
          layer: verification
        annotations:
          summary: 'High claim verification failure rate ({{ $value | humanizePercentage }})'
          description: >
            More than 5% of received claims are failing verification for peer {{ $labels.peer_id }}
            on {{ $labels.blockchain }} blockchain.
            Common causes: invalid signatures, non-monotonic nonces, or misconfigured signers.
            Check error_type label for specific failure mode.
          runbook_url: 'https://docs.example.com/runbooks/claim-verification-failures'

      # Critical alert when no claims have been redeemed despite verified claims pending
      - alert: ClaimRedemptionStalled
        expr: |
          (time() - claim_last_redemption_timestamp_seconds) > 600
          and rate(claims_received_total{verified="true"}[10m]) > 0
        for: 5m
        labels:
          severity: critical
          component: claim-exchange
          layer: redemption
        annotations:
          summary: 'Claim redemption service appears stalled for {{ $labels.blockchain }}'
          description: >
            No claims have been redeemed for {{ $labels.blockchain }} blockchain in 10 minutes
            despite verified claims being received.
            This indicates the ClaimRedemptionService may be stalled, RPC connection issues,
            or gas price estimation failures.
            Immediate investigation required.
          runbook_url: 'https://docs.example.com/runbooks/claim-redemption-stalled'

      # Alert when on-chain claim redemptions are failing
      - alert: ClaimRedemptionFailures
        expr: rate(claims_redeemed_total{success="false"}[5m]) > 0
        for: 2m
        labels:
          severity: warning
          component: claim-exchange
          layer: blockchain
        annotations:
          summary: 'Claim redemptions are failing on {{ $labels.blockchain }}'
          description: >
            On-chain claim redemptions are failing for {{ $labels.blockchain }} blockchain.
            Common causes:
            - Insufficient gas for redemption transactions
            - RPC node unavailability or rate limiting
            - Invalid claim signatures on-chain
            - Network congestion causing transaction timeouts
            Check ClaimRedemptionService logs and blockchain node health.
          runbook_url: 'https://docs.example.com/runbooks/claim-redemption-failures'

      # Warning when claim verification errors spike for a specific error type
      - alert: ClaimVerificationErrorSpike
        expr: |
          increase(claim_verification_failures_total{error_type!=""}[10m]) > 10
        labels:
          severity: warning
          component: claim-exchange
          layer: verification
        annotations:
          summary: 'Spike in {{ $labels.error_type }} verification failures'
          description: >
            More than 10 {{ $labels.error_type }} verification failures detected
            in the last 10 minutes for peer {{ $labels.peer_id }} on {{ $labels.blockchain }}.
            This may indicate a configuration issue or attack attempt.
          runbook_url: 'https://docs.example.com/runbooks/claim-verification-error-spike'

      # Info alert for low claim throughput (may indicate idle period or issue)
      - alert: LowClaimThroughput
        expr: |
          rate(claims_sent_total[30m]) < 0.01
          and rate(claims_sent_total[30m] offset 30m) > 0.1
        for: 30m
        labels:
          severity: info
          component: claim-exchange
          layer: monitoring
        annotations:
          summary: 'Low claim exchange throughput'
          description: >
            Claim send rate has dropped significantly over the last 30 minutes.
            This may be expected (idle period) or indicate a problem with settlement triggers.
            Current rate: {{ $value | humanize }} claims/sec
          runbook_url: 'https://docs.example.com/runbooks/low-claim-throughput'
