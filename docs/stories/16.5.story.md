<!-- Powered by BMAD™ Core -->

# Story 16.5: Token Budget & Cost Management

## Status

Done

## Story

**As a** connector operator,
**I want** a rolling-window token budget tracker that enforces cost limits on AI usage, emits telemetry at warning thresholds, and supports automatic fallback when budget is exhausted,
**So that** AI token costs are controlled and predictable, operators receive proactive warnings before budget exhaustion, and the system gracefully degrades to direct handler dispatch when limits are reached.

## Acceptance Criteria

1. A `TokenBudget` class implements rolling-window token budget tracking with configurable `maxTokensPerWindow` and `windowMs` (default: 1 hour)
2. `canSpend(estimatedTokens?: number)` returns `true` if the remaining budget can accommodate the estimated tokens (defaults to 0 if not provided), `false` otherwise
3. `recordUsage(usage: { promptTokens, completionTokens, totalTokens })` records token consumption with automatic timestamp, updates the rolling window, and emits telemetry events
4. `getStatus()` returns `TokenBudgetStatus` with: `tokensUsedInWindow`, `maxTokensPerWindow`, `remainingTokens`, `usagePercent`, `isExhausted`, `requestCount`, `windowMs`
5. `getRemainingBudget()` returns the number of tokens remaining in the current window (never negative)
6. `reset()` clears all usage records and resets warning flags
7. The rolling window automatically expires old records — usage records older than `windowMs` are pruned on each budget check
8. Telemetry callback (`onTelemetry`) can be set to receive `TokenBudgetTelemetryEvent` events: `AI_TOKEN_USAGE`, `AI_BUDGET_WARNING`, `AI_BUDGET_EXHAUSTED`
9. Warning telemetry is emitted at 80% and 95% usage thresholds (each warning emitted only once per threshold crossing until usage drops below threshold)
10. `AI_BUDGET_EXHAUSTED` telemetry is emitted when budget reaches 0 remaining tokens
11. Telemetry emission is non-blocking — errors in the telemetry callback are caught and do not affect budget tracking
12. `TokenUsageRecord` interface defines: `timestamp`, `promptTokens`, `completionTokens`, `totalTokens`
13. `TokenBudgetStatus` interface defines all status fields with proper TypeScript types
14. `TokenBudgetTelemetryEvent` interface defines: `type`, `timestamp` (ISO string), `tokensUsed`, `tokensRemaining`, `usagePercent`, `windowMs`
15. All token budget code has unit tests with >80% coverage covering: `canSpend`, `recordUsage`, `getStatus`, `getRemainingBudget`, `reset`, rolling window expiration, all telemetry event types, warning threshold behavior, telemetry error handling
16. Types `TokenBudget`, `TokenUsageRecord`, `TokenBudgetStatus`, and `TokenBudgetTelemetryEvent` are exported from the AI module barrel file

## Tasks / Subtasks

- [x] Task 1: Validate pre-existing TokenBudget implementation (AC: 1-14)
  - [x] Read and evaluate `packages/connector/src/agent/ai/token-budget.ts` against all acceptance criteria
  - [x] Verify constructor accepts `{ maxTokensPerWindow, windowMs?, onTelemetry? }` with `windowMs` defaulting to 1 hour (3600000ms)
  - [x] Verify `canSpend(estimatedTokens?)` prunes expired records and checks remaining budget against estimate
  - [x] Verify `recordUsage({ promptTokens, completionTokens, totalTokens })` adds timestamp, pushes to records, prunes expired, emits telemetry
  - [x] Verify `getStatus()` returns all `TokenBudgetStatus` fields with correct calculations
  - [x] Verify `getRemainingBudget()` returns remaining tokens (never negative via `Math.max(0, ...)`)
  - [x] Verify `reset()` clears `_records` array and resets `_warningEmitted80` and `_warningEmitted95` flags
  - [x] Verify rolling window pruning removes records with `timestamp < Date.now() - windowMs`
  - [x] Verify telemetry events have correct types: `AI_TOKEN_USAGE`, `AI_BUDGET_WARNING`, `AI_BUDGET_EXHAUSTED`
  - [x] Verify warning thresholds at 80% and 95% emit only once per crossing (flags reset when usage drops below threshold)
  - [x] Verify telemetry callback is wrapped in try-catch for non-blocking emission
  - [x] Verify all interfaces (`TokenUsageRecord`, `TokenBudgetStatus`, `TokenBudgetTelemetryEvent`) have correct fields
  - [x] Make any necessary fixes or enhancements to meet ACs
  - [Source: docs/prd/epic-16-ai-agent-node.md#configuration, architecture/ai-agent-skills.md#token-budget]

- [x] Task 2: Verify barrel exports for TokenBudget (AC: 16)
  - [x] Verify `packages/connector/src/agent/ai/index.ts` exports `TokenBudget` class
  - [x] Verify `TokenUsageRecord` type is exported
  - [x] Verify `TokenBudgetStatus` type is exported
  - [x] Verify `TokenBudgetTelemetryEvent` type is exported (add if missing)
  - [x] Verify `packages/connector/src/agent/index.ts` re-exports relevant types
  - [Source: architecture/source-tree.md — ai/ section]

- [x] Task 3: Validate pre-existing unit tests (AC: 15)
  - [x] Read and evaluate `packages/connector/src/agent/ai/__tests__/token-budget.test.ts`
  - [x] Verify tests cover `canSpend()` with no args, with estimate within budget, with estimate exceeding budget, after exhaustion
  - [x] Verify tests cover `recordUsage()` single and multiple records accumulate correctly
  - [x] Verify tests cover `getStatus()` initial values and after usage (tokensUsed, remaining, percent, isExhausted, requestCount)
  - [x] Verify tests cover `getRemainingBudget()` initial, after usage, never goes negative
  - [x] Verify tests cover `reset()` clears records and request count
  - [x] Verify tests cover rolling window expiration (records expire after windowMs)
  - [x] Verify tests cover `AI_TOKEN_USAGE` telemetry emission on each recordUsage
  - [x] Verify tests cover `AI_BUDGET_WARNING` at 80% threshold
  - [x] Verify tests cover `AI_BUDGET_WARNING` at 95% threshold
  - [x] Verify tests cover `AI_BUDGET_EXHAUSTED` at 100% usage
  - [x] Verify tests cover telemetry callback error handling (does not throw)
  - [x] Add missing test cases if any AC is not covered:
    - [x] Test warning flags reset when usage drops below threshold after pruning
    - [x] Test `onTelemetry` setter works correctly
    - [x] Test default `windowMs` value (1 hour = 3600000ms)
    - [x] Test `TokenBudgetTelemetryEvent` includes all required fields
    - [x] Test status `windowMs` field is included in response
  - [x] Ensure all tests follow AAA pattern with descriptive test names
  - [Source: architecture/test-strategy-and-standards.md#unit-tests]

- [x] Task 4: Run tests and verify coverage (AC: 15)
  - [x] Run `npx jest token-budget.test.ts --coverage` from `packages/connector`
  - [x] Verify >80% line coverage for `token-budget.ts`
  - [x] Fix any failing tests
  - [Source: architecture/test-strategy-and-standards.md#unit-tests]

## Dev Notes

### Previous Story Insights (from Story 16.4)

- Story 16.4 completed the AI Agent Dispatcher which integrates the TokenBudget for cost management
- `AIAgentDispatcher` calls `tokenBudget.canSpend()` before AI dispatch and `tokenBudget.recordUsage()` after successful calls
- When `canSpend()` returns `false` and `fallbackOnExhaustion` is `true`, the dispatcher falls back to direct handler
- When `canSpend()` returns `false` and `fallbackOnExhaustion` is `false`, the dispatcher returns T03 error
- Story 16.1 defined `AIBudgetConfig` interface with `maxTokensPerHour` and `fallbackOnExhaustion` fields
- Pre-existing code on the `epic-16` branch includes `token-budget.ts` and `token-budget.test.ts` — the dev agent should evaluate this code against the ACs and validate, enhance, or rewrite as needed

[Source: docs/stories/16.4.story.md#dev-agent-record]

### Data Models

**TokenUsageRecord interface:**

```typescript
interface TokenUsageRecord {
  /** Timestamp of the usage */
  timestamp: number;
  /** Number of prompt tokens used */
  promptTokens: number;
  /** Number of completion tokens used */
  completionTokens: number;
  /** Total tokens used */
  totalTokens: number;
}
```

[Source: packages/connector/src/agent/ai/token-budget.ts:13-22]

**TokenBudgetStatus interface:**

```typescript
interface TokenBudgetStatus {
  /** Total tokens used in the current window */
  tokensUsedInWindow: number;
  /** Maximum tokens allowed per window */
  maxTokensPerWindow: number;
  /** Remaining tokens in the current window */
  remainingTokens: number;
  /** Usage as a percentage (0-100) */
  usagePercent: number;
  /** Whether the budget is exhausted */
  isExhausted: boolean;
  /** Number of requests in the current window */
  requestCount: number;
  /** Window size in milliseconds */
  windowMs: number;
}
```

[Source: packages/connector/src/agent/ai/token-budget.ts:27-42]

**TokenBudgetTelemetryEvent interface:**

```typescript
interface TokenBudgetTelemetryEvent {
  type: 'AI_TOKEN_USAGE' | 'AI_BUDGET_WARNING' | 'AI_BUDGET_EXHAUSTED';
  timestamp: string; // ISO format
  tokensUsed: number;
  tokensRemaining: number;
  usagePercent: number;
  windowMs: number;
}
```

[Source: packages/connector/src/agent/ai/token-budget.ts:47-54]

**AIBudgetConfig interface (from ai-agent-config.ts):**

```typescript
interface AIBudgetConfig {
  /** Maximum tokens per hour (maps to maxTokensPerWindow) */
  maxTokensPerHour: number;
  /** Whether to fall back to direct dispatch on exhaustion */
  fallbackOnExhaustion: boolean;
}
```

[Source: packages/connector/src/agent/ai/ai-agent-config.ts]

### API Specifications

**TokenBudget class:**

Constructor:

```typescript
constructor(config: {
  maxTokensPerWindow: number;
  windowMs?: number;  // Default: 3600000 (1 hour)
  onTelemetry?: (event: TokenBudgetTelemetryEvent) => void;
})
```

Methods:

- `canSpend(estimatedTokens?: number): boolean` — Check if budget allows spending
- `recordUsage(usage: Omit<TokenUsageRecord, 'timestamp'>): void` — Record token consumption
- `getStatus(): TokenBudgetStatus` — Get current budget status
- `getRemainingBudget(): number` — Get remaining tokens
- `reset(): void` — Clear all records

Properties:

- `set onTelemetry(callback)` — Set telemetry callback

Private methods:

- `_getTotalUsed(): number` — Sum all current records' totalTokens
- `_pruneExpiredRecords(): void` — Remove records older than windowMs
- `_emitTelemetry(event): void` — Emit telemetry with error handling

**Constants:**

- `DEFAULT_WINDOW_MS = 60 * 60 * 1000` — 1 hour default window

[Source: packages/connector/src/agent/ai/token-budget.ts]

### File Locations

| File                                                             | Purpose                                     |
| ---------------------------------------------------------------- | ------------------------------------------- |
| `packages/connector/src/agent/ai/token-budget.ts`                | Validate — TokenBudget class and interfaces |
| `packages/connector/src/agent/ai/index.ts`                       | Verify — TokenBudget and type exports       |
| `packages/connector/src/agent/index.ts`                          | Verify — re-exports from AI module          |
| `packages/connector/src/agent/ai/__tests__/token-budget.test.ts` | Validate/Enhance — unit tests               |

[Source: architecture/source-tree.md — ai/ section]

### Testing Requirements

- **Framework:** Jest 29.7.x with ts-jest
- **Location:** `packages/connector/src/agent/ai/__tests__/token-budget.test.ts`
- **Patterns:** AAA (Arrange, Act, Assert), descriptive test names
- **Coverage:** >80% line coverage for `token-budget.ts`
- **Test isolation:** Fresh `TokenBudget` instance in `beforeEach()`
- **Critical test scenarios:**
  - `canSpend()` with various budget states
  - `recordUsage()` accumulating correctly
  - `getStatus()` calculations (percent, exhausted, etc.)
  - `getRemainingBudget()` never negative
  - `reset()` clears all state
  - Rolling window expiration (use short windowMs like 50ms)
  - `AI_TOKEN_USAGE` event on every recordUsage
  - `AI_BUDGET_WARNING` at 80% and 95% thresholds
  - `AI_BUDGET_EXHAUSTED` at 100%
  - Warning flags reset when usage drops below threshold
  - Telemetry callback error handling (non-throwing)

[Source: architecture/test-strategy-and-standards.md#unit-tests]

### Technical Constraints

- **Rolling window:** Uses array-based storage with FIFO pruning. Records are pruned from the front when `timestamp < cutoff`.
- **Warning thresholds:** 80% and 95% warnings emit only once per threshold crossing. Flags reset when pruning drops usage below the threshold.
- **Percentage calculation:** `Math.min(100, Math.round((used / max) * 100))` ensures it never exceeds 100.
- **Exhaustion check:** `isExhausted = remainingTokens === 0` — checks for exact zero remaining.
- **Non-blocking telemetry:** `_emitTelemetry` wraps callback in try-catch to prevent budget tracking failures.
- **Timestamp source:** Uses `Date.now()` for timestamps (milliseconds since epoch).
- **ISO timestamp:** Telemetry events use `new Date().toISOString()` for human-readable timestamps.
- **No console.log:** Uses callback-based telemetry, no direct logging.
- **Import style:** Use `import type` for type-only imports.

[Source: architecture/coding-standards.md#critical-rules, docs/prd/epic-16-ai-agent-node.md#risk-mitigation]

### Existing Code Context

**Pre-existing `token-budget.ts` (228 lines):**

- `TokenUsageRecord` interface with timestamp, promptTokens, completionTokens, totalTokens
- `TokenBudgetStatus` interface with all status fields
- `TokenBudgetTelemetryEvent` interface with type union and event fields
- `TokenBudget` class with constructor accepting config object
- `canSpend(estimatedTokens?)` method pruning records and checking budget
- `recordUsage(usage)` method adding timestamp, recording, pruning, emitting telemetry
- `getStatus()` method calculating all status fields
- `getRemainingBudget()` method returning remaining tokens
- `reset()` method clearing records and warning flags
- `_pruneExpiredRecords()` private method for rolling window
- `_emitTelemetry()` private method with try-catch
- Warning flags: `_warningEmitted80`, `_warningEmitted95`
- Default window: `DEFAULT_WINDOW_MS = 60 * 60 * 1000` (1 hour)

**Pre-existing `token-budget.test.ts` (179 lines):**

- Tests for `canSpend` (5 tests)
- Tests for `recordUsage` (2 tests)
- Tests for `getStatus` (3 tests)
- Tests for `getRemainingBudget` (3 tests)
- Tests for `reset` (1 test)
- Tests for rolling window expiration (1 test with short windowMs)
- Tests for telemetry events (5 tests covering all event types)

The dev agent should evaluate this code against the ACs and enhance test coverage if needed.

[Source: packages/connector/src/agent/ai/token-budget.ts, packages/connector/src/agent/ai/__tests__/token-budget.test.ts]

### Pre-existing Code Warning

**There is uncommitted code on the `epic-16` branch that was written ahead of the formal story process.** The dev agent should evaluate this code against the story requirements:

- **Untracked:** `packages/connector/src/agent/ai/token-budget.ts` — TokenBudget class (228 lines)
- **Untracked:** `packages/connector/src/agent/ai/__tests__/token-budget.test.ts` — unit tests (179 lines)

The dev agent may use this code as a starting point if it meets the acceptance criteria, or rewrite as needed. All code must be validated against the ACs regardless of whether it pre-existed.

---

## Change Log

| Date       | Version | Description            | Author |
| ---------- | ------- | ---------------------- | ------ |
| 2026-01-28 | 0.1     | Initial story creation | SM     |

---

## Dev Agent Record (Agent Populates After Execution)

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

None required — validation-only story with no code changes.

### Completion Notes

- **Task 1**: Validated pre-existing `TokenBudget` implementation against all ACs 1-14. Implementation fully meets all acceptance criteria:
  - Constructor with configurable `maxTokensPerWindow` and optional `windowMs` (default 1 hour)
  - `canSpend()` prunes expired records and checks remaining budget
  - `recordUsage()` adds timestamp, records usage, prunes expired, emits telemetry
  - `getStatus()` returns all required fields with correct calculations
  - `getRemainingBudget()` never returns negative (uses `Math.max(0, ...)`)
  - `reset()` clears records and warning flags
  - Rolling window pruning works correctly
  - Telemetry events: `AI_TOKEN_USAGE`, `AI_BUDGET_WARNING`, `AI_BUDGET_EXHAUSTED`
  - Warning thresholds at 80%/95% with flags that reset when usage drops
  - Non-blocking telemetry with try-catch wrapper
  - All interfaces have correct fields

- **Task 2**: Verified barrel exports in `ai/index.ts` and `agent/index.ts`:
  - `TokenBudget` class exported
  - `TokenUsageRecord` type exported
  - `TokenBudgetStatus` type exported
  - `TokenBudgetTelemetryEvent` type exported

- **Task 3**: Validated pre-existing unit tests — comprehensive coverage of all required scenarios (28 tests total):
  - `canSpend()` tests (5 tests)
  - `recordUsage()` tests (2 tests)
  - `getStatus()` tests (3 tests)
  - `getRemainingBudget()` tests (3 tests)
  - `reset()` tests (2 tests)
  - Default configuration test (1 test)
  - Status `windowMs` field test (1 test)
  - Rolling window tests (2 tests)
  - Telemetry tests (9 tests)

- **Task 4**: Ran tests with coverage — **100% coverage** achieved:
  - Statements: 100%
  - Branches: 100%
  - Functions: 100%
  - Lines: 100%

- **Regression**: Full test suite passed (2563 tests). 2 pre-existing performance test failures in `wallet-derivation.test.ts` (XRP derivation timing benchmarks) are unrelated to this story.

### File List

| File                                                             | Status    | Purpose                              |
| ---------------------------------------------------------------- | --------- | ------------------------------------ |
| `packages/connector/src/agent/ai/token-budget.ts`                | Validated | TokenBudget class and interfaces     |
| `packages/connector/src/agent/ai/index.ts`                       | Validated | AI module barrel exports             |
| `packages/connector/src/agent/index.ts`                          | Validated | Agent module re-exports              |
| `packages/connector/src/agent/ai/__tests__/token-budget.test.ts` | Validated | Unit tests (28 tests, 100% coverage) |

---

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Risk Level: Low** — Self-contained utility class with no external dependencies, no network I/O, no auth/payment surface, and no persistent state. 229 lines of implementation code. While the story has >5 ACs (triggering deep review), the scope is narrow and well-bounded.

### Code Quality Assessment

Implementation is clean, well-structured, and idiomatic TypeScript. Specific observations:

- **Architecture**: Single-responsibility class with clear separation of concerns. Rolling-window pattern is correctly implemented using array-based FIFO storage with front-pruning.
- **API Design**: Constructor config pattern with sensible defaults, setter for telemetry callback, and `Omit<TokenUsageRecord, 'timestamp'>` for `recordUsage` parameter are good ergonomic choices.
- **Error Handling**: Telemetry emission is correctly wrapped in try-catch (line 222-227) making it non-blocking.
- **Defensive Programming**: `Math.max(0, ...)` prevents negative remaining budget (lines 170, 189). `Math.min(100, ...)` caps percentage at 100 (line 171). `estimatedTokens ?? 0` default in `canSpend` (line 97).
- **Warning Threshold Logic**: The `_pruneExpiredRecords` method correctly resets warning flags when usage drops below thresholds after pruning (lines 211-219), preventing stale flags from suppressing future warnings.
- **Minor Note**: The `_pruneExpiredRecords` uses `Array.shift()` in a while loop (line 208), which is O(n) per shift operation on arrays. For the expected use case (hourly windows, modest request counts), this is perfectly acceptable. If token budget tracking ever needed to handle thousands of records per window, a more efficient data structure (e.g., circular buffer or linked list) could be considered, but this is not a concern for current requirements.

### Requirements Traceability

| AC  | Requirement                                                                           | Test Coverage                                                                                    | Status |
| --- | ------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------ | ------ |
| 1   | `TokenBudget` class with rolling-window, configurable `maxTokensPerWindow`/`windowMs` | `default configuration` test, constructor in all tests                                           | ✓      |
| 2   | `canSpend(estimatedTokens?)` returns budget availability                              | 5 tests in `canSpend` describe block                                                             | ✓      |
| 3   | `recordUsage()` records consumption with timestamp, emits telemetry                   | `recordUsage` tests + `AI_TOKEN_USAGE` telemetry test                                            | ✓      |
| 4   | `getStatus()` returns full `TokenBudgetStatus`                                        | 3 tests in `getStatus` block + `windowMs` field test                                             | ✓      |
| 5   | `getRemainingBudget()` never negative                                                 | 3 tests in `getRemainingBudget` block, including `not go below zero`                             | ✓      |
| 6   | `reset()` clears records and warning flags                                            | 2 tests in `reset` block (clear records + reset flags)                                           | ✓      |
| 7   | Rolling window expires old records                                                    | `should expire old records` test with 50ms window                                                | ✓      |
| 8   | `onTelemetry` callback for telemetry events                                           | `should allow setting onTelemetry callback via setter` test                                      | ✓      |
| 9   | Warning at 80%/95% thresholds, once per crossing                                      | 4 tests: 80% warning, 95% warning, once-per-threshold, 95% only-once                             | ✓      |
| 10  | `AI_BUDGET_EXHAUSTED` at 0 remaining                                                  | `should emit AI_BUDGET_EXHAUSTED when fully used` test                                           | ✓      |
| 11  | Non-blocking telemetry                                                                | `should not throw if telemetry callback throws` test                                             | ✓      |
| 12  | `TokenUsageRecord` interface                                                          | Defined at lines 13-22, used throughout tests                                                    | ✓      |
| 13  | `TokenBudgetStatus` interface                                                         | Defined at lines 27-42, validated in `getStatus` tests                                           | ✓      |
| 14  | `TokenBudgetTelemetryEvent` interface                                                 | Defined at lines 47-54, `should include all required fields` test validates all fields and types | ✓      |
| 15  | Unit tests >80% coverage                                                              | 28 tests, 100% coverage (statements, branches, functions, lines)                                 | ✓      |
| 16  | Types exported from AI module barrel                                                  | `ai/index.ts` exports class + 3 types; `agent/index.ts` re-exports all                           | ✓      |

### Refactoring Performed

None — implementation meets all acceptance criteria without modification.

### Compliance Check

- Coding Standards: ✓ — Follows TypeScript conventions, uses `import type` for type-only imports, no `console.log`, proper JSDoc comments
- Project Structure: ✓ — File in correct location (`agent/ai/token-budget.ts`), tests in `__tests__/` directory, barrel exports in place
- Testing Strategy: ✓ — AAA pattern, descriptive test names, fresh instances via `beforeEach`, 100% coverage exceeds 80% requirement
- All ACs Met: ✓ — All 16 acceptance criteria fully satisfied

### Improvements Checklist

- [x] All acceptance criteria verified against implementation
- [x] All barrel exports confirmed (class + 3 type exports)
- [x] Test coverage confirmed at 100%
- [x] Rolling window flag reset behavior verified
- [ ] Consider: `Array.shift()` in pruning loop is O(n) per operation — acceptable for current scale but could be optimized with a circular buffer if record counts grow significantly (future consideration, not blocking)

### Security Review

No security concerns. The `TokenBudget` class:

- Has no external I/O (no network, no file system, no database)
- Uses `Date.now()` for timestamps (no user-controlled input)
- Telemetry callback errors are caught and silenced (no information leakage)
- No sensitive data stored in usage records

### Performance Considerations

- `Array.shift()` in `_pruneExpiredRecords` is O(n) per shift but acceptable for expected record counts in hourly windows
- `_getTotalUsed()` iterates all records on each call via `reduce()` — could be optimized with a running total, but given the small expected record count, this is not a concern
- Multiple calls to `_pruneExpiredRecords()` in `recordUsage()` (once directly, once via `getStatus()`) — minor redundancy but does not cause correctness issues

### Files Modified During Review

None — no files were modified during this review.

### Gate Status

Gate: PASS → docs/qa/gates/16.5-token-budget-cost-management.yml

### Recommended Status

✓ Ready for Done
