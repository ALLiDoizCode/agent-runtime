<!-- Powered by BMADâ„¢ Core -->

# Story 29.2: Enhanced AddressField and HexField Components

## Status

Ready for Review

## Story

**As a** connector operator using the Agent Explorer UI,
**I want** AddressField and HexField components to support clickable blockchain explorer links,
**So that** I can quickly navigate to external blockchain explorers (Aptos, Base Sepolia, XRP Testnet) to inspect addresses and transactions without manually copying and pasting.

## Acceptance Criteria

1. `AddressField` accepts optional `explorerUrl` prop and renders external link icon when provided
2. Clicking address text or external link icon opens explorer URL in new tab with security attributes
3. Hover state shows underline and blue color on address text when `explorerUrl` is provided
4. Copy button remains functional and visually separated from external link icon
5. `HexField` supports same explorer link pattern for transaction hashes
6. Focus states work correctly for keyboard navigation (Tab key support)
7. Playwright MCP browser verification confirms components render and function correctly

## Tasks / Subtasks

- [x] Task 1: Update AddressField Component with Explorer Link Support (AC: 1, 2, 3, 4)
  - [x] Add `explorerUrl?: string` prop to `AddressField` interface
  - [x] Import `ExternalLink` icon from `lucide-react`: `import { ExternalLink } from 'lucide-react'`
  - [x] Conditionally render address text as clickable link when `explorerUrl` is provided:
    ```typescript
    {explorerUrl ? (
      <a
        href={explorerUrl}
        target="_blank"
        rel="noopener noreferrer"
        className="font-mono text-sm text-blue-500 hover:text-blue-700 hover:underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded"
        onClick={(e) => {
          e.preventDefault();
          window.open(explorerUrl, '_blank', 'noopener,noreferrer');
        }}
      >
        {value}
      </a>
    ) : (
      <span className="font-mono text-sm break-all">{value}</span>
    )}
    ```
  - [x] Add `ExternalLink` icon button next to copy button when `explorerUrl` is provided:
    ```typescript
    {explorerUrl && (
      <button
        onClick={() => window.open(explorerUrl, '_blank', 'noopener,noreferrer')}
        className="shrink-0 p-1 rounded hover:bg-muted transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1"
        title="View on blockchain explorer"
        aria-label="View on blockchain explorer"
      >
        <ExternalLink className="w-3 h-3 text-muted-foreground hover:text-blue-500" />
      </button>
    )}
    ```
  - [x] Ensure visual separation between copy button and external link icon (gap-2)
  - [x] [Source: Epic 29 PRD lines 112-121, 134-136]

- [x] Task 2: Update HexField Component with Explorer Link Support (AC: 5)
  - [x] Add `explorerUrl?: string` prop to `HexField` interface
  - [x] Import `ExternalLink` icon from `lucide-react` if not already imported
  - [x] Apply same clickable link pattern as AddressField for `displayValue`:
    ```typescript
    {explorerUrl ? (
      <a
        href={explorerUrl}
        target="_blank"
        rel="noopener noreferrer"
        className={cn(
          'font-mono text-xs break-all text-blue-500 hover:text-blue-700 hover:underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded',
          shouldTruncate && 'cursor-pointer'
        )}
        onClick={(e) => {
          if (shouldTruncate) {
            e.preventDefault();
            setExpanded(!expanded);
          }
        }}
      >
        {displayValue}
      </a>
    ) : (
      <span
        className={cn(
          'font-mono text-xs break-all',
          shouldTruncate && 'cursor-pointer hover:text-blue-400'
        )}
        onClick={shouldTruncate ? () => setExpanded(!expanded) : undefined}
      >
        {displayValue}
      </span>
    )}
    ```
  - [x] Add `ExternalLink` icon button next to copy button when `explorerUrl` is provided (same pattern as AddressField)
  - [x] Handle interaction conflict: Clicking truncated value with `explorerUrl` should expand/collapse (NOT open link), clicking icon opens link
  - [x] [Source: Epic 29 PRD lines 112-121]

- [x] Task 3: Add Keyboard Navigation Support (AC: 6)
  - [x] Add `focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1` to all interactive elements (link text, external link icon button)
  - [x] Test Tab navigation: Copy button â†’ External link icon â†’ Next field (logical tab order)
  - [x] Test Enter key activation for external link button
  - [x] Add `aria-label="View on blockchain explorer"` to external link icon button for screen reader support
  - [x] [Source: Architecture coding standards accessibility requirements]

- [x] Task 4: Add Unit Tests for Enhanced Components (AC: 1-6)
  - [x] Create test file: `packages/connector/explorer-ui/src/components/FieldDisplay.test.tsx`
  - [x] Add test imports (Vitest + React Testing Library):
    ```typescript
    import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
    import { render, fireEvent } from '@testing-library/react';
    import { AddressField, HexField } from './FieldDisplay';
    ```
  - [x] Test: AddressField renders with explorerUrl prop

    ```typescript
    it('should render AddressField with external link icon when explorerUrl provided', () => {
      const { getByRole, getByLabelText } = render(
        <AddressField
          label="EVM Address"
          value="0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
          explorerUrl="https://sepolia.basescan.org/address/0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
        />
      );

      expect(getByRole('link')).toHaveAttribute('href', 'https://sepolia.basescan.org/address/0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb');
      expect(getByLabelText('View on blockchain explorer')).toBeInTheDocument();
    });
    ```

  - [x] Test: AddressField without explorerUrl renders as plain text

    ```typescript
    it('should render AddressField without external link when explorerUrl not provided', () => {
      const { queryByRole, queryByLabelText } = render(
        <AddressField label="ILP Address" value="g.alice" />
      );

      expect(queryByRole('link')).not.toBeInTheDocument();
      expect(queryByLabelText('View on blockchain explorer')).not.toBeInTheDocument();
    });
    ```

  - [x] Test: Click external link icon opens window in new tab

    ```typescript
    it('should open explorer URL in new tab when external link icon clicked', () => {
      const windowOpenSpy = vi.spyOn(window, 'open').mockImplementation(() => null);
      const { getByLabelText } = render(
        <AddressField
          label="Address"
          value="0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
          explorerUrl="https://sepolia.basescan.org/address/0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb"
        />
      );

      fireEvent.click(getByLabelText('View on blockchain explorer'));
      expect(windowOpenSpy).toHaveBeenCalledWith(
        'https://sepolia.basescan.org/address/0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb',
        '_blank',
        'noopener,noreferrer'
      );

      windowOpenSpy.mockRestore();
    });
    ```

  - [x] Test: HexField with explorerUrl renders external link icon
  - [x] Test: HexField expand/collapse interaction does not open explorer link when clicked
  - [x] Test: Copy button still functional with explorerUrl present
  - [x] [Source: architecture/test-strategy-and-standards.md lines 18-60]

- [x] Task 5: Playwright MCP Browser Verification (AC: 7)
  - [x] Start dev server: `npm run dev` in `packages/connector/explorer-ui/` directory
  - [x] Use `mcp__playwright__browser_navigate` to open `http://localhost:5173` (Vite default port)
  - [x] Use `mcp__playwright__browser_snapshot` to verify:
    - AddressField with `explorerUrl` shows blue clickable text
    - External link icon appears next to copy button
    - HexField with `explorerUrl` shows external link icon
  - [x] Test interactive elements with `mcp__playwright__browser_click`:
    - Click external link icon â†’ new tab opens (verify via browser logs)
    - Click copy button â†’ clipboard contains address value
    - Click address text â†’ explorer link opens (or expand/collapse for HexField if truncated)
  - [x] Verify UI states:
    - Hover state: Address text shows underline and blue color
    - Focus state: Tab navigation highlights link with blue ring
    - Copy button state: Green checkmark appears after copy
  - [x] [Source: CLAUDE.md "UI Development and Browser Verification" section]

- [x] Task 6: Run Tests and Verify Coverage (AC: 1-6)
  - [x] Run unit tests: `npm test -- FieldDisplay.test.tsx`
  - [x] Verify all tests pass (minimum 6 tests covering AddressField and HexField enhancements)
  - [x] Check test coverage: `npm test -- --coverage FieldDisplay.test.tsx`
  - [x] Ensure >80% line coverage for FieldDisplay.tsx component
  - [x] [Source: architecture/test-strategy-and-standards.md lines 5-13]

## Dev Notes

### Story Context

This is Story 29.2 in Epic 29: Blockchain Explorer Navigation Links. This story builds on the explorer URL utility created in Story 29.1 by integrating those URLs into the existing FieldDisplay components.

**Epic 29 Context:**

- **Story 29.1 (Done)**: Explorer URL Builder Utility & Address Type Detection
- **Story 29.2 (this story)**: Enhanced AddressField and HexField Components
- **Story 29.3**: WalletOverview Explorer Link Integration

**Dependencies:**

- Story 29.1 (Done): `packages/connector/explorer-ui/src/lib/explorer-links.ts` utility created
- Epic 14 (Done): Agent Explorer UI with FieldDisplay components

### Previous Story Insights

From Story 29.1 (Dev Agent Record):

- Explorer URL utility implemented with zero dependencies (pure TypeScript)
- `getExplorerUrl()` and `detectAddressType()` functions available
- Comprehensive test coverage (44 tests) with 100% logic coverage
- Testnet-only URLs hardcoded per Epic 29 scope
- Test framework is Vitest (not Jest) per existing project setup

### Data Models

No new data models required. This story enhances existing React components with optional props.

**Enhanced Component Props:**

```typescript
// AddressField (FieldDisplay.tsx)
interface AddressFieldProps extends BaseFieldProps {
  value: string;
  onCopy?: (value: string) => void;
  explorerUrl?: string; // NEW - optional blockchain explorer URL
}

// HexField (FieldDisplay.tsx)
interface HexFieldProps extends BaseFieldProps {
  value: string;
  maxLength?: number;
  onCopy?: (value: string) => void;
  explorerUrl?: string; // NEW - optional blockchain explorer URL
}
```

[Source: Epic 29 PRD lines 112-121]

### Component Integration Pattern

**Usage Pattern (Story 29.3 will implement):**

```typescript
import { AddressField } from '@/components/FieldDisplay';
import { getExplorerUrl, detectAddressType } from '@/lib/explorer-links';

// Example: Render EVM address with explorer link
const evmAddress = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb';
const explorerUrl = getExplorerUrl(evmAddress, 'address'); // 'https://sepolia.basescan.org/address/...'

<AddressField
  label="EVM Address"
  value={evmAddress}
  explorerUrl={explorerUrl}
/>

// Example: Render transaction hash with explorer link
const txHash = '0xb206e544e69642e894f4eb4d2ba8b6e2b26bf1fd4b5a76cfc0d73c55ca725b6a';
const txUrl = getExplorerUrl(txHash, 'tx', 'aptos'); // Must specify chain for tx hashes

<HexField
  label="Transaction Hash"
  value={txHash}
  explorerUrl={txUrl}
/>
```

[Source: Epic 29 PRD lines 237-250]

### File Locations

**Files to Modify:**

- `packages/connector/explorer-ui/src/components/FieldDisplay.tsx` - Update `AddressField` and `HexField` components (Task 1-2)

**Files to Create:**

- `packages/connector/explorer-ui/src/components/FieldDisplay.test.tsx` - Unit tests (Task 4)

**Existing Files (reference only):**

- `packages/connector/explorer-ui/src/lib/explorer-links.ts` - Explorer URL utility (Story 29.1, already created)
- `packages/connector/explorer-ui/src/lib/utils.ts` - shadcn `cn()` helper (existing)
- `packages/connector/explorer-ui/src/components/WalletOverview.tsx` - Will consume enhanced components in Story 29.3

[Source: architecture/source-tree.md lines 68-87]

### Technical Constraints

- **React 18 compatibility:** Components use React functional components with hooks
- **TypeScript strict mode:** All props must have proper type annotations
- **shadcn/ui styling:** Use Tailwind CSS classes for styling, maintain consistency with existing components
- **Lucide React icons:** Use `ExternalLink` icon from `lucide-react` package
- **Security best practices:** Use `window.open(url, '_blank', 'noopener,noreferrer')` to prevent tab-napping attacks
- **Accessibility:** Add `aria-label` for icon buttons, support keyboard navigation (Tab, Enter)
- **Backward compatibility:** `explorerUrl` prop is optional - components work without it (existing behavior preserved)

[Source: architecture/tech-stack.md lines 17-18, Epic 29 PRD lines 134-136]

### Testing Strategy

**Unit Tests (Task 4):**

- Test framework: Vitest with React Testing Library
- Co-located test file: `FieldDisplay.test.tsx` next to `FieldDisplay.tsx`
- Test both AddressField and HexField enhancements
- Cover edge cases: explorerUrl present vs. absent, click interactions, keyboard navigation
- Mock `window.open()` to verify new tab behavior
- Target >80% line coverage for components

**Playwright MCP Browser Verification (Task 5):**

- **CRITICAL**: This is a Frontend/UI story, so Playwright MCP browser verification is MANDATORY per CLAUDE.md guidelines
- Start dev server locally (`npm run dev`)
- Use Playwright MCP tools to verify components render correctly in browser
- Test interactive states: hover, focus, click behaviors
- Verify different UI states: with explorerUrl, without explorerUrl, copy success state

**Test Framework:**

- Vitest (NOT Jest) per existing project setup from Story 29.1
- React Testing Library for component tests
- Run with: `npm test -- FieldDisplay.test.tsx`

[Source: architecture/test-strategy-and-standards.md lines 5-60, CLAUDE.md "UI Development and Browser Verification"]

### Relevant Source Tree

```
packages/connector/explorer-ui/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib/
â”‚   â”‚   â”œâ”€â”€ explorer-links.ts           # Story 29.1 utility (existing)
â”‚   â”‚   â”œâ”€â”€ explorer-links.test.ts      # Story 29.1 tests (existing)
â”‚   â”‚   â””â”€â”€ utils.ts                    # shadcn cn() helper (existing)
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ FieldDisplay.tsx            # MODIFY (Task 1-2)
â”‚   â”‚   â”œâ”€â”€ FieldDisplay.test.tsx       # CREATE (Task 4)
â”‚   â”‚   â”œâ”€â”€ WalletOverview.tsx          # Story 29.3 will modify
â”‚   â”‚   â””â”€â”€ ui/                         # shadcn/ui components
â”‚   â”œâ”€â”€ App.tsx
â”‚   â””â”€â”€ main.tsx
â”œâ”€â”€ index.html
â”œâ”€â”€ vite.config.ts
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

[Source: architecture/source-tree.md lines 68-87]

### Security Considerations

**Tab-Napping Prevention:**
Using `window.open(url, '_blank', 'noopener,noreferrer')` prevents the opened tab from accessing the opener window via `window.opener`. This mitigates tab-napping attacks where malicious sites could manipulate the original tab.

**Relevant Attributes:**

- `target="_blank"` - Opens link in new tab
- `rel="noopener"` - Prevents `window.opener` access
- `rel="noreferrer"` - Prevents referrer header leakage

**XSS Protection:**
Explorer URLs are generated by trusted `getExplorerUrl()` utility (Story 29.1), not user input. No direct user input is interpolated into URLs, preventing XSS injection.

[Source: Epic 29 PRD lines 134-136, architecture/security.md]

### Accessibility Requirements

**Keyboard Navigation:**

- Tab key should navigate: Address text â†’ Copy button â†’ External link icon â†’ Next field
- Enter key should activate external link icon button
- Focus ring visible on all interactive elements (`focus:ring-2 focus:ring-blue-500`)

**Screen Reader Support:**

- External link icon button has `aria-label="View on blockchain explorer"`
- Link text is readable by screen readers
- Copy button has `title="Copy to clipboard"` for tooltip

**Visual Indicators:**

- Hover state: Underline and blue color for clickable address text
- Focus state: Blue ring outline for keyboard navigation
- Disabled state: N/A (all interactive elements functional when rendered)

[Source: architecture/coding-standards.md, Epic 29 PRD lines 112-130]

### Example Usage (Future Stories)

**Story 29.3 will use enhanced components:**

```typescript
import { AddressField, HexField } from '@/components/FieldDisplay';
import { getExplorerUrl } from '@/lib/explorer-links';

// WalletOverview.tsx - EVM address
const evmAddress = wallet.evmAddress;
const evmExplorerUrl = getExplorerUrl(evmAddress, 'address');

<AddressField
  label="EVM Address"
  value={evmAddress}
  explorerUrl={evmExplorerUrl}
/>

// WalletOverview.tsx - XRP address
const xrpAddress = wallet.xrpAddress;
const xrpExplorerUrl = getExplorerUrl(xrpAddress, 'address');

<AddressField
  label="XRP Address"
  value={xrpAddress}
  explorerUrl={xrpExplorerUrl}
/>

// EventDetailPanel.tsx - Transaction hash
const txHash = event.txHash;
const txExplorerUrl = getExplorerUrl(txHash, 'tx', event.chain); // Requires chain context

<HexField
  label="Transaction Hash"
  value={txHash}
  explorerUrl={txExplorerUrl}
/>
```

[Source: Epic 29 PRD lines 237-250]

### Visual Design Reference

**Before (Story 29.1 and earlier):**

```
EVM Address
0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb [ðŸ“‹]
```

**After (Story 29.2 enhancement):**

```
EVM Address
0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb [ðŸ“‹] [ðŸ”—]
(blue, underline on hover, clickable)
```

**Interaction Behaviors:**

- Click address text â†’ Opens explorer in new tab
- Click external link icon (ðŸ”—) â†’ Opens explorer in new tab
- Click copy button (ðŸ“‹) â†’ Copies address to clipboard, shows green checkmark
- Hover address text â†’ Blue color + underline
- Tab navigation â†’ Focus ring on interactive elements
- HexField: Click truncated value â†’ Expand/collapse (does NOT open link), click icon opens link

[Source: Epic 29 PRD lines 112-130]

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Implementation Summary

Successfully enhanced `AddressField` and `HexField` components in `FieldDisplay.tsx` to support optional blockchain explorer links via `explorerUrl` prop. Components now render clickable blue link text with external link icons when `explorerUrl` is provided, while maintaining backward compatibility (plain text when no URL).

**Key Implementation Details:**

- Added `explorerUrl?: string` prop to both `AddressField` and `HexField` interfaces
- Imported `ExternalLink` icon from `lucide-react`
- Implemented conditional rendering: clickable `<a>` tag when URL provided, `<span>` otherwise
- Added external link icon button next to copy button for visual clarity
- Security: Used `window.open(url, '_blank', 'noopener,noreferrer')` to prevent tab-napping attacks
- Accessibility: Full keyboard navigation support with focus rings and `aria-label` attributes
- HexField special case: Click truncated value expands/collapses (does NOT open link), icon button opens link

**Testing:**

- Created comprehensive unit test suite: `FieldDisplay.test.tsx` with 13 passing tests
- Tests cover: explorerUrl presence/absence, click interactions, window.open calls, copy functionality, keyboard navigation
- Playwright MCP browser verification confirmed all interactive behaviors working correctly in live browser

### Files Modified

- `packages/connector/explorer-ui/src/components/FieldDisplay.tsx` - Enhanced AddressField and HexField components

### Files Created

- `packages/connector/explorer-ui/src/components/FieldDisplay.test.tsx` - Unit tests (13 tests, all passing)
- `packages/connector/explorer-ui/test-field-components.html` - Browser test page (temporary, for Playwright verification)

### Debug Log References

None - implementation completed without blocking issues.

### Completion Notes

- All 6 tasks completed successfully
- All acceptance criteria met:
  1. âœ… AddressField accepts optional explorerUrl prop and renders external link icon
  2. âœ… Clicking address text or icon opens explorer URL in new tab with security attributes
  3. âœ… Hover state shows underline and blue color on address text when explorerUrl provided
  4. âœ… Copy button remains functional and visually separated from external link icon
  5. âœ… HexField supports same explorer link pattern for transaction hashes
  6. âœ… Focus states work correctly for keyboard navigation (Tab key support)
  7. âœ… Playwright MCP browser verification confirmed components render and function correctly

**Ready for Story 29.3:** Components now support `explorerUrl` prop. Next story will integrate `getExplorerUrl()` utility from Story 29.1 into `WalletOverview.tsx` to populate these URLs dynamically.

### File List

**Modified:**

- `packages/connector/explorer-ui/src/components/FieldDisplay.tsx`

**Created:**

- `packages/connector/explorer-ui/src/components/FieldDisplay.test.tsx`
- `packages/connector/explorer-ui/test-field-components.html` (temporary test page)

## QA Results

_This section will be filled in by the QA Agent during review._

## Change Log

| Date       | Version | Description                                                      | Author            |
| ---------- | ------- | ---------------------------------------------------------------- | ----------------- |
| 2026-01-31 | 1.0     | Initial story draft for enhanced field components                | PM/Analyst        |
| 2026-01-31 | 1.1     | Fix Task 4 to use Vitest syntax instead of Jest                  | Claude Code       |
| 2026-01-31 | 2.0     | Story implementation complete - all tasks done, ready for review | Dev Agent (James) |
