# Story 29.2: Refactor ConnectorNode to Use Config-First Settlement Init

**Epic:** 29 - Config-Driven Settlement Infrastructure
**Story Number:** 29.2
**Status:** Done

## Story Statement

**As a** connector developer,
**I want** `ConnectorNode.start()` to read settlement configuration from `this._config.settlementInfra` first (falling back to `process.env` for backward compatibility), build the peer address map from `PeerConfig.evmAddress`, and eliminate the `EVM_PRIVATE_KEY` swap hack,
**so that** each `ConnectorNode` instance is self-contained and multiple instances with different keypairs can coexist in a single process without `process.env` mutation.

## Prerequisites

**Story Dependencies:**

- Story 29.1 (types) — COMPLETED: Added `SettlementInfraConfig`, `PeerConfig.evmAddress`, `ConnectorConfig.settlementInfra`

**Epic Dependencies:**

- Epic 28 (in-memory ledger) — COMPLETED: `InMemoryLedgerClient`, `ILedgerClient` interface, ledger snapshot persistence
- Epic 6 (settlement foundation) — COMPLETED: `AccountManager`, `SettlementMonitor`, `SettlementExecutor`
- Epic 12 (KeyManager/security) — COMPLETED: `KeyManager` with `EnvironmentVariableBackend`

**Context:**
Story 29.1 added the `SettlementInfraConfig` interface (11 optional fields), `PeerConfig.evmAddress`, and `ConnectorConfig.settlementInfra` as types-only additions. Now in 29.2, we refactor `ConnectorNode.start()` and `_createInMemoryAccountManager()` to actually **use** those config fields, implementing the config-first pattern with env var fallbacks. The fragile `EVM_PRIVATE_KEY` swap hack (lines 342-357) and the hardcoded `PEER{1-5}` loop (lines 379-388) must be eliminated.

## Acceptance Criteria

1. All `process.env.*` settlement reads in `start()` replaced with config-first pattern (config value ?? env var fallback)
2. Peer address map built from `this._config.peers` using `peer.evmAddress` field, with `PEER{N}_EVM_ADDRESS` env var fallback for peers without `evmAddress`
3. `KeyManager` initialized with direct private key injection — no `process.env.EVM_PRIVATE_KEY` swap hack
4. `_createInMemoryAccountManager()` uses config-first for `ledgerSnapshotPath` and `ledgerPersistIntervalMs`
5. All existing tests pass without modification (backward compatibility verified)
6. Existing Docker Compose deployments work unchanged (env vars still respected)

## Dev Notes

### Previous Story Insights (29.1)

- Story 29.1 added `SettlementInfraConfig` with 11 optional fields mapped to env vars (see `config/types.ts:633-703`)
- `PeerConfig.evmAddress` added at `config/types.ts:85-90`
- `ConnectorConfig.settlementInfra` added at `config/types.ts:243-249`
- `ConfigLoader.validateConfig()` passes through `settlementInfra` at `config-loader.ts:202`
- `SettlementInfraConfig` exported from `lib.ts:51`
- The `threshold` field is typed as `string` (not `bigint`) because YAML/JSON cannot represent BigInt natively — consuming code should parse with `BigInt(value)`
- `connector-node.ts` was intentionally NOT modified in 29.1

### Config-First Pattern

Every `process.env` settlement read in `start()` should be replaced with this pattern:

```typescript
const value = this._config.settlementInfra?.fieldName ?? process.env.ENV_VAR_NAME;
```

This preserves backward compatibility: if `settlementInfra` is not provided (or the field is `undefined`), the env var fallback kicks in — identical to current behavior. All existing YAML configs and Docker Compose files continue to work unchanged.

### Detailed Refactoring Map

The following `process.env` reads in `connector-node.ts` must be replaced:

| Line(s) | Current `process.env` Read                  | Config-First Replacement                                                                                                   |
| ------- | ------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------- |
| 326     | `process.env.SETTLEMENT_ENABLED === 'true'` | `this._config.settlementInfra?.enabled ?? (process.env.SETTLEMENT_ENABLED === 'true')`                                     |
| 327     | `process.env.BASE_L2_RPC_URL`               | `this._config.settlementInfra?.rpcUrl ?? process.env.BASE_L2_RPC_URL`                                                      |
| 328     | `process.env.TOKEN_NETWORK_REGISTRY`        | `this._config.settlementInfra?.registryAddress ?? process.env.TOKEN_NETWORK_REGISTRY`                                      |
| 329     | `process.env.M2M_TOKEN_ADDRESS`             | `this._config.settlementInfra?.tokenAddress ?? process.env.M2M_TOKEN_ADDRESS`                                              |
| 330     | `process.env.TREASURY_EVM_PRIVATE_KEY`      | `this._config.settlementInfra?.privateKey ?? process.env.TREASURY_EVM_PRIVATE_KEY`                                         |
| 379-388 | `PEER{1-5}_EVM_ADDRESS` loop                | Build from `this._config.peers` using `peer.evmAddress`, fallback to env var                                               |
| 396     | Hardcoded `86400`                           | `this._config.settlementInfra?.settlementTimeoutSecs ?? 86400`                                                             |
| 397-399 | `process.env.INITIAL_DEPOSIT_MULTIPLIER`    | `this._config.settlementInfra?.initialDepositMultiplier ?? parseInt(process.env.INITIAL_DEPOSIT_MULTIPLIER ?? '1', 10)`    |
| 511     | `process.env.SETTLEMENT_THRESHOLD`          | `this._config.settlementInfra?.threshold ?? process.env.SETTLEMENT_THRESHOLD ?? '1000000'` (then `BigInt(...)`)            |
| 512-514 | `process.env.SETTLEMENT_POLLING_INTERVAL`   | `this._config.settlementInfra?.pollingIntervalMs ?? parseInt(process.env.SETTLEMENT_POLLING_INTERVAL ?? '30000', 10)`      |
| 1177    | `process.env.LEDGER_SNAPSHOT_PATH`          | `this._config.settlementInfra?.ledgerSnapshotPath ?? process.env.LEDGER_SNAPSHOT_PATH ?? './data/ledger-snapshot.json'`    |
| 1178    | `process.env.LEDGER_PERSIST_INTERVAL_MS`    | `this._config.settlementInfra?.ledgerPersistIntervalMs ?? parseInt(process.env.LEDGER_PERSIST_INTERVAL_MS ?? '30000', 10)` |

[Source: `packages/connector/src/core/connector-node.ts`, lines 326-398, 511-514, 1177-1178]

### EVM_PRIVATE_KEY Swap Hack Elimination (AC: 3)

**Current hack** (lines 342-357 of `connector-node.ts`):

```typescript
// Temporarily set EVM_PRIVATE_KEY for EnvironmentVariableBackend
const originalEvmKey = process.env.EVM_PRIVATE_KEY;
process.env.EVM_PRIVATE_KEY = treasuryPrivateKey;

const keyManager = new KeyManager({ backend: 'env', nodeId: this._config.nodeId }, this._logger);

// Restore original EVM_PRIVATE_KEY
if (originalEvmKey) {
  process.env.EVM_PRIVATE_KEY = originalEvmKey;
} else {
  delete process.env.EVM_PRIVATE_KEY;
}
```

**Replacement approach — Direct `EnvironmentVariableBackend` injection:**

Add an optional `privateKey` parameter to `EnvironmentVariableBackend` constructor that, when provided, takes precedence over `process.env.EVM_PRIVATE_KEY`. This is a small, backward-compatible change — when the parameter is not provided, behavior is identical to current. No `process.env` mutation needed, achieving true multi-node isolation (the Epic 29 goal).

```typescript
// In environment-backend.ts constructor:
constructor(logger: Logger, options?: { evmPrivateKey?: string }) {
  // ...
  const evmPrivateKey = options?.evmPrivateKey ?? process.env.EVM_PRIVATE_KEY;
  if (evmPrivateKey) {
    this.evmPrivateKey = evmPrivateKey;
    // ...
  }
}
```

Then in `KeyManager`, extend the `env` backend case to pass the private key through:

```typescript
// In key-manager.ts, 'env' case:
case 'env': {
  const { EnvironmentVariableBackend } = require('./backends/environment-backend');
  this.backend = new EnvironmentVariableBackend(this.logger, {
    evmPrivateKey: config.evmPrivateKey,
  });
  break;
}
```

And extend `KeyManagerConfig`:

```typescript
export interface KeyManagerConfig {
  backend: 'env' | 'aws-kms' | 'gcp-kms' | 'azure-kv' | 'hsm';
  nodeId: string;
  evmPrivateKey?: string; // Direct private key injection (bypasses process.env)
  // ... existing fields
}
```

**Then in `connector-node.ts`:**

```typescript
const keyManager = new KeyManager(
  {
    backend: 'env',
    nodeId: this._config.nodeId,
    evmPrivateKey: treasuryPrivateKey,
  },
  this._logger
);
```

No `process.env` swap needed. The hack is eliminated.

[Source: `packages/connector/src/security/key-manager.ts`, lines 108-172]
[Source: `packages/connector/src/security/backends/environment-backend.ts`, lines 11-38]

### Peer Address Map Refactoring (AC: 2)

**Current implementation** (lines 378-388 of `connector-node.ts`):

```typescript
const peerIdToAddressMap = new Map<string, string>();
for (let i = 1; i <= 5; i++) {
  const peerAddress = process.env[`PEER${i}_EVM_ADDRESS`];
  if (peerAddress) {
    peerIdToAddressMap.set(`peer${i}`, peerAddress);
  }
}
```

Problems: Hardcoded to 5 peers, uses `peer{N}` IDs that must match env var naming.

**Replacement:**

```typescript
const peerIdToAddressMap = new Map<string, string>();
for (const peer of this._config.peers) {
  if (peer.evmAddress) {
    peerIdToAddressMap.set(peer.id, peer.evmAddress);
    this._logger.debug(
      { peerId: peer.id, address: peer.evmAddress },
      'Loaded peer EVM address from config'
    );
  }
}

// Env var fallback for peers without evmAddress in config
// Supports legacy PEER{N}_EVM_ADDRESS pattern
for (let i = 1; i <= 10; i++) {
  const peerAddress = process.env[`PEER${i}_EVM_ADDRESS`];
  const peerId = `peer${i}`;
  if (peerAddress && !peerIdToAddressMap.has(peerId)) {
    peerIdToAddressMap.set(peerId, peerAddress);
    this._logger.debug(
      { peerId, address: peerAddress },
      'Loaded peer EVM address from env var (fallback)'
    );
  }
}
```

This iterates all configured peers (arbitrary count), uses their `evmAddress` first, then falls back to env vars for any `peer{N}` IDs that don't have an `evmAddress` in config. The env var loop is expanded to 10 for extra backward compatibility but will eventually be removed.

[Source: `packages/connector/src/core/connector-node.ts`, lines 378-388]

### \_createInMemoryAccountManager() Refactoring (AC: 4)

**Current implementation** (lines 1177-1178):

```typescript
const snapshotPath = process.env.LEDGER_SNAPSHOT_PATH || './data/ledger-snapshot.json';
const persistIntervalMs = parseInt(process.env.LEDGER_PERSIST_INTERVAL_MS || '30000', 10);
```

**Replacement:**

```typescript
const snapshotPath =
  this._config.settlementInfra?.ledgerSnapshotPath ??
  process.env.LEDGER_SNAPSHOT_PATH ??
  './data/ledger-snapshot.json';
const persistIntervalMs =
  this._config.settlementInfra?.ledgerPersistIntervalMs ??
  parseInt(process.env.LEDGER_PERSIST_INTERVAL_MS || '30000', 10);
```

[Source: `packages/connector/src/core/connector-node.ts`, lines 1176-1178]

### File Locations

| File                                                              | Action     | Description                                                                             |
| ----------------------------------------------------------------- | ---------- | --------------------------------------------------------------------------------------- |
| `packages/connector/src/core/connector-node.ts`                   | **Modify** | Refactor `start()` and `_createInMemoryAccountManager()` to use config-first pattern    |
| `packages/connector/src/security/key-manager.ts`                  | **Modify** | Add `evmPrivateKey` to `KeyManagerConfig`, pass through to `EnvironmentVariableBackend` |
| `packages/connector/src/security/backends/environment-backend.ts` | **Modify** | Accept optional `evmPrivateKey` in constructor (bypasses `process.env.EVM_PRIVATE_KEY`) |

**No new files created. No test files modified.**

### Coding Standards

- TypeScript strict mode, no `any` types
- All fields optional for backward compatibility
- JSDoc on any new/modified public method parameters
- Use Pino logger exclusively (`this._logger.info()` etc.) — NEVER `console.log`
- Follow existing patterns in `connector-node.ts` for config-first reads
- Keep env var fallbacks for backward compatibility

[Source: `docs/architecture/coding-standards.md`]

### Testing

**Test approach:** Backward compatibility verification — all existing tests must pass unchanged

**Framework:** Jest 29.7.x with `ts-jest`

**Unit tests:**

- No new test files needed for 29.2 (behavioral changes are backward-compatible)
- Existing `connector-node.test.ts` (co-located at `src/core/connector-node.test.ts`) must pass unchanged
- Existing `config-loader.test.ts` and `config-loader-mesh.test.ts` must pass unchanged
- Existing `key-manager.ts` related tests must pass unchanged (see test file list below)
- The new `EnvironmentVariableBackend(logger, { evmPrivateKey })` code path is not unit-tested in 29.2 — coverage deferred to Story 29.3 integration test where config-driven keypairs are exercised end-to-end

**Verification steps:**

1. `npm run build` — TypeScript compilation succeeds
2. `npm test` in connector package — all existing tests pass unchanged
3. `npm run lint` — no lint errors
4. Manual verification: pass a `ConnectorConfig` object with `settlementInfra` fields and confirm they're used (can be tested via Story 29.3 integration test)
5. Verify the `EVM_PRIVATE_KEY` swap hack is removed (no `process.env.EVM_PRIVATE_KEY =` assignments in `connector-node.ts`)
6. Verify the `for (let i = 1; i <= 5; i++)` peer loop is replaced with `this._config.peers` iteration

**Existing test files that must remain unchanged:**

- `packages/connector/src/core/connector-node.test.ts`
- `packages/connector/test/unit/config-loader.test.ts`
- `packages/connector/test/unit/config-loader-mesh.test.ts`
- `packages/connector/test/unit/key-manager.test.ts`
- `packages/connector/src/config/key-manager-config.test.ts`
- `packages/connector/src/security/backends/environment-backend.test.ts`

[Source: `docs/architecture/test-strategy-and-standards.md`]

## Tasks / Subtasks

### 1. Extend `EnvironmentVariableBackend` to accept optional direct private key (AC: 3)

- [x] Add optional `options` parameter to `EnvironmentVariableBackend` constructor: `constructor(logger: Logger, options?: { evmPrivateKey?: string })`
- [x] When `options.evmPrivateKey` is provided, use it instead of `process.env.EVM_PRIVATE_KEY`
- [x] Add JSDoc on the new parameter explaining it bypasses env var lookup
- [x] Existing behavior (no options, reads `process.env.EVM_PRIVATE_KEY`) is unchanged when options not provided

### 2. Extend `KeyManagerConfig` to support direct private key injection (AC: 3)

- [x] Add `evmPrivateKey?: string` field to `KeyManagerConfig` interface in `key-manager.ts`
- [x] Add JSDoc: "Optional EVM private key for direct injection. Bypasses process.env.EVM_PRIVATE_KEY. Used by config-driven settlement to avoid env var mutation."
- [x] In `KeyManager` constructor `'env'` case, pass `config.evmPrivateKey` to `EnvironmentVariableBackend`: `new EnvironmentVariableBackend(this.logger, { evmPrivateKey: config.evmPrivateKey })`

### 3. Refactor `start()` settlement enabled check and top-level config reads (AC: 1)

- [x] Replace `const settlementEnabled = process.env.SETTLEMENT_ENABLED === 'true'` with config-first pattern
- [x] Replace `const baseRpcUrl = process.env.BASE_L2_RPC_URL` with config-first pattern
- [x] Replace `const registryAddress = process.env.TOKEN_NETWORK_REGISTRY` with config-first pattern
- [x] Replace `const m2mTokenAddress = process.env.M2M_TOKEN_ADDRESS` with config-first pattern
- [x] Replace `const treasuryPrivateKey = process.env.TREASURY_EVM_PRIVATE_KEY` with config-first pattern

### 4. Eliminate `EVM_PRIVATE_KEY` swap hack in `start()` (AC: 3)

- [x] Remove the `originalEvmKey` save/restore block (lines 342-357)
- [x] Replace with `new KeyManager({ backend: 'env', nodeId: this._config.nodeId, evmPrivateKey: treasuryPrivateKey }, this._logger)`
- [x] Verify no `process.env.EVM_PRIVATE_KEY =` assignments remain in `connector-node.ts`

### 5. Refactor peer address map to use `PeerConfig.evmAddress` (AC: 2)

- [x] Replace `for (let i = 1; i <= 5; i++)` loop with `this._config.peers` iteration using `peer.evmAddress`
- [x] Add env var fallback loop for legacy `PEER{N}_EVM_ADDRESS` pattern (expanded from 5 to 10 for backward compatibility; this fallback loop will be removed in a future epic)
- [x] Only use env var fallback for peer IDs not already in map (config takes precedence)
- [x] Log whether address came from config or env var for debugging

### 6. Refactor remaining settlement config reads in `start()` (AC: 1)

- [x] Replace `const defaultSettlementTimeout = 86400` with `this._config.settlementInfra?.settlementTimeoutSecs ?? 86400`
- [x] Replace `INITIAL_DEPOSIT_MULTIPLIER` env var read with config-first pattern
- [x] Replace `SETTLEMENT_THRESHOLD` env var read with config-first pattern — note: `threshold` is typed as `string` in `SettlementInfraConfig`, wrap final value with `BigInt(...)` for the `settlementThreshold` variable
- [x] Replace `SETTLEMENT_POLLING_INTERVAL` env var read with config-first pattern

### 7. Refactor `_createInMemoryAccountManager()` to use config-first (AC: 4)

- [x] Replace `process.env.LEDGER_SNAPSHOT_PATH` with `this._config.settlementInfra?.ledgerSnapshotPath ?? process.env.LEDGER_SNAPSHOT_PATH ?? './data/ledger-snapshot.json'`
- [x] Replace `process.env.LEDGER_PERSIST_INTERVAL_MS` with `this._config.settlementInfra?.ledgerPersistIntervalMs ?? parseInt(process.env.LEDGER_PERSIST_INTERVAL_MS || '30000', 10)`

### 8. Verify compilation and existing tests (AC: 5, 6)

- [x] Run `npm run build` — TypeScript compilation succeeds
- [x] Run `npm test` in connector package — all existing tests pass unchanged
- [x] Run `npm run lint` — no lint errors
- [x] Verify no `process.env.EVM_PRIVATE_KEY =` assignments remain in `connector-node.ts`
- [x] Verify `for (let i = 1; i <= 5; i++)` loop is replaced
- [x] Verify `_createInMemoryAccountManager()` uses config-first reads

## Dev Agent Record

### Agent Model Used

- Claude Opus 4.6

### File List

| File                                                              | Action   | Description                                                                                       |
| ----------------------------------------------------------------- | -------- | ------------------------------------------------------------------------------------------------- |
| `packages/connector/src/security/backends/environment-backend.ts` | Modified | Added optional `options` parameter with `evmPrivateKey` for direct key injection                  |
| `packages/connector/src/security/key-manager.ts`                  | Modified | Added `evmPrivateKey` to `KeyManagerConfig`, pass through to `EnvironmentVariableBackend`         |
| `packages/connector/src/core/connector-node.ts`                   | Modified | Config-first settlement reads, eliminated EVM_PRIVATE_KEY swap hack, peer address map from config |

### Debug Log References

- No debug issues encountered

### Completion Notes

- All 8 tasks completed successfully
- `npm run build` — TypeScript compilation succeeds
- `npm test` — 115 suites passed, 2381 tests passed, 0 failures
- `npm run lint` — no lint errors
- No `process.env.EVM_PRIVATE_KEY =` assignments remain in `connector-node.ts`
- `for (let i = 1; i <= 5; i++)` loop replaced with `this._config.peers` iteration
- `_createInMemoryAccountManager()` uses config-first reads
- All changes are backward-compatible — env var fallbacks preserved

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                                                                | Author                            |
| ---------- | ------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| 2026-02-14 | 1.0     | Initial story draft                                                                                                                                                                                                                                                        | Claude (create-next-story task)   |
| 2026-02-14 | 1.1     | Validation fixes: added missing test file paths (SF-1), removed rejected approach from Dev Notes (SF-2), added EnvironmentVariableBackend test coverage note (SF-3), added BigInt conversion note in Task 6 (NH-1), clarified env var fallback loop scope in Task 5 (NH-2) | Claude (validate-next-story task) |

## QA Results

### Review Date: 2026-02-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. The config-first refactoring follows a clean, consistent pattern across all settlement `process.env` reads. The `??` (nullish coalescing) operator is used correctly throughout, ensuring `undefined` config values fall back to env vars while preserving explicit `false` or `0` values. The EVM_PRIVATE_KEY swap hack elimination is particularly well done — the direct injection approach through the `EnvironmentVariableBackend` constructor is backward-compatible and clean.

Key strengths:

- Consistent config-first pattern: `this._config.settlementInfra?.field ?? process.env.VAR`
- No process.env mutation — true multi-node isolation achieved
- Peer address map now supports arbitrary peer counts via config
- All env var fallbacks preserved for backward compatibility
- JSDoc added on new parameters explaining purpose

### Refactoring Performed

No additional refactoring needed — the implementation was clean and well-structured.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, no `any` types, Pino logger only, optional chaining used correctly
- Project Structure: ✓ Only 3 files modified as specified, no new files created
- Testing Strategy: ✓ All 115 test suites pass (2381 tests), no test files modified
- All ACs Met: ✓ All 6 acceptance criteria verified (see below)

### Acceptance Criteria Verification

| AC  | Description                                                  | Status | Evidence                                                                                                           |
| --- | ------------------------------------------------------------ | ------ | ------------------------------------------------------------------------------------------------------------------ |
| 1   | Config-first pattern for all `process.env` settlement reads  | ✓      | Lines 327-336, 406-410, 522-527, 1189-1195 of connector-node.ts                                                    |
| 2   | Peer address map from `this._config.peers` with env fallback | ✓      | Lines 375-398: iterates `this._config.peers`, fallback loop expanded to 10                                         |
| 3   | KeyManager direct injection, no EVM_PRIVATE_KEY swap         | ✓      | Lines 348-355: `evmPrivateKey: treasuryPrivateKey`; grep confirms zero `process.env.EVM_PRIVATE_KEY =` assignments |
| 4   | `_createInMemoryAccountManager()` config-first               | ✓      | Lines 1189-1195: `settlementInfra?.ledgerSnapshotPath`, `settlementInfra?.ledgerPersistIntervalMs`                 |
| 5   | All existing tests pass unchanged                            | ✓      | 115 suites, 2381 tests passed, 0 failures; zero test files modified                                                |
| 6   | Docker Compose backward compatibility                        | ✓      | All config-first reads have `?? process.env.*` fallbacks                                                           |

### Improvements Checklist

- [x] All 6 acceptance criteria verified
- [x] No `process.env.EVM_PRIVATE_KEY =` assignments in connector-node.ts
- [x] `for (let i = 1; i <= 5; i++)` loop replaced with `this._config.peers` iteration
- [x] TypeScript compilation succeeds (`npm run build`)
- [x] All tests pass (`npm test` — 2381 passed)
- [x] Lint passes (0 errors, 2 pre-existing warnings in test file)
- [x] JSDoc on new `EnvironmentVariableBackend` constructor `options` parameter
- [x] JSDoc on new `KeyManagerConfig.evmPrivateKey` field

### Security Review

- **Private key handling**: The `treasuryPrivateKey` is read from config or env var and passed directly to `KeyManager` — no intermediate storage or logging. The `SettlementInfraConfig.privateKey` JSDoc correctly warns "Sensitive — do not log or serialize in plaintext."
- **No env var mutation**: The elimination of the `process.env.EVM_PRIVATE_KEY` swap hack removes a concurrency-unsafe pattern that could leak keys between connector instances in the same process.
- No new security concerns introduced.

### Performance Considerations

No performance impact. The config-first reads add only a single property access with nullish coalescing fallback — negligible overhead. The peer address map iteration is now O(n) over configured peers instead of a fixed O(5) loop, which is better for large peer counts.

### Files Modified During Review

No files modified during review.

### Gate Status

Gate: PASS → docs/qa/gates/29.2-refactor-connector-node-config-first-settlement-init.yml
Risk profile: Low — backward-compatible refactoring with full env var fallbacks
NFR assessment: All PASS

### Recommended Status

✓ Ready for Done
