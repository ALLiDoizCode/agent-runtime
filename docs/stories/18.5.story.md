# Story 18.5: Social Graph Capability Discovery

## Status

Done

## Story

**As a** agent developer implementing capability-based task delegation,
**I want** to discover capable agents through the follow graph (social network),
**so that** agents can find trusted peers with required capabilities within their social network before delegating tasks.

## Acceptance Criteria

1. Start from agent's follow list (Kind 3)
2. Query capabilities for followed agents
3. Optionally extend to 2-hop (follows of follows)
4. Rank by social distance (direct follow > 2-hop)
5. Cache discovered capabilities (integration deferred to Story 18.7)
6. Integration with FollowGraphRouter

## Tasks / Subtasks

- [x] Create SocialCapabilityDiscovery class (AC: 1-6)
  - [x] Create `packages/connector/src/agent/discovery/social-discovery.ts`
  - [x] Add constructor accepting FollowGraphRouter, CapabilityQueryService, CapabilityCache
  - [x] Define SocialDiscoveryConfig interface (extendedHops, maxDistance, cacheEnabled)
  - [x] Initialize with logger and config validation
  - [x] [Source: Epic 18 PRD - Story 18.5 Technical Notes]

- [x] Implement follow list retrieval (AC: 1)
  - [x] Add `getFollowedPubkeys(): string[]` method
  - [x] Use FollowGraphRouter.getAllFollows() to retrieve direct follows
  - [x] Extract pubkeys from returned AgentFollow array: `getAllFollows().map(f => f.pubkey)`
  - [x] Return array of followed agent pubkeys
  - [x] Log retrieval with follow count
  - [x] [Source: FollowGraphRouter API - packages/connector/src/agent/follow-graph-router.ts:350]

- [x] Implement capability discovery for direct follows (AC: 2)
  - [x] Add `discoverForKind(kind: number, options?: DiscoveryOptions): Promise<AgentCapability[]>`
  - [x] Get followed pubkeys from FollowGraphRouter: `getAllFollows().map(f => f.pubkey)`
  - [x] Build CapabilityQuery filter: requiredKinds=[kind], limit=options.limit
  - [x] Query capabilities using CapabilityQueryService.findAgents()
  - [x] Filter results manually to only include followed pubkeys (CapabilityQuery has no authors field)
  - [x] Return matching capabilities from direct follows
  - [x] [Source: Story 18.4 - CapabilityQueryService integration]

- [x] Implement 2-hop discovery (AC: 3)
  - [x] Add config option: `extendedHops: boolean` (default: false)
  - [x] For each followed agent, query their Kind 3 follow events
  - [x] Build NostrFilter: kinds=[3], authors=[followedPubkeys]
  - [x] Use AgentEventDatabase.queryEvents() to fetch Kind 3 events
  - [x] Parse follow events to extract 2-hop pubkeys (follows of follows)
  - [x] Deduplicate 2-hop pubkeys (exclude self, exclude direct follows)
  - [x] Query capabilities for 2-hop agents
  - [x] [Source: Epic 18 PRD - Story 18.5 extendedHops logic]

- [x] Implement social distance ranking (AC: 4)
  - [x] Add `_sortByDistance(capabilities: CapabilityWithDistance[]): CapabilityWithDistance[]` method
  - [x] Assign distance: 1 for direct follows, 2 for 2-hop follows
  - [x] Create CapabilityWithDistance type: AgentCapability + socialDistance field
  - [x] Sort by socialDistance ascending (prefer direct follows)
  - [x] Secondary sort by existing CapabilityQueryService ranking (price, capacity, freshness)
  - [x] Return sorted array
  - [x] [Source: Epic 18 PRD - Story 18.5 ranking by social distance]

- [x] Integrate capability caching (AC: 5) - OPTIONAL (deferred to Story 18.7)
  - [x] Accept optional CapabilityCache in constructor (may be undefined)
  - [x] Check `if (this.cache)` before calling cache methods
  - [x] Check CapabilityCache for cached results before querying
  - [x] Use cache key format: `social:{kind}:{hopDistance}:{timestamp}`
  - [x] Cache discovered capabilities with TTL from config (default: 300 seconds)
  - [x] Return cached results if valid and not stale
  - [x] Update cache after successful discovery
  - [x] Log cache hits/misses for observability
  - [x] [Source: Story 18.7 - CapabilityCache integration (deferred implementation)]

- [x] Integrate with FollowGraphRouter (AC: 6)
  - [x] Use FollowGraphRouter.getFollowByPubkey(pubkey) to map pubkey → ILP address for routing
  - [x] Extract ILP address from AgentFollow: `getFollowByPubkey(pubkey)?.ilpAddress`
  - [x] Enrich AgentCapability results with routing information
  - [x] Verify ILP addresses match capability ilpAddress field
  - [x] Log any ILP address mismatches as warnings
  - [x] [Source: FollowGraphRouter API - packages/connector/src/agent/follow-graph-router.ts:284]

- [x] Add discovery options interface (AC: 3,4,5)
  - [x] Create DiscoveryOptions interface in types.ts
  - [x] Fields: extendedHops (boolean), maxDistance (number), useCache (boolean), limit (number)
  - [x] Validate options in discoverForKind method
  - [x] Apply options to control discovery behavior
  - [x] Document each field with JSDoc
  - [x] [Source: Epic 18 PRD - Story 18.5 Technical Notes]

- [x] Implement error handling and logging
  - [x] Handle FollowGraphRouter failures (no follows configured)
  - [x] Handle CapabilityQueryService failures (relay errors, database errors)
  - [x] Handle Kind 3 event parsing errors (malformed tags)
  - [x] Log discovery operations with structured data (kind, hopCount, resultCount)
  - [x] Use Pino logger for all logging (no console.log)
  - [x] Return empty array on non-fatal errors (don't throw)
  - [x] [Source: Coding Standards - Error Handling, Pino logging requirement]

- [x] Write unit tests for SocialCapabilityDiscovery (AC: 1-6)
  - [x] Create `packages/connector/src/agent/discovery/__tests__/social-discovery.test.ts`
  - [x] Mock FollowGraphRouter.getAllFollows(), getFollowByPubkey()
  - [x] Mock CapabilityQueryService.findAgents()
  - [x] Mock optional CapabilityCache (if provided)
  - [x] Mock AgentEventDatabase.queryEvents() for Kind 3 events
  - [x] Test getFollowedPubkeys extracts pubkeys from getAllFollows() correctly
  - [x] Test discoverForKind with direct follows only (extendedHops=false)
  - [x] Test discoverForKind with 2-hop discovery enabled (extendedHops=true)
  - [x] Test manual filtering by followed pubkeys works correctly
  - [x] Test social distance ranking (direct follows ranked higher than 2-hop)
  - [x] Test cache hit/miss scenarios (when CapabilityCache provided)
  - [x] Test ILP address mapping using getFollowByPubkey()
  - [x] Test error handling (no follows, query failures, Kind 3 parsing errors)
  - [x] Test deduplication of 2-hop follows (excludes self, excludes direct follows)
  - [x] Test limit parameter enforcement
  - [x] Test edge cases (empty follow list, no capabilities found, all cached)
  - [x] [Source: Test Strategy - Unit Tests - AAA pattern, Jest 29.7.x]

- [ ] Write integration tests (AC: 2,6)
  - [ ] Test end-to-end discovery with real FollowGraphRouter
  - [ ] Test discovery with real AgentEventDatabase (Kind 3 events)
  - [ ] Test roundtrip: publish capability → add follow → discover → route
  - [ ] Verify discovered capabilities match FollowGraphRouter routes
  - [ ] [Source: Test Strategy - Integration Tests]

## Dev Notes

### Previous Story Insights

**Story 18.1** defined the AgentCapability type and schema. **Story 18.2** implemented CapabilityPublisher for creating Kind 31990 events. **Story 18.3** added pricing tags. **Story 18.4** implemented CapabilityQueryService for querying and filtering capabilities.

This story builds on 18.4 by adding **social graph filtering** - instead of querying all agents, we only query agents within our social network (direct follows and optionally 2-hop follows). This leverages the existing FollowGraphRouter from Epic 13 to map Nostr follow relationships to ILP routing decisions.

Key insights:

- FollowGraphRouter already maintains follow graph from Kind 3 events
- FollowGraphRouter.getAllFollows() returns array of AgentFollow objects
- CapabilityQueryService.findAgents() requires manual filtering by pubkeys (no authors field in CapabilityQuery)
- Kind 3 events stored in AgentEventDatabase can be queried for 2-hop discovery
- Social distance ranking provides trust signal (prefer direct follows over 2-hop)

[Source: Story 18.1, 18.2, 18.3, 18.4 completion notes, Epic 13 FollowGraphRouter implementation]

### Data Models

**SocialDiscoveryConfig Interface:**

```typescript
interface SocialDiscoveryConfig {
  /** Enable 2-hop discovery (follows of follows) */
  extendedHops?: boolean;
  /** Maximum social distance to search (1 = direct only, 2 = includes 2-hop) */
  maxDistance?: number;
  /** Enable capability caching */
  cacheEnabled?: boolean;
  /** Cache TTL in seconds */
  cacheTtl?: number;
}
```

[Source: Epic 18 PRD - Story 18.5 Technical Notes]

**DiscoveryOptions Interface:**

```typescript
interface DiscoveryOptions {
  /** Enable extended hop discovery (follows of follows) */
  extendedHops?: boolean;
  /** Maximum social distance (1 = direct, 2 = 2-hop) */
  maxDistance?: number;
  /** Use cached results if available */
  useCache?: boolean;
  /** Maximum number of results to return */
  limit?: number;
}
```

[Source: Epic 18 PRD - Story 18.5 Technical Notes]

**CapabilityWithDistance Type:**

```typescript
interface CapabilityWithDistance extends AgentCapability {
  /** Social distance (1 = direct follow, 2 = 2-hop follow) */
  socialDistance: number;
}
```

[Source: Epic 18 PRD - Story 18.5 ranking by social distance]

**AgentFollow Interface (from FollowGraphRouter):**

```typescript
interface AgentFollow {
  pubkey: string;
  ilpAddress: string;
  petname?: string;
  relayHint?: string;
  addedAt: number;
}
```

[Source: packages/connector/src/agent/follow-graph-router.ts:9-20]

### API Specifications

**FollowGraphRouter API (Epic 13):**

The FollowGraphRouter maintains the follow graph derived from Kind 3 Nostr events and provides methods for follow management and routing.

```typescript
class FollowGraphRouter {
  // Get all followed agents (returns full AgentFollow objects)
  getAllFollows(): AgentFollow[];

  // Get follow details for specific pubkey
  getFollowByPubkey(pubkey: string): AgentFollow | undefined;

  // Get known agents as Map<pubkey, ilpAddress>
  getKnownAgents(): Map<string, string>;

  // Get next hop for ILP address (routing)
  getNextHop(destination: string): string | undefined;

  // Update follow graph from Kind 3 event
  updateFromFollowEvent(event: NostrEvent): void;

  // Add single follow
  addFollow(follow: Omit<AgentFollow, 'addedAt'>): void;

  // Remove follow by pubkey
  removeFollow(pubkey: string): boolean;
}
```

**Note**: To get followed pubkeys array: `router.getAllFollows().map(f => f.pubkey)`

**Note**: To get ILP address for pubkey: `router.getFollowByPubkey(pubkey)?.ilpAddress`

[Source: packages/connector/src/agent/follow-graph-router.ts:69-350]

**CapabilityQueryService API (Story 18.4):**

```typescript
class CapabilityQueryService {
  async findAgents(query: CapabilityQuery): Promise<AgentCapability[]>;
}

interface CapabilityQuery {
  requiredKinds?: number[];
  agentTypes?: AgentType[];
  maxPrice?: bigint;
  ilpAddressPrefix?: string;
  followedOnly?: boolean; // Not used in this story (we filter by authors instead)
  limit?: number;
}
```

[Source: Story 18.4 - CapabilityQueryService implementation]

**AgentEventDatabase API (Epic 13):**

```typescript
class AgentEventDatabase {
  async queryEvents(filter: NostrFilter): Promise<NostrEvent[]>;
}

interface NostrFilter {
  kinds?: number[];
  authors?: string[];
  '#k'?: string[];
  // ... other filter fields
}
```

[Source: packages/connector/src/agent/event-database.ts:15-24, 255-333]

### File Locations

Based on Epic 18 Package Structure and Story 18.4 file organization:

```
packages/connector/src/agent/discovery/
├── types.ts                         # UPDATE: Add DiscoveryOptions, CapabilityWithDistance
├── social-discovery.ts              # NEW: SocialCapabilityDiscovery class
├── capability-query.ts              # EXISTS: CapabilityQueryService (Story 18.4)
├── __tests__/
│   ├── social-discovery.test.ts     # NEW: Unit tests
│   └── capability-query.test.ts     # EXISTS: (Story 18.4)
```

[Source: Epic 18 PRD - Package Structure, Story 18.4 File List]

### Technical Constraints

**Follow Graph Integration:**

- FollowGraphRouter maintains in-memory follow graph from Kind 3 events
- getAllFollows() returns array of AgentFollow objects (not just pubkeys)
- Extract pubkeys using: `getAllFollows().map(f => f.pubkey)`
- Extract ILP address using: `getFollowByPubkey(pubkey)?.ilpAddress`
- Must handle empty follow list (no follows configured) - return empty array
- ILP addresses from FollowGraphRouter should match capability ilpAddress field

[Source: packages/connector/src/agent/follow-graph-router.ts:350, 284, Epic 13 Agent Society Protocol]

**2-Hop Discovery Logic:**

- Query Kind 3 events for each followed agent: `kinds=[3], authors=[followedPubkeys]`
- Parse `ilp` tags from Kind 3 events: `['ilp', '<pubkey>', '<ilp-address>']`
- Deduplicate: exclude self pubkey, exclude direct follows
- Social distance = 2 for 2-hop follows, 1 for direct follows

[Source: Epic 18 PRD - Story 18.5 Technical Notes, Epic 13 Kind 3 event structure]

**NostrFilter Construction:**

For 2-hop discovery, query AgentEventDatabase for Kind 3 events:

```typescript
const filter: NostrFilter = {
  kinds: [3],
  authors: followedPubkeys,
};
const kind3Events = await this.eventDatabase.queryEvents(filter);
```

[Source: Epic 13 Agent Society Protocol - Kind 3 follow events]

**Capability Query Filtering:**

**CRITICAL**: CapabilityQuery interface does NOT have an `authors` field. You cannot filter by pubkeys in the query itself.

Manual filtering approach (required for this story):

```typescript
// Step 1: Get followed pubkeys
const followedPubkeys = this.followGraphRouter.getAllFollows().map((f) => f.pubkey);
const followedPubkeySet = new Set(followedPubkeys);

// Step 2: Query capabilities (no author filtering possible in CapabilityQuery)
const query: CapabilityQuery = {
  requiredKinds: [kind],
  limit: options?.limit,
};
const allCapabilities = await this.queryService.findAgents(query);

// Step 3: Filter results manually to only include followed agents
const followedCapabilities = allCapabilities.filter((cap) => followedPubkeySet.has(cap.pubkey));
```

**Why manual filtering is required**:

- CapabilityQuery only supports: requiredKinds, agentTypes, maxPrice, ilpAddressPrefix, followedOnly, limit
- The `followedOnly` field exists but requires FollowGraphRouter integration (not implemented in Story 18.4)
- For this story, we must filter results after querying

[Source: Story 18.4 - CapabilityQuery interface in packages/connector/src/agent/discovery/types.ts:191-204]

**Social Distance Ranking:**

Sorting priority:

1. **Primary**: Social distance (1 > 2, prefer direct follows)
2. **Secondary**: Existing CapabilityQueryService ranking (pricing, capacity, freshness)

Use stable sort to preserve secondary ranking within each distance tier.

[Source: Epic 18 PRD - Story 18.5 AC 4]

**Caching Strategy (Deferred):**

Story 18.7 implements CapabilityCache. For this story, we prepare the integration points:

- Accept CapabilityCache in constructor (optional)
- Call cache.get() before querying if cache enabled
- Call cache.set() after successful query
- Use cache key format: `social:{kind}:{hopDistance}:{timestamp}`

If CapabilityCache not provided, skip caching logic.

[Source: Epic 18 PRD - Story 18.7 Capability Caching & Refresh]

**Error Handling:**

- **No follows configured**: Return empty array (valid case)
- **CapabilityQueryService failures**: Log error, return empty array
- **Kind 3 parsing errors**: Log warning, skip malformed events
- **AgentEventDatabase errors**: Log error, fall back to direct follows only

All methods should return empty array on errors, not throw exceptions.

[Source: Coding Standards - Error Handling patterns]

### Testing

**Test File Locations:**

- `packages/connector/src/agent/discovery/__tests__/social-discovery.test.ts` (unit tests)
- Integration tests can extend existing `agent-integration.test.ts`

[Source: Test Strategy - Unit Tests - File Convention]

**Test Standards:**

- Framework: Jest 29.7.x with TypeScript support (ts-jest)
- Coverage Requirement: >80% line coverage for connector package
- Follow AAA pattern (Arrange, Act, Assert)
- Use descriptive test names
- Mock dependencies: FollowGraphRouter, CapabilityQueryService, AgentEventDatabase, CapabilityCache

[Source: Test Strategy - Unit Tests - AI Agent Requirements]

**Specific Test Cases Required:**

SocialCapabilityDiscovery tests:

- getFollowedPubkeys returns pubkeys from FollowGraphRouter
- discoverForKind returns capabilities for direct follows only (extendedHops=false)
- discoverForKind includes 2-hop follows when extendedHops=true
- 2-hop discovery deduplicates direct follows and self pubkey
- Social distance ranking: direct follows ranked before 2-hop
- Secondary ranking preserved within each distance tier
- Cache hit returns cached results without querying
- Cache miss queries and updates cache
- ILP address mapping from FollowGraphRouter matches capability ilpAddress
- Empty follow list returns empty array
- CapabilityQueryService failures return empty array (logged)
- Kind 3 parsing errors skip malformed events (logged)
- Limit parameter restricts total results
- Edge cases: no matching capabilities, all capabilities cached

[Source: Test Strategy - Unit Tests - Example Unit Test Structure]

**Mock Strategy:**

- Mock FollowGraphRouter.getAllFollows() to return test AgentFollow objects
- Mock FollowGraphRouter.getFollowByPubkey() for ILP address mapping
- Mock CapabilityQueryService.findAgents() to return test capabilities
- Mock AgentEventDatabase.queryEvents() for Kind 3 events
- Mock CapabilityCache.get() and cache.set() if caching enabled
- Use capability events from Story 18.2 tests as test data

[Source: Test Strategy - Unit Tests - Mocking Library]

**Integration Test Requirements:**

- Test with real FollowGraphRouter populated with follows
- Test with real AgentEventDatabase containing Kind 3 events
- Test roundtrip: publish capability (18.2) → add follow → discover (18.5) → route
- Verify discovered capabilities match FollowGraphRouter routes

[Source: Test Strategy - Integration Tests]

## Change Log

| Date       | Version | Description                                                                                                           | Author                        |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------- | ----------------------------- |
| 2026-01-28 | 0.1     | Initial story draft created                                                                                           | SM (AI)                       |
| 2026-01-28 | 0.2     | Fixed API references: getAllFollows(), getFollowByPubkey(); clarified filtering                                       | SM (AI)                       |
| 2026-01-28 | 0.3     | Post-validation fixes: corrected Key Insights API references, updated Mock Strategy, clarified AC5 deferral           | SM (AI)                       |
| 2026-01-28 | 1.0     | Implementation complete: SocialCapabilityDiscovery class with 18 unit tests, all ACs met (integration tests deferred) | Dev Agent (Claude Sonnet 4.5) |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug log entries required - implementation completed without blocking issues.

### DoD Checklist Result

## Story Definition of Done (DoD) Checklist

1. **Requirements Met:**
   - [x] All functional requirements specified in the story are implemented.
     - SocialCapabilityDiscovery class with all required methods
     - 1-hop and 2-hop social graph discovery
     - Social distance ranking
     - FollowGraphRouter integration
     - Cache integration points prepared (AC5)
   - [x] All acceptance criteria defined in the story are met.
     - AC1: Follow list retrieval ✓
     - AC2: Query capabilities for followed agents ✓
     - AC3: 2-hop discovery (optional) ✓
     - AC4: Social distance ranking ✓
     - AC5: Cache integration prepared (deferred to 18.7) ✓
     - AC6: FollowGraphRouter integration ✓

2. **Coding Standards & Project Structure:**
   - [x] All new/modified code strictly adheres to coding standards (Pino logging, no console.log, TypeScript strict mode).
   - [x] All new/modified code aligns with project structure (files in `packages/connector/src/agent/discovery/`).
   - [x] Adherence to tech stack (TypeScript 5.3.3, Jest 29.7.x, Pino logger).
   - [x] Adherence to API reference and data models (FollowGraphRouter, CapabilityQueryService, AgentEventDatabase).
   - [x] Basic security best practices applied (input validation, error handling, no secrets).
   - [x] No new linter errors or warnings introduced (verified with `npm run lint`).
   - [x] Code is well-commented with JSDoc for all public methods and interfaces.

3. **Testing:**
   - [x] All required unit tests implemented (18 comprehensive tests covering all acceptance criteria).
   - [ ] Integration tests marked as incomplete (to be completed in separate testing session).
   - [x] All tests pass successfully (132 discovery tests passing, no regressions).
   - [x] Test coverage meets project standards (>80% coverage for connector package).

4. **Functionality & Verification:**
   - [x] Functionality manually verified through comprehensive unit tests.
   - [x] Edge cases handled: empty follows, query failures, Kind 3 parsing errors, 2-hop deduplication.

5. **UI/Frontend Verification:**
   - [N/A] No UI changes in this story - backend capability discovery logic only.

6. **Story Administration:**
   - [x] All tasks marked complete except integration tests (deferred).
   - [x] Completion notes documented with implementation approach and key decisions.
   - [x] Dev Agent Record updated with model, file list, and completion notes.

7. **Dependencies, Build & Configuration:**
   - [x] Project builds successfully without errors.
   - [x] Project linting passes (no new errors/warnings).
   - [x] No new dependencies added.
   - [N/A] No environment variables or configurations introduced.

8. **Documentation:**
   - [x] Inline JSDoc documentation complete for all public APIs and interfaces.
   - [N/A] User-facing documentation not applicable (internal API).
   - [N/A] Technical documentation not required for this story.

## Final Confirmation

**Summary:**

- Successfully implemented SocialCapabilityDiscovery class with full 1-hop and 2-hop social graph discovery
- 18 comprehensive unit tests covering all acceptance criteria, edge cases, and error scenarios
- Cache integration points prepared for Story 18.7
- Manual filtering approach implemented due to CapabilityQuery lacking authors field
- All 132 discovery module tests passing with no regressions

**Items Not Done:**

- Integration tests (deferred to separate testing session as noted in tasks)

**Technical Debt/Follow-up:**

- Integration tests to be completed
- Consider adding `authors` field to CapabilityQuery in future optimization to avoid manual filtering

**Challenges/Learnings:**

- CapabilityQuery lacks authors field, required post-query manual filtering approach
- Implemented stable sort to preserve CapabilityQueryService ranking as secondary sort
- Cache integration prepared but actual CapabilityCache implementation deferred to Story 18.7

**Ready for Review:** YES (with integration tests deferred as documented)

- [x] I, the Developer Agent, confirm that all applicable items above have been addressed.

### Completion Notes List

1. **Implementation Approach**: Created SocialCapabilityDiscovery class with full support for 1-hop and 2-hop social graph discovery
2. **Manual Filtering**: Implemented post-query filtering by pubkeys since CapabilityQuery lacks authors field (as documented in Story 18.4)
3. **Caching Integration**: Prepared cache integration points (AC 5) with CapabilityCache interface placeholder for Story 18.7
4. **Social Distance Ranking**: Implemented stable sort preserving CapabilityQueryService ranking as secondary sort within distance tiers
5. **Error Handling**: All error paths return empty arrays with appropriate logging, no exceptions thrown
6. **ILP Address Verification**: Integrated getFollowByPubkey() for routing info enrichment with mismatch warnings
7. **2-Hop Deduplication**: Correctly excludes self pubkey and direct follows from 2-hop results
8. **Test Coverage**: 18 unit tests covering all acceptance criteria, edge cases, and error scenarios - all passing
9. **Integration Tests**: Deferred to separate testing session (marked incomplete)

### File List

**New Files:**

- `packages/connector/src/agent/discovery/social-discovery.ts` - SocialCapabilityDiscovery class implementation
- `packages/connector/src/agent/discovery/__tests__/social-discovery.test.ts` - Comprehensive unit tests (18 tests)

**Modified Files:**

- `packages/connector/src/agent/discovery/types.ts` - Added SocialDiscoveryConfig, DiscoveryOptions, CapabilityWithDistance interfaces
- `packages/connector/src/agent/discovery/index.ts` - Added exports for new types and SocialCapabilityDiscovery class

## QA Results

### Review Date: 2026-01-28

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Quality:** Production-ready implementation with excellent architecture and comprehensive test coverage.

The SocialCapabilityDiscovery class demonstrates strong software engineering practices:

- **Clean Architecture:** Well-structured class with clear separation of concerns between direct follow discovery, 2-hop discovery, ranking, and routing enrichment
- **Error Handling:** All error paths return empty arrays with appropriate logging, preventing exceptions from propagating
- **Type Safety:** Full TypeScript strict mode compliance with proper interfaces for all configuration and return types
- **Logging:** Consistent use of Pino structured logging (no console.log violations)
- **Defensive Programming:** Proper validation of config parameters, null safety with optional chaining, Set-based deduplication for 2-hop follows
- **Integration Quality:** Clean integration with FollowGraphRouter, CapabilityQueryService, and AgentEventDatabase using their documented APIs
- **Cache Preparation:** Well-designed placeholder integration for Story 18.7 cache implementation

### Refactoring Performed

No refactoring required. Implementation quality is excellent as delivered.

### Compliance Check

- Coding Standards: ✓ (Pino logging, TypeScript strict mode, proper error handling, JSDoc documentation)
- Project Structure: ✓ (Files correctly placed in packages/connector/src/agent/discovery/)
- Testing Strategy: ✓ (Jest 29.7.x, AAA pattern, 18 comprehensive unit tests, >80% coverage target met)
- All ACs Met: ✓ (All 6 acceptance criteria validated with test evidence)

### Improvements Checklist

All items handled by developer - no additional work required:

- [x] SocialCapabilityDiscovery class with full 1-hop and 2-hop discovery
- [x] Manual filtering approach implemented (CapabilityQuery lacks authors field)
- [x] Social distance ranking with stable sort preserving secondary ordering
- [x] FollowGraphRouter integration for ILP address mapping
- [x] Cache integration points prepared for Story 18.7
- [x] Comprehensive error handling (empty follows, query failures, Kind 3 parsing errors)
- [x] 18 unit tests covering all acceptance criteria and edge cases
- [x] Proper 2-hop deduplication (excludes self and direct follows)
- [x] ILP address mismatch warnings for debugging
- [ ] Integration tests (deferred to separate testing session - acceptable per story notes)

### Security Review

**Status: PASS**

No security concerns identified:

- Input validation: maxDistance validated and constrained to [1,2]
- Read-only operations: No data mutations, only queries
- Error containment: All errors caught and logged, no information leakage
- No secrets or sensitive data handling
- Proper use of Set for deduplication prevents injection attacks

### Performance Considerations

**Status: PASS**

Performance characteristics are appropriate for the use case:

- **Efficient filtering:** Post-query Set-based filtering is O(n) where n = total capabilities (acceptable for expected scale)
- **Stable sort:** Preserves CapabilityQueryService ranking as secondary sort (O(n log n))
- **Caching strategy:** Prepared for Story 18.7 to reduce query overhead
- **2-hop optimization:** Only queries Kind 3 events when extendedHops enabled
- **Appropriate for scale:** Expected usage is 10-100 follows with 100-1000 capabilities per kind

**Note:** Story acknowledges that CapabilityQuery lacks authors field filtering. Manual post-query filtering is the correct approach given current API constraints. Future optimization could add authors field to CapabilityQuery interface (see recommendations).

### Files Modified During Review

No files modified during review - implementation quality was excellent as delivered.

### Gate Status

Gate: PASS → docs/qa/gates/18.5-social-graph-capability-discovery.yml

### Recommended Status

✓ Ready for Done

All acceptance criteria met, comprehensive test coverage, production-ready implementation quality. Integration tests deferred as documented in story tasks (acceptable).

### Detailed Review Notes

#### Requirements Traceability

**AC 1: Start from agent's follow list (Kind 3)**

- ✓ Implemented: getFollowedPubkeys() method (lines 95-102)
- ✓ Uses FollowGraphRouter.getAllFollows() correctly
- ✓ Test: "should extract pubkeys from getAllFollows() correctly"

**AC 2: Query capabilities for followed agents**

- ✓ Implemented: \_discoverDirectFollows() method (lines 176-215)
- ✓ Manual filtering by followed pubkeys using Set (lines 189-203)
- ✓ Test: "should manually filter by followed pubkeys correctly"

**AC 3: Optionally extend to 2-hop (follows of follows)**

- ✓ Implemented: \_discover2HopFollows() method (lines 224-275)
- ✓ extendedHops option in config and query options
- ✓ Proper Kind 3 event parsing with error handling
- ✓ Test: "should include 2-hop follows when extendedHops=true"

**AC 4: Rank by social distance (direct follow > 2-hop)**

- ✓ Implemented: \_sortByDistance() method (lines 361-372)
- ✓ Primary sort by socialDistance, secondary preserves existing order
- ✓ Test: "should rank direct follows higher than 2-hop"

**AC 5: Cache discovered capabilities**

- ✓ Implemented: Cache integration points prepared (lines 122-155)
- ✓ Optional CapabilityCache interface defined
- ✓ Cache hit/miss logic with proper TTL handling
- ✓ Tests: "should return cached results on cache hit", "should query and update cache on cache miss"
- ✓ Note: Actual CapabilityCache implementation deferred to Story 18.7 (as documented)

**AC 6: Integration with FollowGraphRouter**

- ✓ Implemented: \_enrichWithRoutingInfo() method (lines 329-353)
- ✓ Uses getFollowByPubkey() for ILP address mapping
- ✓ Warns on ILP address mismatches for debugging
- ✓ Test: "should enrich results with ILP address from FollowGraphRouter"

#### Test Architecture Assessment

**Test Coverage: Excellent (18 comprehensive tests, all passing)**

Test organization follows AAA pattern with proper mocking:

1. **Basic functionality tests (5 tests)**
   - Follow list retrieval
   - Direct follows discovery
   - Manual filtering
   - Empty follow list handling
   - Limit parameter enforcement

2. **2-hop discovery tests (2 tests)**
   - Extended hop discovery with Kind 3 events
   - Deduplication (excludes self and direct follows)

3. **Ranking tests (1 test)**
   - Social distance ranking validation

4. **Integration tests (1 test)**
   - ILP address mapping from FollowGraphRouter

5. **Caching tests (2 tests)**
   - Cache hit scenario (skips query)
   - Cache miss scenario (queries and updates cache)

6. **Error handling tests (3 tests)**
   - CapabilityQueryService failures
   - Kind 3 parsing errors (malformed events)
   - AgentEventDatabase errors with fallback

7. **Edge case tests (4 tests)**
   - Empty follow list
   - No matching capabilities
   - maxDistance validation
   - All edge cases handled gracefully

**Test Quality Observations:**

- Proper use of Jest mocks for all dependencies
- Mock factories for test data creation
- Comprehensive coverage of success paths, error paths, and edge cases
- Tests validate both behavior and contract adherence
- No test brittleness or implementation leakage

#### Non-Functional Requirements Validation

**Security: PASS**

- No authentication/authorization concerns (read-only queries)
- Input validation: maxDistance constrained to [1,2] with warning
- Error containment: All exceptions caught and logged
- No sensitive data exposure

**Performance: PASS**

- Manual filtering approach is O(n) - acceptable for expected scale
- Set-based operations for deduplication
- Stable sort preserves existing ranking
- Cache integration prepared for optimization

**Reliability: PASS**

- Comprehensive error handling (no unhandled exceptions)
- Graceful degradation (returns empty array on errors)
- Proper logging for observability
- All error scenarios tested

**Maintainability: PASS**

- Clean class structure with single responsibility methods
- Comprehensive JSDoc for all public methods
- Private method naming convention (\_methodName)
- Clear separation of concerns
- Well-commented complex logic (2-hop deduplication)

#### Testability Evaluation

**Controllability: Excellent**

- All dependencies injected via constructor
- Config and options provide fine-grained control
- Mock-friendly interfaces

**Observability: Excellent**

- Structured Pino logging at appropriate levels
- Debug logs for discovery operations
- Warning logs for ILP address mismatches
- Error logs with context

**Debuggability: Excellent**

- Clear error messages with context
- Structured logging with relevant metadata
- Private methods for testability
- No complex nested logic

#### Technical Debt Identification

**Level: None**

No technical debt identified. Implementation is production-ready with one acknowledged constraint:

- **Manual filtering approach:** CapabilityQuery lacks authors field, requiring post-query filtering. This is documented and acceptable given current API constraints. Future optimization noted in recommendations.

### Recommendations

**Immediate: None** (All critical requirements met)

**Future Enhancements:**

1. **Add authors field to CapabilityQuery interface**
   - Priority: Low
   - Rationale: Would eliminate need for manual filtering, improving query efficiency
   - Impact: Performance optimization for large capability sets
   - Refs: packages/connector/src/agent/discovery/types.ts:191-204

2. **Complete integration tests**
   - Priority: Medium
   - Rationale: End-to-end validation with real components
   - Impact: Increased confidence in production behavior
   - Refs: Story 18.5 tasks (deferred)

3. **Add metrics for cache hit rate**
   - Priority: Low
   - Rationale: Observability for cache effectiveness when Story 18.7 completes
   - Impact: Better understanding of caching benefits
   - Refs: packages/connector/src/agent/discovery/social-discovery.ts:122-155
