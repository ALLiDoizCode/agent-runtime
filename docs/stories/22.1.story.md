# Story 22.1: Simplify PacketHandler to Use SHA256(data) Fulfillment

**Epic:** 22 - Agent-Runtime Middleware Simplification
**Story Number:** 22.1
**Status:** Done

## Story

**As a** connector operator,
**I want** the agent-runtime to compute fulfillment as SHA256(data) without session lookup,
**so that** the middleware is stateless and doesn't require SPSP session setup before receiving payments.

## Acceptance Criteria

1. PacketHandler constructor no longer takes SessionManager parameter
2. Any packet whose `destination` starts with `config.baseAddress` is forwarded to BLS (no session lookup required)
3. Fulfillment computed as `SHA256(base64decode(request.data))` — verified by unit test
4. Fulfillment matches condition from outbound sender: `SHA256(fulfillment) == SHA256(SHA256(data))` ✓
5. BLS `data` field passed through in both FULFILL and REJECT responses
6. Payment expiry check retained (`expiresAt < now` → reject R00)
7. `fulfillment.test.ts` updated with new SHA256-based tests
8. `session-manager.test.ts` removed
9. No regression in outbound send tests (`ilp-send-handler.test.ts`, `outbound-btp-client.test.ts`)

## Dev Notes

### Previous Story Insights (Story 21.3 — Last Completed Story)

- Epic 21 is complete (all 3 stories Done). Epic 22 starts fresh with middleware simplification.
- Story 21.3 established patterns for BigInt-to-string conversion and `satisfies` type constraints.
- No direct code overlap — Epic 21 was connector Admin API, Epic 22 is agent-runtime middleware.
- Agent-runtime package is independent from the connector package changes in Epic 21.

### Fulfillment Model Change

**Current (STREAM HMAC-based — being replaced):**

```
hmac_key = HMAC-SHA256(shared_secret, "ilp_stream_fulfillment")
fulfillment = HMAC-SHA256(hmac_key, prepare.data)
condition = SHA256(fulfillment)
```

Requires a `shared_secret` from a pre-existing `PaymentSession` created via SPSP.

**New (SHA256(data) — implementing):**

```
fulfillment = SHA256(data)
condition = SHA256(fulfillment) = SHA256(SHA256(data))
```

No shared secret needed. Fulfillment is deterministic from the packet data alone.

**Compatibility:** The outbound sender (`ilp-send-handler.ts:46-50`) already uses this model:

```typescript
// packages/agent-runtime/src/http/ilp-send-handler.ts (computeConditionFromData)
const fulfillment = crypto.createHash('sha256').update(data).digest();
const condition = crypto.createHash('sha256').update(fulfillment).digest();
```

The inbound handler (PacketHandler) must now use the matching fulfillment computation.

### Data Models

**PaymentRequest** [Source: packages/agent-runtime/src/types/index.ts:33-46]:

```typescript
export interface PaymentRequest {
  paymentId: string;
  destination: string;
  amount: string;
  expiresAt: string;
  data?: string; // base64-encoded TOON data
  metadata?: Record<string, string>; // Will become always-undefined (session metadata gone)
}
```

**LocalDeliveryRequest** [Source: packages/agent-runtime/src/types/index.ts:70-83]:

```typescript
export interface LocalDeliveryRequest {
  destination: string;
  amount: string;
  executionCondition: string; // base64-encoded 32-byte hash
  expiresAt: string; // ISO 8601
  data: string; // base64-encoded
  sourcePeer: string;
}
```

**LocalDeliveryResponse** [Source: packages/agent-runtime/src/types/index.ts:89-106]:

```typescript
export interface LocalDeliveryResponse {
  fulfill?: {
    fulfillment: string; // base64-encoded 32-byte value
    data?: string; // BLS response data (pass-through)
  };
  reject?: {
    code: string;
    message: string;
    data?: string; // BLS response data (pass-through — NEW in this story)
  };
}
```

**PaymentResponse** (from BLS) [Source: packages/agent-runtime/src/types/index.ts:52-64]:

```typescript
export interface PaymentResponse {
  accept: boolean;
  data?: string; // Response data to include in fulfill/reject
  rejectReason?: {
    code: string;
    message: string;
  };
}
```

### Current PacketHandler Flow (Being Modified)

[Source: packages/agent-runtime/src/packet/packet-handler.ts]

**Current flow (lines 53-123):**

1. Look up session: `this.sessionManager.getSessionByAddress(destination)` → reject F02 if not found
2. Decode data and condition from base64
3. Verify condition: `verifyCondition(session.sharedSecret, prepareData, condition)` → reject F01 if mismatch
4. Check expiry: `expiresAt < now` → reject R00
5. Build `PaymentRequest` with `session.paymentId` and `session.metadata`
6. Call `this.businessClient.handlePayment(paymentRequest)`
7. On accept: `fulfillment = computeFulfillment(session.sharedSecret, prepareData)` → return FULFILL
8. On reject: return REJECT with mapped code (but **no** BLS data pass-through — bug/gap)

**New flow (to implement):**

1. Check expiry: `expiresAt < now` → reject R00
2. Generate deterministic `paymentId` (e.g., `generatePaymentId()` or derive from packet)
3. Build `PaymentRequest` directly from `LocalDeliveryRequest` fields (no session metadata)
4. Call `this.businessClient.handlePayment(paymentRequest)`
5. On accept: `fulfillment = SHA256(Buffer.from(request.data, 'base64'))` → return FULFILL with BLS `data`
6. On reject: return REJECT with mapped code **and** BLS `data` field (new pass-through)

**Key differences:**

- No SessionManager dependency
- No condition verification (connector handles this)
- No session lookup (accepts any destination under base address)
- Fulfillment is `SHA256(data)` not `HMAC-SHA256(hmac_key, data)`
- BLS `data` passed through on **both** accept and reject responses

### Current fulfillment.ts Functions (Being Modified)

[Source: packages/agent-runtime/src/stream/fulfillment.ts]

**Functions to REMOVE:**

- `deriveFulfillmentKey(sharedSecret)` — HMAC key derivation (line 24)
- `computeFulfillment(sharedSecret, prepareData)` — HMAC-based fulfillment (line 39)
- `computeCondition(fulfillment)` — SHA256 hash (line 52) — can be kept or removed (not used by new flow)
- `computeExpectedCondition(sharedSecret, prepareData)` — convenience wrapper (line 65)
- `verifyCondition(sharedSecret, prepareData, condition)` — condition check (line 80)
- `generateSharedSecret()` — random secret generation (line 96)

**Functions to KEEP:**

- `generatePaymentId(length?)` — still useful for ID generation (line 108)

**Function to ADD:**

- `computeFulfillmentFromData(data: Buffer): Buffer` — returns `SHA256(data)`

### BLS Data Pass-Through on Reject (New Behavior)

Currently, the reject path in `PacketHandler.handlePacket()` (lines 110-122) does NOT include the BLS `data` field in the reject response. The `reject()` helper method (lines 133-141) has an optional `data` parameter but it's never passed from the BLS response.

**Fix:** When BLS returns `{ accept: false, data: '...', rejectReason: {...} }`, pass `response.data` to the reject response so the connector can relay application-level rejection data.

### File Locations

| Action        | File Path                                                    | Description                                                                                  |
| ------------- | ------------------------------------------------------------ | -------------------------------------------------------------------------------------------- |
| **Modify**    | `packages/agent-runtime/src/packet/packet-handler.ts`        | Remove SessionManager dependency, use SHA256(data) fulfillment, add reject data pass-through |
| **Modify**    | `packages/agent-runtime/src/stream/fulfillment.ts`           | Replace STREAM functions with `computeFulfillmentFromData`, keep `generatePaymentId`         |
| **Modify**    | `packages/agent-runtime/src/stream/fulfillment.test.ts`      | Replace STREAM tests with SHA256(data) tests, keep `generatePaymentId` tests                 |
| **Delete**    | `packages/agent-runtime/src/session/session-manager.test.ts` | Remove session manager tests (SessionManager class deleted in Story 22.2)                    |
| **Create**    | `packages/agent-runtime/src/packet/packet-handler.test.ts`   | New unit tests for simplified PacketHandler                                                  |
| **Reference** | `packages/agent-runtime/src/http/ilp-send-handler.ts`        | Verify outbound `computeConditionFromData` is compatible                                     |
| **Reference** | `packages/agent-runtime/src/types/index.ts`                  | PaymentRequest, LocalDeliveryRequest, LocalDeliveryResponse types                            |
| **Modify**    | `packages/agent-runtime/src/agent-runtime.ts`                | Update PacketHandler constructor call (line 92-99) to remove SessionManager parameter        |
| **Modify**    | `packages/agent-runtime/src/index.ts`                        | Update fulfillment exports: remove deleted functions, add `computeFulfillmentFromData`       |
| **Modify**    | `packages/agent-runtime/src/session/session-manager.ts`      | Remove `generateSharedSecret` from import (line 10) — class still needed until Story 22.2    |
| **Reference** | `packages/agent-runtime/src/business/business-client.ts`     | BusinessClient.handlePayment() and mapRejectCode()                                           |

### Technical Constraints

- **No `any` types**: TypeScript strict mode enforced [Source: docs/architecture/coding-standards.md]
- **Pino logger only**: Never use `console.log` [Source: docs/architecture/coding-standards.md]
- **All async functions must handle errors**: Use try-catch [Source: docs/architecture/coding-standards.md]
- **Use `Buffer` for binary data**: Not `Uint8Array` [Source: docs/architecture/coding-standards.md]
- **Backward compatibility**: `LocalDeliveryRequest` and `LocalDeliveryResponse` interfaces unchanged. BLS `PaymentRequest` interface preserved (same fields: paymentId, destination, amount, expiresAt, data). The `metadata` field becomes always-undefined but is not removed from the interface (backward compat with BLS).
- **Outbound compatibility**: The outbound sender (`ilp-send-handler.ts`) already uses `SHA256(SHA256(data))` for condition computation. The new inbound fulfillment `SHA256(data)` must match, i.e., `SHA256(fulfillment) == condition`. This is verified by comparing with `computeConditionFromData` from `ilp-send-handler.ts`.
- **SessionManager NOT deleted in this story**: Story 22.1 only removes PacketHandler's dependency on SessionManager. The SessionManager class itself and the SPSP server are deleted in Story 22.2. The `session-manager.test.ts` file IS removed in this story because the tests cover functionality that is no longer called by any production code path after this change.

### Testing

**Framework:** Jest 29.7.x with ts-jest [Source: docs/architecture/test-strategy-and-standards.md]

**File Convention:** Co-located `*.test.ts` next to source [Source: docs/architecture/coding-standards.md]

**Coverage Requirement:** >80% line coverage for agent-runtime package [Source: docs/architecture/test-strategy-and-standards.md]

**Test Pattern:** AAA (Arrange, Act, Assert) with descriptive names [Source: docs/architecture/test-strategy-and-standards.md]

**New Test File:** `packages/agent-runtime/src/packet/packet-handler.test.ts`

**Modified Test File:** `packages/agent-runtime/src/stream/fulfillment.test.ts`

**Deleted Test File:** `packages/agent-runtime/src/session/session-manager.test.ts`

**Mock Strategy:**

- Mock `BusinessClient` with `handlePayment` returning accept/reject responses
- Mock `Logger` (Pino child logger pattern)
- Use real `crypto` module (no mocking — SHA256 is deterministic)
- Create fresh mock instances in `beforeEach()` [Source: docs/architecture/test-strategy-and-standards.md, Anti-Pattern 3]

**Key Test Scenarios for `packet-handler.test.ts`:**

- Packet with valid data → BLS accept → FULFILL with SHA256(data) fulfillment and BLS data
- Packet with valid data → BLS reject → REJECT with mapped code and BLS data pass-through
- Expired packet → R00 reject (no BLS call)
- SHA256(fulfillment) matches SHA256(SHA256(data)) — cross-verify with `computeConditionFromData`
- Empty string data → computes SHA256 of empty buffer, passes `undefined` to BLS `PaymentRequest.data`
- Any destination starting with `config.baseAddress` accepted (no session lookup)

**Key Test Scenarios for `fulfillment.test.ts` (updated):**

- `computeFulfillmentFromData` returns 32-byte SHA256 hash
- Deterministic — same input produces same output
- Different inputs produce different outputs
- Cross-verify: `SHA256(computeFulfillmentFromData(data)) == computeConditionFromData(data).condition`
- `generatePaymentId` tests retained (unchanged)

**Regression Check:**

- `ilp-send-handler.test.ts` — must still pass (unchanged)
- `outbound-btp-client.test.ts` — must still pass (unchanged)
- `btp-protocol.test.ts` — must still pass (unchanged)

## Tasks / Subtasks

### 1. Modify `fulfillment.ts` — Replace STREAM Functions with SHA256(data) (AC: 3, 4, 7)

- [x] Remove `FULFILLMENT_DERIVATION_STRING` constant
- [x] Remove `deriveFulfillmentKey(sharedSecret)` function
- [x] Remove `computeFulfillment(sharedSecret, prepareData)` function
- [x] Remove `computeCondition(fulfillment)` function
- [x] Remove `computeExpectedCondition(sharedSecret, prepareData)` function
- [x] Remove `verifyCondition(sharedSecret, prepareData, condition)` function
- [x] Remove `generateSharedSecret()` function
- [x] Add `computeFulfillmentFromData(data: Buffer): Buffer` — returns `crypto.createHash('sha256').update(data).digest()`
- [x] Keep `generatePaymentId(length?)` function unchanged
- [x] Update module JSDoc to reflect simplified fulfillment model (remove STREAM references)
- [x] Update `src/index.ts` (lines 52-61): replace removed function exports with `computeFulfillmentFromData` export, keep `generatePaymentId` export
- [x] Update `src/session/session-manager.ts` (line 10): remove `generateSharedSecret` from import (keep `generatePaymentId` — SessionManager class itself is deleted in Story 22.2 but must still compile)

### 2. Modify `packet-handler.ts` — Remove SessionManager, Use SHA256(data) (AC: 1, 2, 3, 5, 6)

- [x] Remove `import { SessionManager }` from imports
- [x] Remove `import { computeFulfillment, verifyCondition }` — replace with `import { computeFulfillmentFromData, generatePaymentId }`
- [x] Remove `sessionManager` field and constructor parameter
- [x] Update constructor signature: `constructor(config, businessClient, logger)` (3 params instead of 4)
- [x] In `handlePacket()`:
  - [x] Remove session lookup (`this.sessionManager.getSessionByAddress(destination)`) and F02 reject
  - [x] Remove condition verification (`verifyCondition(...)`) and F01 reject
  - [x] Move expiry check to the top of the method (before any other processing)
  - [x] Generate `paymentId` using `generatePaymentId()`
  - [x] Build `PaymentRequest` directly: `{ paymentId, destination, amount, expiresAt, data: data || undefined }`
  - [x] On accept: compute `fulfillment = computeFulfillmentFromData(Buffer.from(request.data, 'base64'))`, include `response.data` in fulfill
  - [x] On reject: include `response.data` in reject response (pass to `this.reject(ilpCode, message, response.data)`)
- [x] Update class and method JSDoc to reflect simplified flow
- [x] Update `PacketHandler` constructor call in `agent-runtime.ts` (line 92-99) to remove `sessionManager` parameter — keeps build green (Option A from Compilation Note)

**Note on `data` field:** `LocalDeliveryRequest.data` is typed as `string` (required, not optional), so it will always be present from the connector. The `PaymentRequest.data` field is optional (`data?: string`), so pass `data || undefined` to coerce empty strings to undefined for the BLS interface.

### 3. Update `fulfillment.test.ts` — SHA256-based Tests (AC: 7)

- [x] Remove all `generateSharedSecret` tests
- [x] Remove all `deriveFulfillmentKey` tests
- [x] Remove all `computeFulfillment` tests (HMAC-based)
- [x] Remove all `computeCondition` tests
- [x] Remove all `computeExpectedCondition` tests
- [x] Remove all `verifyCondition` tests
- [x] Add `describe('computeFulfillmentFromData', ...)`:
  - [x] Test: returns 32-byte Buffer
  - [x] Test: deterministic — same input → same output
  - [x] Test: different inputs → different outputs
  - [x] Test: matches manual SHA256 computation
  - [x] Test: cross-verify with `computeConditionFromData` from `ilp-send-handler.ts` — `SHA256(computeFulfillmentFromData(data))` equals `computeConditionFromData(data).condition`
  - [x] Test: empty buffer input produces valid hash
- [x] Keep `describe('generatePaymentId', ...)` tests unchanged

### 4. Create `packet-handler.test.ts` — New Unit Tests (AC: 1, 2, 3, 5, 6)

- [x] Create `packages/agent-runtime/src/packet/packet-handler.test.ts`
- [x] Mock `BusinessClient` with `handlePayment` and `mapRejectCode`
- [x] Mock `Logger` (Pino `child` method returning mock)
- [x] Test: constructor takes `(config, businessClient, logger)` — no SessionManager
- [x] Test: valid packet accepted by BLS → FULFILL response with SHA256(data) fulfillment
- [x] Test: fulfillment is base64-encoded SHA256 of decoded data
- [x] Test: BLS `data` field included in FULFILL response
- [x] Test: BLS reject → REJECT response with mapped ILP error code
- [x] Test: BLS reject with `data` field → REJECT response includes data (AC: 5)
- [x] Test: expired packet → R00 reject without calling BLS
- [x] Test: packet with empty string `data` field → computes SHA256 of empty buffer, passes `undefined` to BLS `PaymentRequest.data`
- [x] Test: any destination starting with `config.baseAddress` is accepted (no session lookup, AC: 2)
- [x] Test: cross-verify fulfillment matches outbound condition — import `computeConditionFromData` from `ilp-send-handler.ts`, verify `SHA256(fulfillment) == condition`
- [x] Use fresh mock instances in `beforeEach()` [Source: docs/architecture/test-strategy-and-standards.md]

### 5. Delete `session-manager.test.ts` (AC: 8)

- [x] Delete `packages/agent-runtime/src/session/session-manager.test.ts`
- [x] Note: SessionManager class itself is NOT deleted until Story 22.2

### 6. Verify No Regressions (AC: 9)

- [x] Run agent-runtime tests: `cd packages/agent-runtime && npm test`
- [x] Verify `ilp-send-handler.test.ts` still passes (unchanged)
- [x] Verify `outbound-btp-client.test.ts` still passes (unchanged)
- [x] Verify `btp-protocol.test.ts` still passes (unchanged)
- [x] TypeScript compiles clean: `npx tsc -p packages/agent-runtime/tsconfig.json --noEmit`
- [x] Verify `agent-runtime.ts` compiles without errors (PacketHandler constructor call updated)
- [x] No import errors from removed functions (check that no other files import removed fulfillment functions)

## Estimated Complexity

**Size: Small-Medium (S/M)** — 6 files modified, 1 file created, 1 file deleted. Core logic change is straightforward (replace HMAC chain with single SHA256). Primary risk is ensuring all consumers of removed fulfillment functions are updated (`packet-handler.ts`, `index.ts`, `session-manager.ts`).

## Project Structure Notes

- All changes are within the **agent-runtime** package (`packages/agent-runtime/`)
- No cross-package dependencies affected — the connector package does not import from agent-runtime's fulfillment module
- The outbound `computeConditionFromData` in `ilp-send-handler.ts` is NOT modified — it already uses the compatible `SHA256(SHA256(data))` model
- Story 22.2 will complete the cleanup by deleting `session-manager.ts`, `spsp-server.ts`, and their references in `http-server.ts` and `agent-runtime.ts`
- The `PacketHandler` constructor call in `agent-runtime.ts` (line 92-99) is updated in this story (Task 2) to remove the `sessionManager` parameter, keeping the build green

### Files Changed Summary

| File                                                         | Action | Lines Changed (est.)                         |
| ------------------------------------------------------------ | ------ | -------------------------------------------- |
| `packages/agent-runtime/src/stream/fulfillment.ts`           | Modify | ~80 removed, ~10 added                       |
| `packages/agent-runtime/src/packet/packet-handler.ts`        | Modify | ~50 removed/rewritten                        |
| `packages/agent-runtime/src/agent-runtime.ts`                | Modify | ~2 lines (constructor call)                  |
| `packages/agent-runtime/src/index.ts`                        | Modify | ~8 lines (export updates)                    |
| `packages/agent-runtime/src/session/session-manager.ts`      | Modify | ~1 line (remove generateSharedSecret import) |
| `packages/agent-runtime/src/stream/fulfillment.test.ts`      | Modify | ~100 removed, ~40 added                      |
| `packages/agent-runtime/src/packet/packet-handler.test.ts`   | Create | ~120 new                                     |
| `packages/agent-runtime/src/session/session-manager.test.ts` | Delete | ~236 removed                                 |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug issues encountered.

### Completion Notes

- Replaced STREAM HMAC-based fulfillment with stateless SHA256(data) fulfillment
- Removed 6 STREAM-specific functions from fulfillment.ts, added computeFulfillmentFromData
- PacketHandler constructor reduced from 4 params to 3 (SessionManager removed)
- BLS data pass-through added on both FULFILL and REJECT responses
- Error handling added with try-catch around BLS call (returns T00 on error)
- session-manager.ts updated to use inline crypto.randomBytes(32) instead of generateSharedSecret
- All 91 tests pass (5 suites), TypeScript compiles clean

### File List

| File                                                         | Action                                                                                |
| ------------------------------------------------------------ | ------------------------------------------------------------------------------------- |
| `packages/agent-runtime/src/stream/fulfillment.ts`           | Modified — replaced STREAM functions with computeFulfillmentFromData                  |
| `packages/agent-runtime/src/packet/packet-handler.ts`        | Modified — removed SessionManager, SHA256(data) fulfillment, reject data pass-through |
| `packages/agent-runtime/src/agent-runtime.ts`                | Modified — removed sessionManager from PacketHandler constructor call                 |
| `packages/agent-runtime/src/index.ts`                        | Modified — updated fulfillment exports                                                |
| `packages/agent-runtime/src/session/session-manager.ts`      | Modified — replaced generateSharedSecret import with inline crypto.randomBytes        |
| `packages/agent-runtime/src/stream/fulfillment.test.ts`      | Modified — replaced STREAM tests with SHA256(data) tests                              |
| `packages/agent-runtime/src/packet/packet-handler.test.ts`   | Created — new unit tests for simplified PacketHandler                                 |
| `packages/agent-runtime/src/session/session-manager.test.ts` | Deleted                                                                               |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent.** The implementation is clean, well-structured, and accurately reflects the story requirements. The STREAM HMAC-based fulfillment chain has been replaced with a single `SHA256(data)` computation, and the `PacketHandler` is now stateless — no session lookup, no condition verification, and no `SessionManager` dependency. The code reads clearly and follows established project patterns.

**Strengths:**

- `fulfillment.ts` reduced from ~110 lines (7 functions) to ~41 lines (2 functions) — clean, focused module
- `packet-handler.ts` flow is well-commented with numbered steps matching the story spec
- Error handling is comprehensive: expiry check, BLS call try-catch with T00 fallback, and F99 default for missing `rejectReason`
- BLS `data` field correctly passed through on both FULFILL and REJECT paths (previously missing on reject)
- Cross-verification tests between `computeFulfillmentFromData` and `computeConditionFromData` confirm fulfillment model correctness
- `session-manager.ts` updated to use inline `crypto.randomBytes(32)` instead of the removed `generateSharedSecret`, keeping it compilable for Story 22.2

**Observations (no action needed — informational):**

- `agent-runtime.ts` still instantiates `SessionManager` and `SPSPServer` (correct — Story 22.2 removes them)
- `index.ts` still exports `SessionManager`, `SPSPServer`, and SPSP types (correct — Story 22.3 cleans these up)
- The `executionCondition` field from `LocalDeliveryRequest` is received but not used — the story deliberately skips condition verification since the connector performs this check. This is documented in the Dev Notes and is correct per the Epic 22 architecture.

### Refactoring Performed

None — implementation quality is high and no refactoring is warranted.

### Compliance Check

- Coding Standards: ✓ — No `console.log`, Pino logger used throughout, `Buffer` for binary data, strict TypeScript types, camelCase methods, PascalCase classes, UPPER_SNAKE_CASE avoided where not needed
- Project Structure: ✓ — Tests co-located (`packet-handler.test.ts` next to `packet-handler.ts`, `fulfillment.test.ts` next to `fulfillment.ts`), kebab-case filenames
- Testing Strategy: ✓ — AAA pattern, fresh mocks in `beforeEach()`, real crypto (no mocking), descriptive test names, cross-verification with outbound sender
- All ACs Met: ✓ — See traceability below

### AC Traceability

| AC  | Description                                              | Validated By                                                                                                                                           | Status |
| --- | -------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ | ------ |
| 1   | PacketHandler constructor no longer takes SessionManager | `packet-handler.ts:31` — 3 params `(config, businessClient, logger)`, `packet-handler.test.ts:54-57`                                                   | ✓      |
| 2   | Any packet under base address forwarded to BLS           | `packet-handler.ts:49-104` — no address filtering beyond expiry check, `packet-handler.test.ts:154-170` tests multiple destinations                    | ✓      |
| 3   | Fulfillment = SHA256(base64decode(data))                 | `packet-handler.ts:79`, `fulfillment.ts:27`, `packet-handler.test.ts:61-75`, `fulfillment.test.ts:13-68`                                               | ✓      |
| 4   | SHA256(fulfillment) == SHA256(SHA256(data))              | `fulfillment.test.ts:47-56` cross-verify, `packet-handler.test.ts:172-191` cross-verify with outbound sender                                           | ✓      |
| 5   | BLS data in both FULFILL and REJECT                      | `packet-handler.ts:86` (fulfill), `packet-handler.ts:98` (reject), `packet-handler.test.ts:77-85` (fulfill), `packet-handler.test.ts:105-119` (reject) | ✓      |
| 6   | Expiry check retained                                    | `packet-handler.ts:55-59`, `packet-handler.test.ts:121-132`                                                                                            | ✓      |
| 7   | fulfillment.test.ts updated                              | 8 tests: 6 for `computeFulfillmentFromData`, 2 for `generatePaymentId`                                                                                 | ✓      |
| 8   | session-manager.test.ts removed                          | File deleted (confirmed by glob + git diff: -236 lines)                                                                                                | ✓      |
| 9   | No regression in outbound tests                          | `ilp-send-handler.test.ts` passes, `outbound-btp-client.test.ts` passes, `btp-protocol.test.ts` passes — 91/91 tests                                   | ✓      |

### Improvements Checklist

All items are advisory — no blockers.

- [x] All acceptance criteria verified with test coverage
- [x] TypeScript compiles clean (no errors)
- [x] No remaining imports of removed fulfillment functions (verified via grep)
- [x] Cross-verification tests ensure inbound/outbound fulfillment model compatibility
- [ ] (Future/Story 22.2) Remove SessionManager and SPSPServer from agent-runtime.ts
- [ ] (Future/Story 22.3) Remove SPSP/STREAM types from types/index.ts and index.ts exports

### Security Review

**Status: PASS** — No security concerns.

- The fulfillment model change from HMAC-SHA256 to SHA256(data) is intentional and documented. The shared secret is no longer needed because the BLS (agent-society) owns SPSP via Nostr.
- Fulfillment is deterministic from packet data, which is the designed behavior — anyone who knows the data can compute the fulfillment. This is acceptable because the BLS controls accept/reject decisions and the connector verifies `SHA256(fulfillment) == condition`.
- Error handling includes try-catch around BLS calls (returns T00), preventing unhandled promise rejections.
- No sensitive data exposed in log messages (paymentId and amount logged, no raw data).

### Performance Considerations

**Status: PASS** — Performance is improved.

- Removed session lookup (`Map.get()` + address parsing) from the hot path
- Removed condition verification (SHA256 comparison) — connector handles this
- Single `SHA256(data)` computation per packet (was: 2x HMAC-SHA256 + 1x SHA256)
- No timer-based session cleanup overhead in PacketHandler path

### Files Modified During Review

None — no files were modified during this review.

### Gate Status

Gate: **PASS** → `docs/qa/gates/22.1-simplify-packethandler-sha256-fulfillment.yml`

### Recommended Status

✓ **Ready for Done** — All 9 acceptance criteria are met with test coverage. All 91 tests pass, TypeScript compiles clean, no regressions detected. Implementation quality is high with clean separation of concerns.

## Change Log

| Date       | Version | Description                                                                                                                                                                                                                               | Author               |
| ---------- | ------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------- |
| 2026-02-09 | 1.0     | Initial story draft created from Epic 22                                                                                                                                                                                                  | Claude Opus 4.6 (SM) |
| 2026-02-09 | 1.1     | Validation fixes: added agent-runtime.ts update subtask, fixed test file name (outbound-btp-client), tightened AC 2 destination check, clarified empty data handling, added complexity estimate, files changed summary, template sections | Claude Opus 4.6 (SM) |
| 2026-02-09 | 1.2     | Critical fix: added index.ts export updates and session-manager.ts import fix to Task 1 — removed fulfillment functions are exported from index.ts and imported by session-manager.ts, both must be updated to keep build green           | Claude Opus 4.6 (SM) |
