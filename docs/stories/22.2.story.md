# Story 22.2: Remove SPSP Server and Session Manager

**Epic:** 22 - Agent-Runtime Middleware Simplification
**Story Number:** 22.2
**Status:** Done

## Story

**As a** developer,
**I want** SPSP HTTP endpoints and session management removed from agent-runtime,
**so that** the middleware is a clean forwarder without dead code from the STREAM/SPSP protocol layer.

## Acceptance Criteria

1. `src/session/` directory removed (or empty)
2. `src/spsp/` directory removed (or empty)
3. No imports of `SessionManager` or `SPSPServer` anywhere in `packages/agent-runtime/src/`
4. `GET /.well-known/pay` and `GET /pay` return 404 (caught by existing 404 handler)
5. `GET /health` no longer includes `activeSessions` field
6. `AgentRuntime` constructor no longer creates SessionManager or SPSPServer
7. `AgentRuntime.stop()` no longer calls `sessionManager.shutdown()`
8. TypeScript compilation succeeds with no errors
9. All remaining tests pass

## Dev Notes

### Previous Story Insights (Story 22.1)

- Story 22.1 replaced STREAM HMAC-based fulfillment with stateless `SHA256(data)` fulfillment
- `PacketHandler` constructor was reduced from 4 params to 3 (SessionManager removed)
- `session-manager.test.ts` was already deleted in Story 22.1
- `session-manager.ts` was modified to use inline `crypto.randomBytes(32)` instead of `generateSharedSecret` (which was removed from `fulfillment.ts`)
- `index.ts` still exports `SessionManager`, `SPSPServer`, and SPSP types — these will need updating in this story (export removal) and Story 22.3 (type removal)
- All 91 tests pass as of Story 22.1 completion

### Files to Delete

**`src/session/session-manager.ts`** (207 lines) [Source: packages/agent-runtime/src/session/session-manager.ts]

- In-memory session storage with TTL expiration and periodic cleanup
- `SessionManager` class with methods: `createSession`, `getSession`, `getSessionByAddress`, `deleteSession`, `updateSessionMetadata`, `sessionCount`, `cleanupExpiredSessions`, `shutdown`
- `SessionManagerConfig` interface with `baseAddress`, `sessionTtlMs`, `cleanupIntervalMs`
- No longer called by any production code path after Story 22.1 (PacketHandler no longer uses it)
- Still referenced by: `spsp-server.ts` (being deleted), `http-server.ts` (being modified), `agent-runtime.ts` (being modified), `index.ts` (being modified)

**`src/spsp/spsp-server.ts`** (139 lines) [Source: packages/agent-runtime/src/spsp/spsp-server.ts]

- SPSP endpoint handler implementing RFC-0009 endpoints (`GET /.well-known/pay/:paymentId?`, `GET /pay/:paymentId?`)
- `SPSPServer` class with `getRouter()` and `handleSPSPQuery()` methods
- `SPSPServerConfig` interface with `enabled` field
- Depends on: `SessionManager`, `BusinessClient`, SPSP types from `../types`
- Agent-society now handles SPSP via Nostr events (kind:23194/23195) — these HTTP endpoints are dead code
- Referenced by: `http-server.ts` (being modified), `agent-runtime.ts` (being modified), `index.ts` (being modified)

### Files to Modify

**`src/http/http-server.ts`** [Source: packages/agent-runtime/src/http/http-server.ts]

- **Remove line 13:** `import { SPSPServer } from '../spsp/spsp-server';`
- **Remove line 15:** `import { SessionManager } from '../session/session-manager';`
- **Remove line 32:** `private readonly spspServer: SPSPServer;` field
- **Remove line 34:** `private readonly sessionManager: SessionManager;` field
- **Update constructor (lines 39-57):** Remove `spspServer: SPSPServer` and `sessionManager: SessionManager` parameters. New signature: `constructor(config, packetHandler, logger, sender?)`
- **Update health endpoint (lines 78-86):** Remove `activeSessions: this.sessionManager.sessionCount` from health response. Simplified health: `{ status, nodeId, btpConnected, timestamp }`
- **Remove line 127:** `this.app.use(this.spspServer.getRouter());` — SPSP route mount
- **Update module JSDoc** to remove references to SPSP endpoints

**`src/agent-runtime.ts`** [Source: packages/agent-runtime/src/agent-runtime.ts]

- **Remove line 13:** `import { SessionManager } from './session/session-manager';`
- **Remove line 14:** `import { SPSPServer } from './spsp/spsp-server';`
- **Remove line 46:** `private readonly sessionManager: SessionManager;` field
- **Remove line 48:** `private readonly spspServer: SPSPServer;` field
- **Remove lines 67-73:** `SessionManager` instantiation
- **Remove lines 83-90:** `SPSPServer` instantiation
- **Update `HttpServer` constructor call (lines 102-112):** Remove `spspServer` and `sessionManager` arguments. New call: `new HttpServer(config, packetHandler, logger, sender)`
- **Remove lines 139-146:** `spspEnabled` from start() log message
- **Remove line 170:** `this.sessionManager.shutdown()` from `stop()`
- **Remove lines 178-181:** `getSessionManager()` public method
- **Keep lines 213-214 in `resolveConfig()`:** `spspEnabled` and `sessionTtlMs` must remain populated with defaults — `ResolvedAgentRuntimeConfig` still requires these fields. Nothing reads them; interface cleanup deferred to Story 22.3
- **Remove lines 229-230:** `spspEnabled` and `sessionTtlMs` from `sanitizeConfig()`
- **Remove `spspEnabled` and `sessionTtlMs` from `startFromEnv()`** (lines 261, 262-264)
- **Remove `SPSP_ENABLED` and `SESSION_TTL_MS` env var handling** from startFromEnv()
- **Update class and method JSDoc** to reflect simplified middleware role (remove SPSP/session references)

**`src/index.ts`** [Source: packages/agent-runtime/src/index.ts]

- **Remove line 16:** `PaymentSession,` from type exports
- **Remove lines 22-25:** `SPSPResponse`, `PaymentSetupRequest`, `PaymentSetupResponse` from type exports
- **Remove line 46:** `export { SessionManager, SessionManagerConfig } from './session/session-manager';`
- **Remove line 49:** `export { SPSPServer, SPSPServerConfig } from './spsp/spsp-server';`
- **Update module JSDoc** to reflect simplified middleware (remove SPSP/STREAM references)

### Data Models

**Health endpoint response (simplified)** [Source: packages/agent-runtime/src/http/http-server.ts:78-86]:

```typescript
// Before (current):
{ status: 'healthy', nodeId: string, activeSessions: number, btpConnected: boolean, timestamp: string }

// After (this story):
{ status: 'healthy', nodeId: string, btpConnected: boolean, timestamp: string }
```

**HttpServer constructor (simplified)**:

```typescript
// Before (current):
constructor(config, spspServer, packetHandler, sessionManager, logger, sender?)

// After (this story):
constructor(config, packetHandler, logger, sender?)
```

**AgentRuntime constructor** — no public API change (internal-only simplification). The `AgentRuntimeConfig` interface changes (removal of `spspEnabled`, `sessionTtlMs`) are deferred to Story 22.3 for type cleanup.

### API Specifications

**Removed SPSP endpoints:**

- `GET /.well-known/pay/:paymentId?` — will return 404 via existing 404 handler
- `GET /pay/:paymentId?` — will return 404 via existing 404 handler

**Retained endpoints (unchanged):**

- `POST /ilp/packets` — inbound ILP packet handling (uses PacketHandler)
- `POST /ilp/send` — outbound ILP send (uses IlpSendHandler, Epic 20)
- `GET /health` — health check (simplified, removes `activeSessions`)
- `GET /ready` — readiness check (unchanged)

### Technical Constraints

- **No `any` types**: TypeScript strict mode enforced [Source: docs/architecture/coding-standards.md]
- **Pino logger only**: Never use `console.log` [Source: docs/architecture/coding-standards.md]
- **Backward compatibility**: The `AgentRuntimeConfig` and `ResolvedAgentRuntimeConfig` interfaces still include `spspEnabled` and `sessionTtlMs` fields (removed in Story 22.3). `resolveConfig()` must continue populating these fields with defaults to satisfy the type contract. `startFromEnv()` replaces env var parsing with hardcoded placeholder values. `sanitizeConfig()` stops logging them. Nothing reads or uses these values. This ensures no downstream type breakage until Story 22.3 explicitly cleans up types.
- **No SPSP type removal in this story**: `PaymentSession`, `SPSPResponse`, `PaymentSetupRequest`, `PaymentSetupResponse` interfaces remain in `types/index.ts` until Story 22.3. Only the _exports from `index.ts`_ (package entry point) and the _class exports_ (`SessionManager`, `SPSPServer`) are removed.
- **`businessClient.paymentSetup()` not removed**: The `paymentSetup()` method on `BusinessClient` remains (removed in Story 22.3 if applicable). It's just no longer called.

### Testing

**Framework:** Jest 29.7.x with ts-jest [Source: docs/architecture/test-strategy-and-standards.md]

**File Convention:** Co-located `*.test.ts` next to source [Source: docs/architecture/coding-standards.md]

**Coverage Requirement:** >80% line coverage (project-wide standard; architecture docs specify >80% for connector, >90% for shared — agent-runtime follows the >80% baseline)

**Test Pattern:** AAA (Arrange, Act, Assert) with descriptive names [Source: docs/architecture/test-strategy-and-standards.md]

**No new test files needed** — this story is primarily deletion and simplification. The key verification is:

1. Existing tests still pass after file deletions and constructor changes
2. TypeScript compiles clean with no import errors
3. No remaining references to deleted modules

**Existing test files to verify (must still pass):**

- `packages/agent-runtime/src/packet/packet-handler.test.ts` (created in Story 22.1)
- `packages/agent-runtime/src/stream/fulfillment.test.ts` (updated in Story 22.1)
- `packages/agent-runtime/src/http/ilp-send-handler.test.ts` (unchanged)
- `packages/agent-runtime/src/btp/outbound-btp-client.test.ts` (unchanged)
- `packages/agent-runtime/src/btp/btp-protocol.test.ts` (unchanged)

**Deleted test files:**

- `packages/agent-runtime/src/session/session-manager.test.ts` — already deleted in Story 22.1

**No SPSP test file exists** — `spsp-server.ts` has no co-located test file to delete.

**Verification approach:**

- Run `npx tsc -p packages/agent-runtime/tsconfig.json --noEmit` to verify compilation
- Run `cd packages/agent-runtime && npm test` to verify all tests pass
- Grep for remaining references: `grep -r "SessionManager\|SPSPServer\|session-manager\|spsp-server" packages/agent-runtime/src/`

## Tasks / Subtasks

> **Execution Order:** Tasks 3-5 (remove all imports and references) MUST be completed before Tasks 1-2 (file deletion). Deleting files while imports still reference them will cause immediate TypeScript compilation failures. Recommended order: **3 → 4 → 5 → 1 → 2 → 6 → 7**.

### 1. Delete `src/session/session-manager.ts` (AC: 1)

- [x] Delete file `packages/agent-runtime/src/session/session-manager.ts`
- [x] Verify `src/session/` directory is empty, then delete the directory
- [x] Note: `session-manager.test.ts` was already deleted in Story 22.1

### 2. Delete `src/spsp/spsp-server.ts` (AC: 2)

- [x] Delete file `packages/agent-runtime/src/spsp/spsp-server.ts`
- [x] Verify `src/spsp/` directory is empty, then delete the directory

### 3. Modify `src/http/http-server.ts` — Remove SPSP and SessionManager (AC: 3, 4, 5)

- [x] Remove `import { SPSPServer } from '../spsp/spsp-server';`
- [x] Remove `import { SessionManager } from '../session/session-manager';`
- [x] Remove `private readonly spspServer: SPSPServer;` field
- [x] Remove `private readonly sessionManager: SessionManager;` field
- [x] Update constructor signature: remove `spspServer` and `sessionManager` parameters. New: `constructor(config, packetHandler, logger, sender?)`
- [x] Remove `activeSessions: this.sessionManager.sessionCount` from health endpoint response
- [x] Remove `this.app.use(this.spspServer.getRouter());` SPSP route mount
- [x] Update module JSDoc: remove SPSP endpoint references from class and file-level docs

### 4. Modify `src/agent-runtime.ts` — Remove SessionManager/SPSPServer Initialization (AC: 3, 6, 7)

- [x] Remove `import { SessionManager } from './session/session-manager';`
- [x] Remove `import { SPSPServer } from './spsp/spsp-server';`
- [x] Remove `private readonly sessionManager: SessionManager;` field
- [x] Remove `private readonly spspServer: SPSPServer;` field
- [x] Remove `SessionManager` instantiation block (constructor)
- [x] Remove `SPSPServer` instantiation block (constructor)
- [x] Update `HttpServer` constructor call: remove `spspServer` and `sessionManager` arguments
- [x] Remove `spspEnabled` from `start()` log message
- [x] Remove `this.sessionManager.shutdown()` from `stop()` method
- [x] Remove `getSessionManager()` public method
- [x] In `resolveConfig()`: keep `spspEnabled` and `sessionTtlMs` populated with defaults (required by `ResolvedAgentRuntimeConfig` type contract) — nothing reads them anymore, but removing the lines would cause a TS error since the interface still declares these fields. Interface cleanup deferred to Story 22.3.
- [x] Remove `spspEnabled` and `sessionTtlMs` from `sanitizeConfig()` logging output (stop logging them)
- [x] In `startFromEnv()`: remove `spspEnabled: process.env['SPSP_ENABLED'] !== 'false'` line — replace with `spspEnabled: false` (hardcoded, field unused but required by type)
- [x] In `startFromEnv()`: remove `sessionTtlMs` env var parsing block — replace with `sessionTtlMs: 0` (hardcoded, field unused but required by type)
- [x] Update class JSDoc and `startFromEnv()` JSDoc: remove SPSP/session references and env var docs for `SPSP_ENABLED` and `SESSION_TTL_MS`

### 5. Modify `src/index.ts` — Remove Deleted Module Exports (AC: 3)

- [x] Remove `PaymentSession` from type exports (the interface stays in `types/index.ts` until Story 22.3, but is no longer re-exported from the package)
- [x] Remove `SPSPResponse`, `PaymentSetupRequest`, `PaymentSetupResponse` from type exports
- [x] Remove `export { SessionManager, SessionManagerConfig } from './session/session-manager';`
- [x] Remove `export { SPSPServer, SPSPServerConfig } from './spsp/spsp-server';`
- [x] Update module JSDoc: remove SPSP/STREAM references from package documentation

### 6. Verify TypeScript Compilation (AC: 8)

- [x] Run `npx tsc -p packages/agent-runtime/tsconfig.json --noEmit` — must succeed with no errors
- [x] Grep for remaining imports: `grep -r "SessionManager\|SPSPServer\|session-manager\|spsp-server" packages/agent-runtime/src/` — must return no `import` statements or code references. String literal mentions in test descriptions (e.g., `packet-handler.test.ts` line 54 has `"no SessionManager"` in a test name) are acceptable and should be ignored.
- [x] Verify no other packages in the monorepo import from deleted modules: `grep -r "session-manager\|spsp-server" packages/` (excluding `node_modules/`)

### 7. Verify All Tests Pass (AC: 9)

- [x] Run `cd packages/agent-runtime && npm test` — all tests must pass
- [x] Verify `packet-handler.test.ts` passes (Story 22.1 tests)
- [x] Verify `fulfillment.test.ts` passes (Story 22.1 tests)
- [x] Verify `ilp-send-handler.test.ts` passes (unchanged)
- [x] Verify `outbound-btp-client.test.ts` passes (unchanged, if exists)
- [x] Verify `btp-protocol.test.ts` passes (unchanged, if exists)

## Estimated Complexity

**Size: Small (S)** — Primarily file deletion and removing constructor parameters/imports. No new logic, no new functions, no new tests. The risk is purely compilation — ensuring all references to deleted files are removed and constructor signatures are updated consistently.

## Project Structure Notes

- All changes are within the **agent-runtime** package (`packages/agent-runtime/`)
- No cross-package dependencies affected — no other package imports `SessionManager` or `SPSPServer`
- The `src/session/` and `src/spsp/` directories will be completely removed
- Story 22.3 will complete the cleanup by removing SPSP/STREAM type interfaces from `types/index.ts` and cleaning up `AgentRuntimeConfig`
- The `businessClient.paymentSetup()` method remains in `business-client.ts` — it's just no longer called. Story 22.3 may remove it if warranted.

### Files Changed Summary

| File                                                    | Action | Lines Changed (est.)      |
| ------------------------------------------------------- | ------ | ------------------------- |
| `packages/agent-runtime/src/session/session-manager.ts` | Delete | ~207 removed              |
| `packages/agent-runtime/src/spsp/spsp-server.ts`        | Delete | ~139 removed              |
| `packages/agent-runtime/src/http/http-server.ts`        | Modify | ~15 lines removed/changed |
| `packages/agent-runtime/src/agent-runtime.ts`           | Modify | ~35 lines removed/changed |
| `packages/agent-runtime/src/index.ts`                   | Modify | ~8 lines removed          |

## Change Log

| Date       | Version | Description                                                                                                                 | Author               |
| ---------- | ------- | --------------------------------------------------------------------------------------------------------------------------- | -------------------- |
| 2026-02-09 | 1.0     | Initial story draft created from Epic 22                                                                                    | Claude Opus 4.6 (SM) |
| 2026-02-09 | 1.1     | Validation fixes: task execution order, resolveConfig backward compat, grep false positive note, coverage source correction | Claude Opus 4.6 (QA) |
| 2026-02-09 | 1.2     | Fix spsp-server.ts line count (140→139), fix startFromEnv sessionTtlMs line refs (263-265→262-264)                          | Claude Opus 4.6 (QA) |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug issues encountered. Clean implementation.

### Completion Notes

- All 7 tasks completed in recommended order (3 → 4 → 5 → 1 → 2 → 6 → 7)
- TypeScript compilation passes with zero errors
- All 91 tests pass across 5 test suites (unchanged from Story 22.1)
- Only remaining reference to deleted modules is a test description string in `packet-handler.test.ts` line 54 (`"no SessionManager"`) — acceptable per story notes
- `resolveConfig()` retains `spspEnabled`/`sessionTtlMs` defaults for type contract — deferred to Story 22.3
- `startFromEnv()` uses hardcoded `spspEnabled: false` and `sessionTtlMs: 0` instead of env vars
- ~346 lines of dead code removed (207 session-manager.ts + 139 spsp-server.ts)

### File List

| File                                                    | Action              |
| ------------------------------------------------------- | ------------------- |
| `packages/agent-runtime/src/session/session-manager.ts` | Deleted             |
| `packages/agent-runtime/src/session/`                   | Deleted (directory) |
| `packages/agent-runtime/src/spsp/spsp-server.ts`        | Deleted             |
| `packages/agent-runtime/src/spsp/`                      | Deleted (directory) |
| `packages/agent-runtime/src/http/http-server.ts`        | Modified            |
| `packages/agent-runtime/src/agent-runtime.ts`           | Modified            |
| `packages/agent-runtime/src/index.ts`                   | Modified            |

### Change Log

| Date       | Description                                                                 |
| ---------- | --------------------------------------------------------------------------- |
| 2026-02-09 | Implementation complete — all tasks done, all tests pass, TS compiles clean |

## QA Results

### Review Date: 2026-02-09

### Reviewed By: Quinn (Test Architect)

### Risk Assessment

**Review depth: Standard** — This is a deletion/simplification story with no new logic, no auth/payment/security logic changes, and diff is primarily removals. No auto-escalation triggers fired.

### Code Quality Assessment

Excellent implementation. The story is a clean dead-code removal — ~346 lines of session management and SPSP server code deleted, with all references surgically removed from `agent-runtime.ts`, `http-server.ts`, and `index.ts`. The remaining code is well-structured and concise:

- **`http-server.ts`** (175 lines): Clean Express server with 4 endpoints (`/health`, `/ready`, `/ilp/packets`, `/ilp/send`) and proper error handling. Constructor signature simplified to `(config, packetHandler, logger, sender?)`.
- **`agent-runtime.ts`** (277 lines): Orchestrator cleanly wires 4 components (BusinessClient, PacketHandler, HttpServer, OutboundBTPClient). No dead references. JSDoc updated accurately.
- **`index.ts`** (57 lines): Clean barrel export — removed SessionManager, SPSPServer, and SPSP type re-exports. Retained all active types.

Code adheres to project patterns: Pino logger (no `console.log` in production code), TypeScript strict mode, Express middleware patterns.

### Refactoring Performed

None — no refactoring needed. The implementation is already clean and minimal.

### Compliance Check

- Coding Standards: ✓ Pino logger only, no `any` types, TypeScript strict mode
- Project Structure: ✓ Files properly deleted, directories removed, no orphaned imports
- Testing Strategy: ✓ All 91 tests pass across 5 suites, no new tests needed (deletion story)
- All ACs Met: ✓ All 9 acceptance criteria verified (see details below)

### Acceptance Criteria Verification

| AC  | Criteria                                                | Status | Evidence                                                                                                                                      |
| --- | ------------------------------------------------------- | ------ | --------------------------------------------------------------------------------------------------------------------------------------------- |
| 1   | `src/session/` directory removed                        | ✓ PASS | Glob returns no files in `src/session/`                                                                                                       |
| 2   | `src/spsp/` directory removed                           | ✓ PASS | Glob returns no files in `src/spsp/`                                                                                                          |
| 3   | No imports of SessionManager/SPSPServer                 | ✓ PASS | Grep returns only 1 hit — a test description string in `packet-handler.test.ts:54` ("no SessionManager"), which is acceptable per story notes |
| 4   | SPSP endpoints return 404                               | ✓ PASS | SPSP route mount (`this.app.use(this.spspServer.getRouter())`) removed; 404 handler at `http-server.ts:118` catches all unmatched routes      |
| 5   | Health endpoint no longer includes `activeSessions`     | ✓ PASS | `http-server.ts:70-78` health response: `{ status, nodeId, btpConnected, timestamp }` — no `activeSessions`                                   |
| 6   | Constructor no longer creates SessionManager/SPSPServer | ✓ PASS | `agent-runtime.ts:48-88` constructor creates only BusinessClient, PacketHandler, HttpServer — no SessionManager/SPSPServer                    |
| 7   | `stop()` no longer calls `sessionManager.shutdown()`    | ✓ PASS | `agent-runtime.ts:126-147` stop() disconnects BTP, stops HTTP server — no session shutdown                                                    |
| 8   | TypeScript compilation succeeds                         | ✓ PASS | `npx tsc --noEmit` passes with zero errors                                                                                                    |
| 9   | All tests pass                                          | ✓ PASS | 91 tests, 5 suites, all passing                                                                                                               |

### Improvements Checklist

All items addressed by dev — no remaining action items:

- [x] Deleted `session-manager.ts` and `session/` directory
- [x] Deleted `spsp-server.ts` and `spsp/` directory
- [x] Removed all imports and references from `http-server.ts`
- [x] Removed all imports and references from `agent-runtime.ts`
- [x] Removed re-exports from `index.ts`
- [x] Updated JSDoc across all modified files
- [x] Retained `spspEnabled`/`sessionTtlMs` in `resolveConfig()` for type contract (deferred to 22.3)
- [x] Hardcoded `spspEnabled: false` and `sessionTtlMs: 0` in `startFromEnv()` (deferred cleanup to 22.3)

**Minor observation (not blocking):**

- [ ] `types/index.ts:1-7` JSDoc still says "handles ILP/SPSP/STREAM protocol complexity" — this is correctly deferred to Story 22.3 per technical constraints

### Security Review

No security concerns. This story only removes code — no new attack surface, no new inputs, no new external integrations. The remaining endpoints (`/ilp/packets`, `/ilp/send`, `/health`, `/ready`) are unchanged.

### Performance Considerations

No performance concerns. Removing SessionManager eliminates the periodic cleanup interval timer and in-memory session Map, which is a minor positive for memory and CPU.

### Files Modified During Review

None — no files were modified during QA review.

### Gate Status

Gate: PASS → docs/qa/gates/22.2-remove-spsp-server-session-manager.yml

### Recommended Status

✓ Ready for Done — All 9 acceptance criteria met, all tests pass, TypeScript compiles clean, no blocking issues.
