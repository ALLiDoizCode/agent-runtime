# Story 20.2: Proposal Creation (Kind 5910)

## Status

Done

## Story

**As a** coordinator agent,
**I want** to create coordination proposal events (Kind 5910),
**so that** I can initiate multi-agent coordination by publishing proposals that participants can vote on.

## Acceptance Criteria

1. Create Kind 5910 event with unique `d` tag
2. Include `type` tag for coordination type
3. Include `p` tags for all participants
4. Include `threshold` tag when applicable
5. Include `quorum` tag for minimum participation
6. Include `expires` tag with Unix timestamp
7. Include `action` tag with action event kind and data
8. Optional `weight` tags for weighted voting
9. Content contains proposal description
10. Sign with coordinator's Nostr key

## Tasks / Subtasks

- [x] Task 1: Create ProposalCreator class file (AC: 1-10)
  - [x] Create `packages/connector/src/agent/coordination/proposal.ts`
  - [x] Import types from `./types.ts`: CreateProposalParams, CreateProposalParamsSchema, Proposal, COORDINATION_PROPOSAL_KIND, TAG constants, NostrEvent (re-exported from toon-codec)
  - [x] Import signing utilities from nostr-tools: `finalizeEvent`, `getPublicKey`
  - [x] Import `hexToBytes` from `@noble/hashes/utils` for private key conversion
  - [x] Define ProposalCreator class constructor accepting private key (hex string), convert to Uint8Array internally

- [x] Task 2: Implement unique proposal ID generation (AC: 1)
  - [x] Create `generateProposalId()` method using crypto.randomBytes()
  - [x] Generate 32-character hex string for d tag uniqueness
  - [x] Ensure IDs are deterministically verifiable but collision-resistant

- [x] Task 3: Implement tag building methods (AC: 2-8)
  - [x] Create private `buildTags()` method that constructs all Nostr tags
  - [x] Build `['d', proposalId]` tag for unique identifier (AC: 1)
  - [x] Build `['type', params.type]` tag for coordination type (AC: 2)
  - [x] Build `['p', pubkey]` tags for each participant (AC: 3)
  - [x] Build `['threshold', threshold.toString()]` tag when params.threshold is defined (AC: 4)
  - [x] Build `['quorum', quorum.toString()]` tag when params.quorum is defined (AC: 5)
  - [x] Build `['expires', expires.toString()]` tag with Unix timestamp (AC: 6)
  - [x] Build `['action', kind.toString(), data]` tag when params.action is defined (AC: 7)
  - [x] Build `['weight', pubkey, weight.toString()]` tags for each weight entry (AC: 8)

- [x] Task 4: Implement create() method (AC: 9, 10)
  - [x] Validate params using CreateProposalParamsSchema.parse()
  - [x] Calculate expiration: `Math.floor(Date.now() / 1000) + params.expiresIn`
  - [x] Generate unique proposal ID
  - [x] Build tags array using buildTags()
  - [x] Set content to params.description (AC: 9)
  - [x] Create unsigned event template with kind=5910
  - [x] Sign event using nostr-tools finalizeEvent() (AC: 10)
  - [x] Return signed NostrEvent

- [x] Task 5: Implement toProposal() helper (optional)
  - [x] Create method to convert NostrEvent back to Proposal interface
  - [x] Parse tags to extract all fields
  - [x] Convert weights Record back to Map if present
  - [x] This prepares for Story 20.3 (Proposal Parsing)

- [x] Task 6: Export from coordination module
  - [x] Update `packages/connector/src/agent/coordination/index.ts`
  - [x] Export ProposalCreator class
  - [x] Export any new types if created

- [x] Task 7: Write unit tests (AC: 1-10)
  - [x] Create `packages/connector/src/agent/coordination/proposal.test.ts`
  - [x] Test proposal ID generation uniqueness
  - [x] Test Kind 5910 event creation with minimal params
  - [x] Test d tag contains unique proposal ID (AC: 1)
  - [x] Test type tag matches params.type (AC: 2)
  - [x] Test p tags for all participants (AC: 3)
  - [x] Test threshold tag when provided (AC: 4)
  - [x] Test quorum tag when provided (AC: 5)
  - [x] Test expires tag calculation (AC: 6)
  - [x] Test action tag format when provided (AC: 7)
  - [x] Test weight tags for weighted voting (AC: 8)
  - [x] Test content matches description (AC: 9)
  - [x] Test event is signed (sig field not empty) (AC: 10)
  - [x] Test validation errors for invalid params

- [x] Task 8: Run tests and verify
  - [x] Run `npm test -- proposal.test.ts` in connector package
  - [x] Verify all tests pass (39 tests passing)
  - [x] Check coverage meets 80% requirement (100% line coverage for proposal.ts)

## Dev Notes

### Previous Story Insights (20.1)

From Story 20.1 Dev Agent Record:

- Created coordination directory at `packages/connector/src/agent/coordination/`
- All types, interfaces, and Zod schemas are in `types.ts`
- NostrEvent imported from `../toon-codec` (not from nostr-tools)
- Zod schemas ready for validation: `CreateProposalParamsSchema`
- Error classes defined: `ProposalExpiredError`, `NotParticipantError` (for use in later stories)
- `Proposal.weights` uses `Map<string, number>` but `CreateProposalParams.weights` uses `Record<string, number>` for Zod compatibility - conversion needed in ProposalCreator
  [Source: docs/stories/20.1.story.md#qa-results]

### Event Kind Constants

From Story 20.1 types.ts:

```typescript
export const COORDINATION_PROPOSAL_KIND = 5910;
export const TAG_D = 'd';
export const TAG_TYPE = 'type';
export const TAG_P = 'p';
export const TAG_THRESHOLD = 'threshold';
export const TAG_QUORUM = 'quorum';
export const TAG_EXPIRES = 'expires';
export const TAG_ACTION = 'action';
export const TAG_WEIGHT = 'weight';
```

[Source: packages/connector/src/agent/coordination/types.ts:9-44]

### CreateProposalParams Interface

```typescript
interface CreateProposalParams {
  type: CoordinationType; // 'consensus' | 'majority' | 'threshold' | 'ranked' | 'allocation'
  participants: string[]; // Array of pubkeys
  threshold?: number; // For threshold type
  quorum?: number; // Minimum participation
  expiresIn: number; // Seconds until expiration
  action?: ProposalAction; // { kind: number, data: string }
  weights?: Record<string, number>; // pubkey -> weight
  description: string; // Proposal content
}
```

[Source: packages/connector/src/agent/coordination/types.ts:181-198]

### Nostr Event Signing

Use nostr-tools for event creation and signing:

```typescript
import { finalizeEvent, generateSecretKey, getPublicKey } from 'nostr-tools';

// Create unsigned event template
const eventTemplate = {
  kind: 5910,
  created_at: Math.floor(Date.now() / 1000),
  tags: [...],
  content: description
};

// Sign with private key (Uint8Array)
const signedEvent = finalizeEvent(eventTemplate, privateKeyBytes);
```

[Source: architecture/tech-stack.md - nostr-tools 2.10.0]

### Private Key Handling

The constructor accepts a hex string private key for ease of use, but nostr-tools `finalizeEvent()` requires `Uint8Array`. Convert in constructor:

```typescript
import { hexToBytes } from '@noble/hashes/utils';

class ProposalCreator {
  private readonly privateKey: Uint8Array;
  private readonly pubkey: string;

  constructor(privateKeyHex: string) {
    this.privateKey = hexToBytes(privateKeyHex);
    this.pubkey = getPublicKey(this.privateKey);
  }
}
```

**Security Note:** Never log or expose the private key. The `privateKey` field should be `private readonly` and never included in error messages or debug output. For production deployments, consider accepting `Uint8Array` directly to avoid hex string handling.
[Source: architecture/coding-standards.md - security practices]

### NostrEvent Interface

From toon-codec.ts (already used in types.ts):

```typescript
interface NostrEvent {
  id: string; // 32-byte hex SHA-256
  pubkey: string; // 32-byte hex public key
  created_at: number; // Unix timestamp
  kind: number; // Event kind
  tags: string[][]; // Array of tag arrays
  content: string; // Event content
  sig: string; // 64-byte hex signature
}
```

[Source: packages/connector/src/agent/toon-codec.ts:7-15]

### Expected Tag Structure

Per Epic 20 PRD Story 20.2 Technical Notes:

```typescript
const tags = [
  ['d', proposalId],
  ['type', params.type],
  ...params.participants.map((p) => ['p', p]),
  ['expires', expires.toString()],
];

if (params.threshold !== undefined) {
  tags.push(['threshold', params.threshold.toString()]);
}
if (params.quorum !== undefined) {
  tags.push(['quorum', params.quorum.toString()]);
}
if (params.action) {
  tags.push(['action', params.action.kind.toString(), params.action.data]);
}
if (params.weights) {
  for (const [pubkey, weight] of Object.entries(params.weights)) {
    tags.push(['weight', pubkey, weight.toString()]);
  }
}
```

[Source: docs/prd/epic-20-multi-agent-coordination.md - Story 20.2]

### File Locations

- Create: `packages/connector/src/agent/coordination/proposal.ts`
- Create: `packages/connector/src/agent/coordination/proposal.test.ts`
- Update: `packages/connector/src/agent/coordination/index.ts`
  [Source: architecture/source-tree.md - agent module structure]

## Testing

### Test File Location

`packages/connector/src/agent/coordination/proposal.test.ts`

### Testing Standards

- Jest 29.7.x with TypeScript support
- AAA pattern (Arrange, Act, Assert)
- > 80% coverage for connector package
- Co-located test files with source
  [Source: architecture/test-strategy-and-standards.md]

### Required Test Cases

1. **Proposal ID Generation**
   - Generate multiple IDs and verify uniqueness
   - Verify ID format (hex string)

2. **Minimal Proposal Creation**
   - Create proposal with only required fields (type, participants, expiresIn, description)
   - Verify Kind 5910, d tag, type tag, p tags, expires tag, content

3. **Full Proposal Creation**
   - Create proposal with all optional fields
   - Verify threshold, quorum, action, weight tags present

4. **Tag Validation Tests** (one per AC)
   - AC1: Verify unique d tag
   - AC2: Verify type tag matches param
   - AC3: Verify p tag for each participant
   - AC4: Verify threshold tag present when provided
   - AC5: Verify quorum tag present when provided
   - AC6: Verify expires tag calculated correctly
   - AC7: Verify action tag format [action, kind, data]
   - AC8: Verify weight tags for each entry
   - AC9: Verify content equals description
   - AC10: Verify sig field is non-empty hex

5. **Validation Error Tests**
   - Invalid type should throw ZodError
   - Empty participants array should throw ZodError
   - Negative expiresIn should throw ZodError
   - Empty description should throw ZodError

### Test Helpers

Create test private key for signing:

```typescript
import { generateSecretKey, getPublicKey } from 'nostr-tools';

const testPrivateKey = generateSecretKey(); // Uint8Array
const testPubkey = getPublicKey(testPrivateKey);
```

## Change Log

| Date       | Version | Description                                                                   | Author    |
| ---------- | ------- | ----------------------------------------------------------------------------- | --------- |
| 2026-01-29 | 0.1     | Initial draft                                                                 | SM Agent  |
| 2026-01-29 | 0.2     | Applied validation fixes: clarified imports, added private key handling notes | PO Agent  |
| 2026-01-29 | 0.3     | Status changed to Approved                                                    | PO Agent  |
| 2026-01-29 | 1.0     | Implementation complete - all tasks done, 39 tests passing                    | Dev Agent |

---

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### File List

| File                                                         | Action   | Description                                                                          |
| ------------------------------------------------------------ | -------- | ------------------------------------------------------------------------------------ |
| `packages/connector/src/agent/coordination/proposal.ts`      | Created  | ProposalCreator class with create(), toProposal(), generateProposalId(), buildTags() |
| `packages/connector/src/agent/coordination/proposal.test.ts` | Created  | 39 unit tests covering all acceptance criteria                                       |
| `packages/connector/src/agent/coordination/index.ts`         | Modified | Added export for ProposalCreator class                                               |

### Debug Log References

No debug issues encountered.

### Completion Notes

1. **Implementation Summary:**
   - Created `ProposalCreator` class that creates signed Kind 5910 Nostr events
   - Constructor accepts hex string private key, converts to Uint8Array internally
   - `create()` method validates params with Zod, builds tags, signs with nostr-tools `finalizeEvent()`
   - `toProposal()` helper converts NostrEvent back to Proposal interface (prepares for Story 20.3)
   - `generateProposalId()` uses `crypto.randomBytes(16).toString('hex')` for 32-char hex IDs

2. **Testing Results:**
   - 39 tests passing
   - 100% line coverage for proposal.ts
   - All 10 acceptance criteria verified with dedicated test cases
   - Validation error tests confirm Zod schema enforcement

3. **Technical Decisions:**
   - Used `crypto.randomBytes()` instead of `crypto.randomUUID()` for proposal ID to get clean 32-char hex
   - Private key stored as `_privateKey` with underscore prefix per coding standards for private members
   - Used optional chaining and nullish coalescing in `toProposal()` for safe tag parsing
   - Type assertions used minimally and only where TypeScript strict mode required

---

## DoD Checklist

### 1. Requirements Met

- [x] All functional requirements specified in the story are implemented
- [x] All acceptance criteria (AC 1-10) defined in the story are met

### 2. Coding Standards & Project Structure

- [x] Code adheres to Operational Guidelines (TypeScript strict, Prettier, ESLint)
- [x] Code aligns with Project Structure (file in `packages/connector/src/agent/coordination/`)
- [x] Adherence to Tech Stack (nostr-tools 2.10.0, Zod ^3.23.0)
- [N/A] API Reference/Data Models - no API changes
- [x] Security best practices (private key stored as readonly, not logged/exposed)
- [x] No new linter errors in proposal.ts or proposal.test.ts
- [x] Code is well-commented with JSDoc for public methods

### 3. Testing

- [x] All required unit tests implemented (39 tests)
- [N/A] Integration tests - not required for this story
- [x] All tests pass successfully
- [x] Test coverage meets 80% requirement (100% for proposal.ts)

### 4. Functionality & Verification

- [x] Functionality verified via comprehensive test suite
- [x] Edge cases handled (empty arrays, missing optional fields, invalid params)

### 5. UI/Frontend Verification

- [N/A] No UI changes in this story - backend-only Kind 5910 event creation

### 6. Story Administration

- [x] All tasks marked complete
- [x] Dev Agent Record section completed with notes and file list
- [x] Change log updated

### 7. Dependencies, Build & Configuration

- [x] Tests compile and run successfully
- [x] Linting passes for new files
- [x] No new dependencies added - used existing nostr-tools, @noble/hashes, zod
- [N/A] No new environment variables or configurations

### 8. Documentation

- [x] JSDoc comments for ProposalCreator class and public methods
- [N/A] No user-facing documentation needed
- [N/A] No architectural changes requiring diagram updates

### Final Confirmation

- [x] I, the Developer Agent, confirm that all applicable items above have been addressed.

**Summary:** Story 20.2 implementation complete. ProposalCreator class creates signed Kind 5910 Nostr coordination proposal events with all required tags. 39 tests verify all 10 acceptance criteria. No technical debt created.

---

## QA Results

### Review Date: 2026-01-29

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - The implementation demonstrates strong adherence to coding standards, comprehensive test coverage, and thoughtful design decisions.

**Strengths:**

1. **Clean Architecture**: `ProposalCreator` is a focused, single-responsibility class with clear separation of concerns (ID generation, tag building, event creation, conversion)
2. **Type Safety**: Full TypeScript strict mode compliance with proper use of Zod schemas for runtime validation
3. **Security Consciousness**: Private key stored as `readonly _privateKey` and never exposed in error messages or logging
4. **Documentation**: JSDoc comments on all public methods with clear parameter/return descriptions
5. **Standards Compliance**: Uses coding standards naming conventions (`_privateKey` for private members, `TAG_*` constants for strings)
6. **Forward Compatibility**: `toProposal()` helper prepares for Story 20.3 (Proposal Parsing) without over-engineering

**Minor Observations:**

- Line 146: Type assertion `as NostrEvent` is necessary due to nostr-tools `finalizeEvent` return type - acceptable use
- Branch coverage at 86.95% due to defensive null checks in `toProposal()` (lines 163-167, 185) - these guard against malformed events and are appropriate

### Refactoring Performed

None required. Code quality is excellent and requires no refactoring.

### Compliance Check

- Coding Standards: ✓ TypeScript strict, camelCase/PascalCase naming, `_` prefix for private members, UPPER_SNAKE_CASE constants
- Project Structure: ✓ File at `packages/connector/src/agent/coordination/proposal.ts` per architecture
- Testing Strategy: ✓ Co-located tests, AAA pattern, >80% coverage (100% achieved)
- All ACs Met: ✓ All 10 acceptance criteria verified with dedicated test cases

### Requirements Traceability

| AC   | Requirement                           | Test Coverage                                | Status |
| ---- | ------------------------------------- | -------------------------------------------- | ------ |
| AC1  | Unique `d` tag                        | `AC 1: unique d tag` (2 tests)               | ✓      |
| AC2  | `type` tag for coordination type      | `AC 2: type tag` (6 tests)                   | ✓      |
| AC3  | `p` tags for all participants         | `AC 3: p tags for participants` (2 tests)    | ✓      |
| AC4  | `threshold` tag when applicable       | `AC 4: threshold tag` (2 tests)              | ✓      |
| AC5  | `quorum` tag for min participation    | `AC 5: quorum tag` (2 tests)                 | ✓      |
| AC6  | `expires` tag with Unix timestamp     | `AC 6: expires tag` (2 tests)                | ✓      |
| AC7  | `action` tag with event kind and data | `AC 7: action tag` (2 tests)                 | ✓      |
| AC8  | Optional `weight` tags                | `AC 8: weight tags` (2 tests)                | ✓      |
| AC9  | Content contains description          | `AC 9: content equals description` (2 tests) | ✓      |
| AC10 | Sign with coordinator's Nostr key     | `AC 10: event is signed` (3 tests)           | ✓      |

### Improvements Checklist

All items addressed - no outstanding work required:

- [x] All 10 acceptance criteria implemented and tested
- [x] 100% line coverage for proposal.ts
- [x] ESLint passes with no errors
- [x] Zod validation for all input parameters
- [x] Proper error handling with ZodError for invalid inputs
- [x] Security: Private key never logged or exposed
- [x] `toProposal()` helper prepares for Story 20.3

### Security Review

**Status: PASS**

- Private key handling is secure (`_privateKey` is `private readonly`)
- No logging of sensitive data
- Input validation via Zod schemas prevents malformed data
- `hexToBytes` conversion happens in constructor, not exposed to callers
- Type assertions are minimal and only where TypeScript strict mode requires

### Performance Considerations

**Status: PASS**

- `crypto.randomBytes(16)` for ID generation is efficient and cryptographically secure
- No unnecessary iterations or allocations
- `Map` used for weights in `Proposal` interface (O(1) lookup) vs `Record` in params (Zod compatibility)
- Single-pass tag building with array push operations

### Test Architecture Assessment

**Status: Excellent**

- **Coverage**: 100% line coverage, 86.95% branch coverage
- **Test Organization**: Well-structured describe blocks mirror AC requirements
- **Edge Cases**: Tests for single participant, multi-line descriptions, all coordination types
- **Validation Testing**: 5 dedicated tests for Zod validation errors
- **Round-trip Testing**: `toProposal` tests verify event can be parsed back to domain object
- **Test Isolation**: Fresh keys generated per test via `beforeEach`

### Files Modified During Review

None - no modifications required.

### Gate Status

Gate: **PASS** → docs/qa/gates/20.2-proposal-creation.yml

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, comprehensive test coverage, excellent code quality. Story owner may proceed with status change.
