# Story 29.1: Extend ConnectorConfig with Settlement Infrastructure Types

**Epic:** 29 - Config-Driven Settlement Infrastructure
**Story Number:** 29.1
**Status:** Done

## Story Statement

**As a** connector developer,
**I want** `ConnectorConfig` to include a `SettlementInfraConfig` interface and `PeerConfig` to include an optional `evmAddress` field,
**so that** settlement infrastructure parameters (private key, RPC URL, registry, token address, thresholds, etc.) can be specified inline in config objects instead of requiring `process.env` reads, enabling multi-node test topologies in a single process.

## Prerequisites

**Story Dependencies:**

- None — this is the first story in Epic 29

**Epic Dependencies:**

- Epic 28 (in-memory ledger) — COMPLETED: Provides `InMemoryLedgerClient`, `ILedgerClient` interface, ledger snapshot persistence config
- Epic 6 (settlement foundation) — COMPLETED: Provides `AccountManager`, `SettlementMonitor`, `SettlementExecutor`, `SettlementConfig` types
- Epic 12 (KeyManager/security) — COMPLETED: Provides `KeyManager` with `EnvironmentVariableBackend`

**Context:**
Currently, `ConnectorNode.start()` reads ~15 settlement-related values from `process.env`: `TREASURY_EVM_PRIVATE_KEY`, `BASE_L2_RPC_URL`, `TOKEN_NETWORK_REGISTRY`, `M2M_TOKEN_ADDRESS`, `PEER{1-5}_EVM_ADDRESS`, `SETTLEMENT_ENABLED`, `SETTLEMENT_THRESHOLD`, `SETTLEMENT_POLLING_INTERVAL`, `INITIAL_DEPOSIT_MULTIPLIER`, `LEDGER_SNAPSHOT_PATH`, and `LEDGER_PERSIST_INTERVAL_MS`. There is also a fragile hack where `process.env.EVM_PRIVATE_KEY` is temporarily swapped (lines 342-357 of `connector-node.ts`) to pass the treasury key to `KeyManager`'s `EnvironmentVariableBackend`. Peer EVM addresses are loaded via a hardcoded `for (let i = 1; i <= 5; i++)` loop reading `PEER{i}_EVM_ADDRESS`, limiting the network to 5 peers. This story adds the type definitions only — no behavioral changes.

## Acceptance Criteria

1. New `SettlementInfraConfig` interface in `config/types.ts` with fields: `enabled`, `privateKey`, `rpcUrl`, `registryAddress`, `tokenAddress`, `threshold`, `pollingIntervalMs`, `settlementTimeoutSecs`, `initialDepositMultiplier`, `ledgerSnapshotPath`, `ledgerPersistIntervalMs`
2. `PeerConfig` extended with optional `evmAddress?: string` field
3. `ConnectorConfig` gains optional `settlementInfra?: SettlementInfraConfig` field
4. `ConfigLoader.validateConfig()` passes through new fields without breaking existing validation
5. New types exported from `lib.ts`
6. TypeScript compilation succeeds, all existing tests pass unchanged

## Dev Notes

### Previous Story Insights (28.3)

- Story 28.3 introduced the `ILedgerClient` interface and eliminated runtime `tigerbeetle-node` dependency from `AccountManager`
- The `_createInMemoryAccountManager()` method in `connector-node.ts` (line 1176) reads `LEDGER_SNAPSHOT_PATH` and `LEDGER_PERSIST_INTERVAL_MS` from `process.env` — these become config-driven in Story 29.2 using the `ledgerSnapshotPath` and `ledgerPersistIntervalMs` fields added in this story
- No implementation changes from 28.3 affect this types-only story

### SettlementInfraConfig Interface Design

The new interface maps directly to the ~15 environment variables currently read in `ConnectorNode.start()` (lines 326-398, 511-513, 1177-1178 of `connector-node.ts`). All fields are optional to maintain backward compatibility — when absent, Story 29.2 will fall back to `process.env`.

**Field-to-env-var mapping:**

| Field                      | Env Var                       | Type      | Default (from env fallback)     |
| -------------------------- | ----------------------------- | --------- | ------------------------------- |
| `enabled`                  | `SETTLEMENT_ENABLED`          | `boolean` | `false`                         |
| `privateKey`               | `TREASURY_EVM_PRIVATE_KEY`    | `string`  | —                               |
| `rpcUrl`                   | `BASE_L2_RPC_URL`             | `string`  | —                               |
| `registryAddress`          | `TOKEN_NETWORK_REGISTRY`      | `string`  | —                               |
| `tokenAddress`             | `M2M_TOKEN_ADDRESS`           | `string`  | —                               |
| `threshold`                | `SETTLEMENT_THRESHOLD`        | `string`  | `'1000000'`                     |
| `pollingIntervalMs`        | `SETTLEMENT_POLLING_INTERVAL` | `number`  | `30000`                         |
| `settlementTimeoutSecs`    | (hardcoded 86400 in code)     | `number`  | `86400`                         |
| `initialDepositMultiplier` | `INITIAL_DEPOSIT_MULTIPLIER`  | `number`  | `1`                             |
| `ledgerSnapshotPath`       | `LEDGER_SNAPSHOT_PATH`        | `string`  | `'./data/ledger-snapshot.json'` |
| `ledgerPersistIntervalMs`  | `LEDGER_PERSIST_INTERVAL_MS`  | `number`  | `30000`                         |

**Note on `threshold` type:** The `threshold` field is typed as `string` (not `bigint`) because YAML and JSON configs cannot represent `bigint` natively. The consuming code (Story 29.2) will parse it with `BigInt(value)`. This matches the current pattern: `BigInt(process.env.SETTLEMENT_THRESHOLD || '1000000')` at line 511 of `connector-node.ts`.

[Source: `packages/connector/src/core/connector-node.ts`, lines 326-398, 511-513, 1177-1178]

### PeerConfig Extension

Add an optional `evmAddress?: string` field to the existing `PeerConfig` interface. This replaces the hardcoded `PEER{1-5}_EVM_ADDRESS` environment variable loop (line 379 of `connector-node.ts`). The field is optional — peers without `evmAddress` will use the env var fallback in Story 29.2.

**Current PeerConfig** (lines 61-84 of `config/types.ts`):

```typescript
export interface PeerConfig {
  id: string;
  url: string;
  authToken: string;
}
```

**After:**

```typescript
export interface PeerConfig {
  id: string;
  url: string;
  authToken: string;
  /** Optional EVM address for this peer (replaces PEER{N}_EVM_ADDRESS env var) */
  evmAddress?: string;
}
```

[Source: `packages/connector/src/config/types.ts`, lines 61-84]

### ConnectorConfig Extension

Add an optional `settlementInfra?: SettlementInfraConfig` field to `ConnectorConfig`. This sits alongside the existing `settlement?: SettlementConfig` field (which configures TigerBeetle accounting parameters). The naming distinguishes the two:

- `settlement` — TigerBeetle accounting config (cluster ID, replicas, fees, credit limits, thresholds)
- `settlementInfra` — EVM settlement infrastructure config (private key, RPC URL, contract addresses, deposit params)

[Source: `packages/connector/src/config/types.ts`, line 234 (existing `settlement` field)]

### ConfigLoader Pass-Through

`ConfigLoader.validateConfig()` already passes through optional fields like `settlement`, `security`, `performance`, `adminApi`, and `localDelivery` as type casts (lines 200-207 of `config-loader.ts`). The new `settlementInfra` field follows the exact same pattern:

```typescript
settlementInfra: rawConfig.settlementInfra as SettlementInfraConfig | undefined,
```

No new validation logic is needed for Story 29.1 — the field is simply passed through. Future stories may add validation (e.g., warning if `privateKey` is an Anvil key in production mode).

[Source: `packages/connector/src/config/config-loader.ts`, lines 188-208]

### lib.ts Export

Add `SettlementInfraConfig` to the `export type { ... } from './config/types'` block in `lib.ts` (line 41-56).

[Source: `packages/connector/src/lib.ts`, lines 41-56]

### File Locations

| File                                             | Action     | Description                                                                                                         |
| ------------------------------------------------ | ---------- | ------------------------------------------------------------------------------------------------------------------- |
| `packages/connector/src/config/types.ts`         | **Modify** | Add `SettlementInfraConfig` interface, add `evmAddress` to `PeerConfig`, add `settlementInfra` to `ConnectorConfig` |
| `packages/connector/src/config/config-loader.ts` | **Modify** | Add `settlementInfra` pass-through in `validateConfig()`, add `SettlementInfraConfig` to import                     |
| `packages/connector/src/lib.ts`                  | **Modify** | Add `SettlementInfraConfig` to type exports                                                                         |

**No new files created. No test files modified.**

**Important: Do NOT modify `connector-node.ts` in this story.** The Dev Notes reference `connector-node.ts` extensively for context (env var locations, line numbers), but all behavioral changes to that file are deferred to Story 29.2. This story is types-only.

### Coding Standards

- TypeScript strict mode, no `any` types
- Interface naming: PascalCase (no `I` prefix for config interfaces — follows existing `SettlementConfig`, `BlockchainConfig` pattern)
- All fields optional for backward compatibility
- JSDoc on all new interface fields with descriptions
- File naming: kebab-case (no new files needed)

[Source: `docs/architecture/coding-standards.md`]

### Testing

**Test approach:** Compilation-only verification + existing test pass-through

**Unit tests:**

- Framework: Jest 29.7.x with `ts-jest`
- No new test files needed — this is a types-only story
- Existing tests must pass unchanged (backward compatibility)

**Verification steps:**

1. Run `npm run build` — TypeScript compilation succeeds with new types
2. Run `npm test` in connector package — all existing tests pass unchanged
3. Run `npm run lint` — no lint errors
4. Verify new types are exported: check `lib.ts` includes `SettlementInfraConfig`
5. Verify `PeerConfig` includes `evmAddress` field
6. Verify `ConnectorConfig` includes `settlementInfra` field

**Existing test files that exercise config loading (should remain unchanged):**

- `packages/connector/test/unit/config-loader.test.ts`
- `packages/connector/test/unit/config-loader-mesh.test.ts`

[Source: `docs/architecture/test-strategy-and-standards.md`]

## Tasks / Subtasks

### 1. Add `SettlementInfraConfig` interface to `config/types.ts` (AC: 1)

- [x] Add `SettlementInfraConfig` interface after the existing `SettlementConfig` interface (~line 591)
- [x] Include all 11 fields, all optional:
  - `enabled?: boolean` — Feature flag for EVM settlement infrastructure
  - `privateKey?: string` — Treasury EVM private key (replaces `TREASURY_EVM_PRIVATE_KEY`). JSDoc must include security note: "Sensitive — do not log or serialize in plaintext."
  - `rpcUrl?: string` — Base L2 RPC endpoint URL (replaces `BASE_L2_RPC_URL`)
  - `registryAddress?: string` — Token network registry contract address (replaces `TOKEN_NETWORK_REGISTRY`)
  - `tokenAddress?: string` — M2M token contract address (replaces `M2M_TOKEN_ADDRESS`)
  - `threshold?: string` — Settlement threshold as string (parsed to BigInt by consumer, replaces `SETTLEMENT_THRESHOLD`)
  - `pollingIntervalMs?: number` — Settlement polling interval in ms (replaces `SETTLEMENT_POLLING_INTERVAL`)
  - `settlementTimeoutSecs?: number` — Default settlement timeout in seconds (replaces hardcoded 86400)
  - `initialDepositMultiplier?: number` — Initial deposit multiplier (replaces `INITIAL_DEPOSIT_MULTIPLIER`)
  - `ledgerSnapshotPath?: string` — In-memory ledger snapshot path (replaces `LEDGER_SNAPSHOT_PATH`)
  - `ledgerPersistIntervalMs?: number` — Ledger snapshot persistence interval (replaces `LEDGER_PERSIST_INTERVAL_MS`)
- [x] Add JSDoc comments on interface and each field with description and env var it replaces

### 2. Extend `PeerConfig` with `evmAddress` field (AC: 2)

- [x] Add `evmAddress?: string` to `PeerConfig` interface
- [x] Add JSDoc: "Optional EVM address for this peer. Replaces `PEER{N}_EVM_ADDRESS` env vars. Supports arbitrary peer counts (not limited to 5)."

### 3. Extend `ConnectorConfig` with `settlementInfra` field (AC: 3)

- [x] Add `settlementInfra?: SettlementInfraConfig` to `ConnectorConfig` interface, directly after the existing `settlement?: SettlementConfig` field (line 234 of `types.ts`) for logical grouping
- [x] Add JSDoc describing the field and how it relates to the existing `settlement` field

### 4. Update `ConfigLoader.validateConfig()` to pass through `settlementInfra` (AC: 4)

- [x] Add `SettlementInfraConfig` to the import from `./types` in `config-loader.ts`
- [x] Add `settlementInfra: rawConfig.settlementInfra as SettlementInfraConfig | undefined,` to the `connectorConfig` object in `validateConfig()` (alongside existing pass-throughs at lines 200-207)

### 5. Export `SettlementInfraConfig` from `lib.ts` (AC: 5)

- [x] Add `SettlementInfraConfig` to the `export type { ... } from './config/types'` block in `lib.ts`

### 6. Verify compilation and existing tests (AC: 6)

- [x] Run `npm run build` — TypeScript compilation succeeds
- [x] Run `npm test` in connector package — all existing tests pass unchanged (1 pre-existing flaky perf test failure unrelated to changes)
- [x] Run `npm run lint` — no lint errors (2 pre-existing warnings only)
- [x] Verify `PeerConfig` has `evmAddress` field via TypeScript
- [x] Verify `ConnectorConfig` has `settlementInfra` field via TypeScript
- [x] Verify `SettlementInfraConfig` is exported from `lib.ts`

## File List

| File                                             | Action   | Description                                                                                                                        |
| ------------------------------------------------ | -------- | ---------------------------------------------------------------------------------------------------------------------------------- |
| `packages/connector/src/config/types.ts`         | Modified | Added `SettlementInfraConfig` interface (11 optional fields), `evmAddress` to `PeerConfig`, `settlementInfra` to `ConnectorConfig` |
| `packages/connector/src/config/config-loader.ts` | Modified | Added `SettlementInfraConfig` import and pass-through in `validateConfig()`                                                        |
| `packages/connector/src/lib.ts`                  | Modified | Added `SettlementInfraConfig` to type exports                                                                                      |

## Dev Agent Record

### Agent Model Used

Claude Opus 4.6

### Debug Log References

No debug issues encountered.

### Completion Notes

- All 6 tasks completed successfully — types-only story, no behavioral changes
- Build passes cleanly
- Lint passes (0 errors, 2 pre-existing warnings in `connector-node.test.ts`)
- Tests: 114 suites passed, 1 pre-existing flaky failure in `fraud-detection.test.ts` (p99 latency timing assertion — unrelated to this story's type additions)
- No test files modified, no new files created
- `connector-node.ts` was NOT modified (per story instructions)

## Change Log

| Date       | Version | Description                                                                                                      | Author                            |
| ---------- | ------- | ---------------------------------------------------------------------------------------------------------------- | --------------------------------- |
| 2026-02-14 | 1.0     | Initial story draft                                                                                              | Claude (create-next-story task)   |
| 2026-02-14 | 1.1     | Validation fixes: Task 3 insertion location, privateKey security JSDoc note, connector-node.ts exclusion callout | Claude (validate-next-story task) |

## QA Results

### Review Date: 2026-02-14

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation quality. This is a clean, minimal types-only story that adds 3 well-structured type modifications across 3 files. The changes follow existing codebase patterns precisely:

- **`SettlementInfraConfig`** interface (11 optional fields) placed correctly after `SettlementConfig` with comprehensive JSDoc including env-var mapping and security note on `privateKey`
- **`PeerConfig.evmAddress`** optional field added with clear JSDoc explaining it replaces the hardcoded `PEER{N}_EVM_ADDRESS` loop
- **`ConnectorConfig.settlementInfra`** field placed directly after `settlement` with JSDoc distinguishing the two config sections
- **`ConfigLoader`** pass-through follows the exact same `as Type | undefined` pattern used by all other optional fields (line 202)
- **`lib.ts`** export added alphabetically within the type export block

The `threshold` field being typed as `string` rather than `bigint` is a deliberate design choice well-documented in the JSDoc (YAML/JSON cannot represent BigInt natively). This matches the existing `BigInt(process.env.SETTLEMENT_THRESHOLD || '1000000')` pattern in `connector-node.ts`.

### Refactoring Performed

None required. The implementation is clean and follows existing patterns exactly.

### Compliance Check

- Coding Standards: ✓ TypeScript strict mode, PascalCase interfaces, JSDoc on all fields, no `any` types
- Project Structure: ✓ No new files, modifications to existing files only, kebab-case filenames
- Testing Strategy: ✓ Types-only change requires no new tests; existing 115 test suites (2381 tests) pass unchanged
- All ACs Met: ✓ All 6 acceptance criteria verified (see traceability below)

### AC Traceability

| AC  | Requirement                                      | Status | Evidence                                                              |
| --- | ------------------------------------------------ | ------ | --------------------------------------------------------------------- |
| 1   | `SettlementInfraConfig` interface with 11 fields | ✓      | `types.ts:633-703` — all 11 optional fields with JSDoc                |
| 2   | `PeerConfig` extended with `evmAddress`          | ✓      | `types.ts:85-90` — optional string field                              |
| 3   | `ConnectorConfig` gains `settlementInfra`        | ✓      | `types.ts:243-249` — after `settlement` field                         |
| 4   | `ConfigLoader.validateConfig()` pass-through     | ✓      | `config-loader.ts:27` (import), `config-loader.ts:202` (pass-through) |
| 5   | Exported from `lib.ts`                           | ✓      | `lib.ts:51` — in `export type` block                                  |
| 6   | Build + tests pass                               | ✓      | Build clean, 115/115 suites pass, lint 0 errors                       |

### Improvements Checklist

- [x] All 11 `SettlementInfraConfig` fields match env-var mapping table in story
- [x] Security note on `privateKey` field present ("Sensitive — do not log or serialize in plaintext.")
- [x] `connector-node.ts` was NOT modified (per story instructions)
- [x] No new files created, no test files modified
- [ ] Consider adding `SettlementInfraConfig` field validation in a future story (e.g., warn if `privateKey` is an Anvil dev key in production mode)
- [ ] Consider adding `evmAddress` format validation (0x-prefixed 40-hex-char) in a future story

### Security Review

No security concerns. The `privateKey` field includes an appropriate JSDoc security warning. The field is typed as optional `string` with no default value, preventing accidental exposure. No behavioral changes mean no new attack surface.

### Performance Considerations

No performance impact. Types-only changes are erased at compile time and have zero runtime cost.

### Files Modified During Review

None. No refactoring was needed.

### Gate Status

Gate: PASS -> docs/qa/gates/29.1-extend-connector-config-settlement-infra-types.yml
Risk profile: Low — types-only story, no behavioral changes, <100 lines diff
NFR assessment: All PASS

### Recommended Status

✓ Ready for Done
